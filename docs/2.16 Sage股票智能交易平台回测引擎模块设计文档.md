# Sage股票智能交易平台回测引擎模块设计文档

## 1. 模块定位
提供可复现的回测框架，支持周频调仓、中线持有，并与趋势/选股/风控模块对齐。

---

## 2. 关键假设（已确认）
- 调仓频率：周频
- 持有周期：2周～6个月
- 交易成本：固定千分之5（单边，含税费）
- 滑点模型：与成交额相关
- A股 T+1 卖出限制
- 数据延迟：财报/公告/北向 **T+2**
- 基准：沪深300

---

## 3. 输入 / 输出
**输入**：
- 信号序列（组合权重）
- 价格与复权数据

**输出**：
```json
{
  "metrics": {
    "annual_return": 0.12,
    "max_drawdown": -0.18,
    "sharpe": 1.1
  },
  "trades": [...],
  "equity_curve": [...]
}
```

**输出落地（建议）**：
- `data/backtest/metrics_<run_id>.json`
- `data/backtest/trades_<run_id>.parquet`
- `data/backtest/equity_<run_id>.parquet`

---

## 4. 核心功能
- Walk-forward / 滚动回测
- 交易成本与滑点
- 回撤/IC/IR/胜率/换手率
- 组合收益曲线输出

### 4.1 交易成本与滑点（示意）
```
cost = 0.0005 * traded_value  # 单边千分之5
slippage = f(成交额)          # 与成交额相关的可配置函数
```

### 4.1.1 默认滑点模型（平方根冲击）
```
ADV = rolling_mean(amount, 20日)
participation = trade_value / ADV
slippage_bps = half_spread_bps + k * participation^0.5
slippage_bps = min(slippage_bps, cap_bps)
```
**默认参数（可配置）**：
- `half_spread_bps = 5`
- `k = 20`
- `cap_bps = 50`

### 4.2 流程图（Mermaid）
```mermaid
flowchart LR
  A["信号序列"] --> B["撮合/成本/滑点"]
  B --> C["收益曲线"]
  C --> D["指标计算"]
```

---

## 5. 与现有代码映射
- `sage_core/backtest/walk_forward.py`
  （需要替换随机收益占位逻辑）

---

## Q&A
- Q: 是否需要支持分行业基准对比？
  A: 待确认。
