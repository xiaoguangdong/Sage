# Sage股票智能交易平台选股排序模型模块设计文档

## 1. 模块定位
在给定股票池内进行横截面排序，输出候选股票排名。

---

## 2. 模型方向
- 生产主线：`StockSelector(lgbm)`（单模型）
- 多策略治理：`Champion/Challenger`（线上唯一冠军 + 影子挑战者）
- `multi_alpha_selector.py` 拆分为四个挑战者策略：
  - `balance_strategy_v1`
  - `positive_strategy_v1`
  - `value_strategy_v1`
  - `satellite_strategy_v1`（卫星股高弹性倾向）
- 豆包硬指标均衡方案作为初始冠军：
  - `seed_balance_strategy`（兼容别名：`seed_banlance_strategy`）

---

## 3. 标签定义
- **多周期未来收益（20/60/120日）**
- **行业内 rank**
- 任务为**回归排序**（Learning to Rank）

## 3.1 特征清单（MVP v1）
来自 `RankModelLGBM.prepare_features()`：
- 动量类：`return_4d`, `return_12d`, `return_20d`
- 均线比：`ma_ratio_4d`, `ma_ratio_12d`, `ma_ratio_20d`
- 流动性：`turnover_4d_mean`, `turnover_4d_std`, `turnover_ratio_4d`
- 流动性：`turnover_12d_mean`, `turnover_12d_std`, `turnover_ratio_12d`
- 稳定性：`volatility_4d`, `volatility_12d`
- 价格波动：`price_std_4d`, `price_std_12d`
- 技术指标：`rsi_14`, `macd`, `macd_signal`, `bollinger_upper`, `bollinger_lower`

## 3.2 特征扩展（确认加入）
- 估值：`pe_ttm`, `pb`, `pe_percentile`, `pb_percentile`
- 质量：`roe`, `gross_margin`, `roic`
- 北向：`northbound_hold_ratio`, `northbound_net_flow`
- 行业动量：`industry_ret_4w`, `industry_ret_12w`

**完整计算规则详见**：`docs/2.21 Sage股票智能交易平台特征字典与计算规则.md`

## 3.3 生产特征预算（低复杂度约束）
生产特征控制在 **20~30 个**，按四类配额固定，避免“全量堆特征”：
- 质量（6~8）：`roe`, `roic`, `gross_margin`, `netprofit_yoy`, `debt_to_assets`, `ocf_to_profit`
- 动量（6~8）：`return_5d/20d/60d`, `industry_ret_20d`, `relative_strength_60d`, `ma_ratio_20/60`
- 资金（4~6）：`northbound_hold_ratio`, `northbound_net_flow_20d`, `turnover_ratio_20d`, `amount_ratio_20d`
- 风险（4~6）：`vol_20d`, `max_drawdown_60d`, `beta_120d`, `downside_vol_20d`, `liquidity_stability`

特征准入标准：
- 必须有明确经济解释；
- 必须满足时间可得性（防前视）；
- 必须通过样本外稳定性检查（IC方向与波动可控）。

## 3.4 数据时序与训练调仓节奏（强约束）
- 调仓：**周频**
- 重训：**月度**
- 标签：`20/60/120` 多周期并行
- 财务/公告类字段：严格使用 `ann_date`
- 统一延迟：`T+2` 生效
- 禁止未来函数：所有特征按 `trade_date` 截断，训练集和验证集时间严格分离

---

## 4. 输入 / 输出
**输入**：
- 股票池：沪深300（历史成分）
- 特征：动量/质量/流动性/风险等

**输出**：
```json
{
  "date": "2026-02-13",
  "ranked": [
    {
      "ts_code": "600519.SH",
      "score": 0.92,
      "rank": 1,
      "confidence": 0.83,
      "model_version": "seed_balance_strategy@v1.0.0"
    }
  ]
}
```

**输出落地（建议）**：
- `data/signals/stock_selector_signals_<YYYYMMDD>.parquet`
- 字段（统一契约）：`trade_date/ts_code/score/rank/confidence/model_version`

---

## 5. Champion/Challenger 运行机制
### 5.1 策略角色
- Champion：`seed_balance_strategy`（唯一线上执行策略）
- Challengers：
  - `balance_strategy_v1`
  - `positive_strategy_v1`
  - `value_strategy_v1`
  - `satellite_strategy_v1`

### 5.2 执行与影子
- 执行层仅读取 Champion 输出；
- Challengers 仅做影子运行，参与评估报表，不参与下单。

### 5.3 晋升门槛（建议）
挑战者仅在满足以下条件时可晋升：
- 连续样本外窗口优于 Champion（建议连续 3 个窗口）
- 同时满足：收益↑、最大回撤不恶化、夏普↑、换手可控、成本后收益↑
- 若只提升收益但回撤显著恶化，不晋升。

### 5.4 降级机制
- Champion 触发失效阈值（回撤/成本后收益）后
- 自动降级到 `baseline_conservative`
- 生成失效审计记录（阈值、时间、窗口、指标快照）

### 5.5 卫星策略打分（MVP）
- 策略ID：`satellite_strategy_v1`
- 目标：在影子层捕捉高弹性机会，不直接影响线上下单
- 当前评分（来自 `all_scores` 现有字段）：
  - `growth_score` * 0.35
  - `frontier_score` * 0.25
  - `rps_component` * 0.20
  - `elasticity_component` * 0.10
  - `not_priced_component` * 0.10
- 权重在 `config/app/strategy_governance.yaml` 的 `challenger_weights` 可配置。

---

## 6. 评估指标
- RankIC / IC
- TopK 命中率
- 回测收益与回撤
- 成本后收益、换手率、稳定性（滚动窗口）

---

## 7. 与现有代码映射
- `sage_core/stock_selection/rank_model.py`
- `scripts/strategy/multi_alpha_selector.py`（拆分为四个 Challenger）

---

## Q&A
- Q: 是否引入更多因子（宏观/情绪）？
  A: 先按 20~30 特征预算运行，新增因子必须通过“可解释+可得性+样本外稳定性”三重准入。
