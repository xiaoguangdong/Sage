# Sage股票智能交易平台选股排序模型模块设计文档

## 1. 模块定位
在给定股票池内进行横截面排序，输出候选股票排名。支持多种选股范式（机器学习排序、规则评分、混合模型），通过 Champion/Challenger 治理框架统一管理。

---

## 2. 选股器架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                  Champion/Challenger 治理层                   │
│              config/app/strategy_governance.yaml              │
│                                                              │
│  Champion: regime_ma_strategy (Sharpe 2.20, 回撤-8.4%)      │
│  Challengers: seed_balance / balance_v1 / positive_v1 /     │
│               value_v1 / satellite_v1                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
       ┌───────────────┼───────────────┐
       ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ RegimeStock  │ │ StockSelector│ │ MultiAlpha   │
│ Selector     │ │ (LightGBM)   │ │ Selector     │
│ (MoE专家)    │ │ (单模型)      │ │ (规则评分)    │
│              │ │              │ │              │
│ bull专家     │ │ 30特征预算    │ │ Value评分    │
│ neutral专家  │ │ IC筛选       │ │ Growth评分   │
│ bear专家     │ │ 行业中性化    │ │ Frontier评分 │
└──────┬───────┘ └──────────────┘ └──────────────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐
│ TrendModel   │     │ HybridStock  │
│ (MA20/MA60   │     │ Selector     │
│  regime判断)  │     │ (硬规则+线性) │
└──────────────┘     │              │
                     │ 价值股选股器  │
                     │ 成长股选股器  │
                     └──────────────┘
```

### 2.1 四类选股器定位

| 选股器 | 代码路径 | 模型类型 | 适用场景 |
|--------|----------|----------|----------|
| `StockSelector` | `sage_core/stock_selection/stock_selector.py` | LightGBM (LTR) | 短线动量，周频调仓 |
| `RegimeStockSelector` | `sage_core/stock_selection/regime_stock_selector.py` | LightGBM × 3 (MoE) | 当前Champion，分市场状态专家 |
| `MultiAlphaStockSelector` | `sage_core/stock_selection/multi_alpha_selector.py` | 规则评分 (zscore加权) | Value/Growth/Frontier三维评分 |
| `HybridStockSelector` | `sage_core/stock_selection/hybrid_stock_selector.py` | 硬规则 + LinearRegression | 长周期价值/成长选股 |

---

## 3. 模型详细设计

### 3.1 RegimeStockSelector（当前Champion）

核心思想：牛市/震荡/熊市的因子规律不同，按 regime 分别训练独立专家模型。

**执行流程**：
```
指数数据 ──→ TrendModelRuleV2 ──→ regime(bull/neutral/bear)
                                        │
                                        ▼
股票数据 ──→ 特征计算 ──→ 对应regime专家模型 ──→ 评分排序
```

**Regime 判断**：MA20/MA60 均线交叉
- `RISK_ON (bull)`: MA20 > MA60，上升趋势
- `NEUTRAL`: MA20 ≈ MA60，震荡
- `RISK_OFF (bear)`: MA20 < MA60，下降趋势

**训练策略**：
- 硬分配（默认）：只用对应 regime 的数据训练
- 软分配（可选）：全量数据 + 软权重（同regime=1.0, 相邻=0.3, 对立=0.05）
- 时间衰减：半衰期500交易日（~2年）
- 最小样本量：200（不足时回退全量模型）

**LightGBM 参数**（来自 `strategy_governance.yaml`）：
```yaml
regime_ma_strategy:
  label_horizons: [10, 20]
  label_weights: [0.4, 0.6]
  risk_adjusted: true
  label_neutralized: true       # 行业中性化标签
  ic_filter_enabled: true       # IC筛选特征
  ic_threshold: 0.015
  exclude_bj: true              # 排除北交所
  exclude_st: true              # 排除ST
  lgbm_params:
    learning_rate: 0.02
    num_leaves: 31
    max_depth: 6
    min_data_in_leaf: 200
    feature_fraction: 0.6
    num_boost_round: 500
  regime_overrides:
    bear:
      min_data_in_leaf: 300     # 熊市更保守
      lambda_l2: 8.0
```

### 3.2 StockSelector（基础LightGBM选股器）

**生产特征清单**（30个，来自 `_infer_feature_cols`）：

| 类别 | 特征 | 说明 |
|------|------|------|
| 质量 | `roe`, `roic`, `gross_margin` | 盈利能力 |
| 质量 | `netprofit_yoy`, `debt_to_assets`, `ocf_to_profit` | 增长与安全 |
| 估值 | `pe_percentile`, `pb_percentile`, `mv_percentile` | 横截面百分位 |
| 流动性 | `turnover_rate_percentile`, `turnover_ratio_20d`, `amount_ratio_20d`, `volume_trend_20d` | 成交活跃度 |
| 动量 | `ret_5d`, `ret_10d`, `ret_20d`, `ret_60d` | 多周期收益 |
| 动量 | `excess_ret_20d`, `momentum_accel` | 超额与加速度 |
| 行业 | `industry_ret_20d`, `industry_ret_60d` | 行业动量 |
| 技术 | `ma_20_ratio`, `ma_60_ratio`, `ma_20_slope`, `rsi_14` | 均线与RSI |
| 资金 | `northbound_hold_ratio`, `northbound_net_flow_20d` | 北向资金 |
| 风险 | `vol_20d`, `downside_vol_20d`, `max_drawdown_60d` | 波动与回撤 |
| 风险 | `beta_120d`, `liquidity_stability` | 系统风险与流动性 |

**特征准入标准**：
- 必须有明确经济解释
- 必须满足时间可得性（防前视）
- 必须通过样本外稳定性检查（IC方向与波动可控）
- 泄漏检测：自动排除含 `label/future/target/fwd/next_` 的字段

**seed_balance_strategy 参数**（原Champion，现Challenger）：
```yaml
seed_balance_strategy:
  label_horizons: [5, 10, 20]
  label_weights: [0.2, 0.3, 0.5]
  label_neutralized: true
  lgbm_params:
    objective: lambdarank
    metric: ndcg
    num_leaves: 15
    max_depth: 4
    min_data_in_leaf: 500       # 更保守
    lambda_l2: 10.0
```

### 3.3 MultiAlphaStockSelector（规则评分）

三维评分体系，每维度用 zscore 标准化后加权：

**Value 评分**（权重：value 0.35 / quality 0.30 / low_vol 0.20 / stability 0.15）：
- value = -zscore(pe_ttm) - zscore(pb) + zscore(dv_ttm)
- quality = zscore(roe_dt) + zscore(ocfps) + zscore(grossprofit_margin)
- low_vol = -zscore(vol_60) - zscore(max_dd_120)
- stability = zscore(days_above_ma20_60) - zscore(down_vol_60)

**Growth 评分**（权重：growth 0.35 / accel 0.25 / rps 0.25 / elasticity 0.15）：
- growth = zscore(or_yoy) + zscore(profit_yoy)
- accel = zscore(profit_yoy_diff)
- rps = zscore(rps_120)
- elasticity = -zscore(total_mv)

**Frontier 评分**（权重：capex 0.30 / turnaround 0.25 / order 0.25 / not_priced 0.20）：
- capex = zscore(fixed_assets_diff | assets_yoy_diff)
- turnaround = zscore(roe_dt_diff) + zscore(grossprofit_margin_diff)
- order = zscore(ocf_yoy)
- not_priced = -zscore(rps_120)

**组合分配**（Regime动态）：
| Regime | Value | Growth | Frontier |
|--------|-------|--------|----------|
| bear | 0.6 | 0.2 | 0.2 |
| sideways | 0.4 | 0.3 | 0.3 |
| bull | 0.2 | 0.5 | 0.3 |

### 3.4 HybridStockSelector（硬规则 + 线性模型）

两层架构：硬规则过滤 → 线性模型评分。

**长线执行策略**（推荐）：
- 规则托底：先用硬规则过滤，保证财务质量底线
- 模型选优：对通过硬规则的股票做排序
- 回退机制：模型不可用或候选不足时，回退规则评分

**价值股选股器**：
- 硬规则：ROE > 10%, 负债率 < 70%, 连续分红 ≥ 3年, 非ST
- 行业分位数规则（申万L1）：高越好取前30%，低越好取后30%；行业样本<30回退全市场
- 特征（15个）：roe, roe_5y_avg, debt_ratio, interest_coverage, net_cash_ratio, goodwill_ratio, cash_profit_ratio, dedt_profit_ratio, opex_ratio_ttm, consecutive_dividend, dividend_yield, pe_relative, fund_holders, inst_holding_change, revenue_growth
- 标签：未来6个月收益率

**成长股选股器**：
- 硬规则：营收CAGR > 15%, 研发费用率 > 3%, 负债率 < 60%, 非ST
- 行业分位数规则（申万L1）：高越好取前30%，低越好取后30%；行业样本<30回退全市场
- 特征（13个）：revenue_cagr_3y, profit_cagr_3y, rd_ratio, gross_margin, gross_margin_trend, asset_turnover, roe, cash_profit_ratio, net_cash_ratio, opex_ratio_ttm, industry_rank, fund_holders, inst_holding_change
- 标签：未来6个月收益率

---

## 4. 标签定义

| 选股器 | 标签周期 | 标签类型 | 中性化 |
|--------|----------|----------|--------|
| RegimeStockSelector | 10/20日 | 风险调整收益 | 行业中性化 |
| StockSelector (seed) | 5/10/20日 | 风险调整收益 | 行业中性化 |
| MultiAlphaStockSelector | 无（规则评分） | — | — |
| HybridStockSelector | 120日（6个月） | 原始收益率 | 无 |

---

## 5. 数据时序与训练调仓节奏（强约束）

- 调仓：**周频**（短线）/ **季频**（长线）
- 重训：**月度**（LightGBM）/ **季度**（线性模型）
- 财务/公告类字段：严格使用 `ann_date`
- 统一延迟：`T+2` 生效
- 禁止未来函数：所有特征按 `trade_date` 截断，训练集和验证集时间严格分离

---

## 6. 输入 / 输出

**输入**：
- 股票池：沪深300（历史成分）
- 特征：动量/质量/流动性/风险/估值/资金等
- 指数数据：用于 regime 判断（RegimeStockSelector）

**输出**：
```json
{
  "date": "2026-02-13",
  "ranked": [
    {
      "ts_code": "600519.SH",
      "score": 0.92,
      "rank": 1,
      "confidence": 0.83,
      "model_version": "regime_ma_strategy@v1.0.0"
    }
  ]
}
```

**输出落地**：
- `data/signals/stock_selector_signals_<YYYYMMDD>.parquet`
- 字段（统一契约）：`trade_date/ts_code/score/rank/confidence/model_version`

---

## 7. Champion/Challenger 运行机制

### 7.1 策略角色（当前状态）

| 角色 | 策略ID | 选股器类型 | 状态 |
|------|--------|-----------|------|
| Champion | `regime_ma_strategy` | RegimeStockSelector | 线上执行 |
| Challenger | `seed_balance_strategy` | StockSelector | 影子运行 |
| Challenger | `balance_strategy_v1` | MultiAlpha(Value倾向) | 影子运行 |
| Challenger | `positive_strategy_v1` | MultiAlpha(Growth倾向) | 影子运行 |
| Challenger | `value_strategy_v1` | MultiAlpha(Value纯) | 影子运行 |
| Challenger | `satellite_strategy_v1` | MultiAlpha(高弹性) | 影子运行 |

### 7.2 执行与影子
- 执行层仅读取 Champion 输出
- Challengers 仅做影子运行，参与评估报表，不参与下单

### 7.3 晋升门槛
挑战者仅在满足以下全部条件时可晋升：
- 连续 3 个样本外窗口优于 Champion
- 收益↑、最大回撤不恶化（容差 2%）、夏普↑
- 换手率不超过 Champion 的 1.2 倍
- 成本后收益↑
- 数据质量 ≥ 95%

### 7.4 降级机制
- Champion 触发失效阈值（回撤/成本后收益）后
- 自动降级到 `baseline_conservative`
- 生成失效审计记录（阈值、时间、窗口、指标快照）

### 7.5 卫星策略打分
- 策略ID：`satellite_strategy_v1`
- 目标：在影子层捕捉高弹性机会
- 评分公式：
  - `growth_score` × 0.35
  - `frontier_score` × 0.25
  - `rps_component` × 0.20
  - `elasticity_component` × 0.10
  - `not_priced_component` × 0.10
- 权重在 `config/app/strategy_governance.yaml` 的 `challenger_weights` 可配置

---

## 8. 行业信号叠加

选股评分可叠加行业信号（来自 `strategy_governance.yaml` 的 `industry_signals` 配置）：

```
原始选股评分 ──→ 行业信号叠加 ──→ 最终评分
                    │
                    ├── policy_score (政策评分, 权重0.4)
                    ├── concept_bias (概念偏好, 权重0.3)
                    └── northbound_ratio (北向占比, 权重0.3)
```

叠加强度按 regime 动态调整：
| Regime | overlay | mainline | tilt |
|--------|---------|----------|------|
| bull | 0.25 | 0.50 | 0.08 |
| sideways | 0.20 | 0.35 | 0.05 |
| bear | 0.15 | 0.20 | 0.10 |

---

## 9. 评估指标
- RankIC / IC（特征级 + 模型级）
- TopK 命中率
- 回测收益与回撤
- 成本后收益、换手率、稳定性（滚动窗口）

---

## 10. 代码映射

| 模块 | 代码路径 |
|------|----------|
| 基础LightGBM选股器 | `sage_core/stock_selection/stock_selector.py` |
| 分Regime选股器 | `sage_core/stock_selection/regime_stock_selector.py` |
| 多Alpha规则选股器 | `sage_core/stock_selection/multi_alpha_selector.py` |
| 混合选股器（硬规则+线性） | `sage_core/stock_selection/hybrid_stock_selector.py` |
| 策略治理配置 | `config/app/strategy_governance.yaml` |
| 特征字典 | `docs/2.21 Sage股票智能交易平台特征字典与计算规则.md` |

---

---

## 11. 高 Alpha 因子扩展计划

当前特征池约 30 个，主要覆盖价量技术面 + 基础财务面。以下是高 Alpha 因子的扩展方案：

### 11.1 分析师预期因子（最强 Alpha 之一）

**数据源**：Tushare（积分要求 120，已满足）

| 因子 | 接口 | 计算方式 | 预期方向 |
|------|------|----------|----------|
| 盈利上调次数 | `forecast` | 统计最近 3 个月预告类型为"预增"/"略增"的次数 | 正向 |
| 预期修正幅度 | `forecast` | (最新预告中值 - 上次预告中值) / 上次预告中值 | 正向 |
| 超预期程度 | `express` + `forecast` | (快报净利润 - 预告中值) / 预告中值 | 正向 |
| 预期一致性 | `forecast` | 预告区间宽度（max - min）/ 中值，越小越好 | 负向 |

**实现优先级**：P0（立即下载数据并实现）

### 11.2 资金流因子细分（已有数据，可直接使用）

**数据源**：`data/tushare/moneyflow/`（482 只股票，已下载）

| 因子 | 计算方式 | 预期方向 |
|------|----------|----------|
| 大单净流入占比 | (buy_lg_amount - sell_lg_amount) / total_amount | 正向 |
| 主力资金持续流入天数 | 连续 N 天大单净流入 > 0 | 正向 |
| 散户/机构资金分化度 | corr(小单净流入, 大单净流入) 的负值 | 正向（分化时机构抢筹） |
| 特大单占比 | (buy_elg_amount + sell_elg_amount) / total_amount | 正向（机构活跃） |

**实现优先级**：P0（无需下载，直接实现）

### 11.3 北向资金细分（已有数据，可直接使用）

**数据源**：`data/tushare/hk_hold/`（已下载）

| 因子 | 计算方式 | 预期方向 |
|------|----------|----------|
| 配置型资金占比 | 持股占比变化 < 5% 的北向资金占比 | 正向（长期看好） |
| 交易型资金流入 | 持股占比波动 > 10% 且净流入 > 0 | 正向（短期催化） |
| 北向持仓集中度变化 | HHI 指数变化率 | 正向（集中度提升） |
| 北向持仓稳定性 | 持股占比标准差（60 日） | 负向（稳定持仓） |

**实现优先级**：P0（无需下载，直接实现）

### 11.4 融资融券因子（部分数据，需补充）

**数据源**：Tushare `margin`（汇总数据已有 2016-2019）+ `margin_detail`（个股明细需 2000 积分）

| 因子 | 数据要求 | 计算方式 | 预期方向 |
|------|----------|----------|----------|
| 融资余额变化率 | 汇总数据 | (当前融资余额 - 20 日前) / 20 日前 | 正向 |
| 融资净买入占比 | 汇总数据 | (融资买入 - 融资偿还) / 总成交额 | 正向 |
| 个股融资买入强度 | 个股明细（2000 积分） | 个股融资买入 / 流通市值 | 正向 |
| 融券做空压力 | 个股明细（2000 积分） | 融券余量 / 流通股本 | 负向 |

**实现优先级**：
- P1：融资余额变化率、融资净买入占比（用汇总数据，需补充 2020-2026）
- P2：个股融资融券（需 2000 积分，或用 moneyflow 大单数据近似）

### 11.5 因子处理优化（无需额外数据）

| 优化项 | 当前状态 | 目标 | 实现方式 |
|--------|----------|------|----------|
| 市值中性化 | 仅行业中性化 | 行业 + 市值双中性化 | 对每个因子做市值分组回归，取残差 |
| 因子正交化 | 无 | 消除风格共线性 | PCA 或施密特正交化 |
| 多 Horizon 标签融合 | 单一 10d/20d | 5d/10d/20d 加权 | 已在 regime_ma_strategy 中使用，可优化权重 |
| 模型融合 | 单一 LightGBM | LGBM + XGB ensemble | 等权或 IC 加权 |

**实现优先级**：P0（纯算法优化，无需额外数据）

### 11.6 组合构建优化（无需额外数据）

| 优化项 | 当前状态 | 目标 | 实现方式 |
|--------|----------|------|----------|
| IC 加权持仓 | Top N 等权 | 按 score 加权 | 仓位 = score / sum(score) |
| 换手率约束 | 无 | 单次换手 ≤ 30% | 保留上期持仓，只调整差异部分 |
| 行业暴露约束 | 单行业 ≤ 40% | 单行业 ≤ 30% | 更严格的行业分散 |

**实现优先级**：P1（需回测验证效果）

### 11.7 数据下载计划

| 数据 | 接口 | 积分要求 | 日期范围 | 预计耗时 | 优先级 |
|------|------|----------|----------|----------|----------|
| 业绩预告 | `forecast` | 120 | 2016-2026 | ~30 分钟 | P0 |
| 业绩快报 | `express` | 120 | 2016-2026 | ~30 分钟 | P0 |
| 融资融券补充 | `margin` | 120 | 2020-2026 | ~10 分钟 | P1 |
| 港股通每日统计 | `ggt_daily` | 300 | 2016-2026 | ~20 分钟 | P1 |
| 个股融资融券明细 | `margin_detail` | 2000 | 2016-2026 | ~2 小时 | P2 |
| 主营业务构成 | `fina_mainbz` | 2000 | 2016-2026 | ~1 小时 | P2 |

**总计**：P0+P1 约 1.5 小时，P2 约 3 小时（可选）

---

## Q&A
- Q: 是否引入更多因子（宏观/情绪）？
  A: 先按 20~30 特征预算运行，新增因子必须通过"可解释+可得性+样本外稳定性"三重准入。高 Alpha 因子扩展计划见第 11 章。

- Q: RegimeStockSelector 为什么替代了 seed_balance_strategy？
  A: Regime模型 Sharpe 2.20 > seed_balance，回撤-8.4%更优。分市场状态训练避免了单模型在不同行情下的过拟合。

- Q: HybridStockSelector 和 StockSelector 的区别？
  A: HybridStockSelector 面向长周期（季频调仓），用硬规则保证基本面安全 + 线性模型学习权重；StockSelector 面向短周期（周频调仓），用 LightGBM 捕捉非线性因子关系。

- Q: 6000 积分可以获取哪些高 Alpha 因子？
  A: 可获取所有 P0/P1/P2 数据（forecast/express/margin_detail/fina_mainbz 等），预计总下载时间约 4.5 小时。
