# Sage股票智能交易平台买卖点过滤模块设计文档

## 1. 模块定位
在排序候选股票中，进一步过滤不合适的**入场**时点。当前版本仅做“入场过滤”，
卖出由风控/组合再平衡负责。

**命名约定**
- 模块名：EntryModel
- 实现类：`EntryModelLR`
- 文件位置：`sage_core/execution/entry_model.py`

---

## 2. 输入 / 输出
**输入**：
- 排序候选股票（`ts_code` 列表）
- 单股历史行情（需 `close`、`turnover`；可选 `high`、`low`）
- 已持仓列表（用于放行）

**输出（当前实现）**：`entry_signal`（是否允许新买入）

**输出落地（建议）**：
- `data/signals/entry_model/entry_signal_<YYYYMMDD>.parquet`
- 字段：`trade_date/ts_code/entry_prob/entry_signal/above_ma/low_vol`

---

## 3. 规则基线
**入场过滤（当前实现）**：
- 规则1：价格 > MA（默认 MA20）
- 规则2：波动率低于阈值
- 规则3：模型预测概率 ≥ 阈值
- 三条同时满足，`entry_signal=1`

**卖出逻辑**：
- 不在 EntryModel 中实现
- 由风控（ATR/行业止损/冲击止损）与组合再平衡决定

### 3.1 特征清单（MVP v1）
- 价格位置：`price_ma{5,10,20,60}_ratio`，`price_std{5,10,20,60}_ratio`
- 成交量：`volume_ma{5,10,20}_ratio`，`volume_price_corr{5,10,20}`
- MACD：`macd`、`macd_signal`、`macd_hist`、`macd_signal_cross`
- K线形态：`is_doji`、`is_hammer`、`is_shooting_star`
- 波动率：`volatility_5d`、`volatility_10d`
- 趋势强度：`trend_strength_20`

### 3.2 流程图（Mermaid）
```mermaid
flowchart LR
  A["排序候选股"] --> B["规则/模型过滤"]
  B --> C["entry_signal（允许新买入）"]
```

---

## 4. 模型增强（可选）
- Logistic Regression 分类器（当前实现）
- 输出概率 `entry_prob` 作为置信度

---

## 5. 标签规则（训练）
- `horizon=10`：未来10日累计收益
- `return_threshold=0.05`：未来收益 ≥ 5%
- `max_drawdown=-0.03`：未来最大回撤 ≥ -3%
- 两个条件同时满足才记为正样本

---

## 6. 运行时行为
- 未训练：全部放行（避免误杀）
- 历史不足（<30日）：放行
- 异常：放行并记录日志
- 已持仓：默认放行

---

## 7. 与现有代码映射
- `sage_core/execution/entry_model.py`

---

## Q&A
- Q: 是否启用止盈规则？
  A: 要有可配置，多套规则，多个止盈幅度
