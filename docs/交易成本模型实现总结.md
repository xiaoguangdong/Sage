# 交易成本模型实现总结

## 📊 实现内容

### 1. 完整的交易成本模型 (`sage_core/backtest/cost_model.py`)

包含三种成本：
- **固定成本**：佣金（万三）+ 印花税（千一，卖出） + 过户费
- **滑点成本**：固定滑点（1bp） + 波动率滑点（0.1×波动率）
- **市场冲击成本**：基于Almgren-Chriss模型，包含永久冲击和临时冲击

### 2. 成本模型配置

**默认模型**（适中估计）：
- 固定滑点：1bp
- 波动率滑点系数：0.1
- 市场冲击系数：0.05

**保守模型**（较高成本）：
- 固定滑点：2bp
- 波动率滑点系数：0.5
- 市场冲击系数：0.1

**激进模型**（乐观估计）：
- 固定滑点：1bp
- 波动率滑点系数：0.3
- 市场冲击系数：0.05

### 3. 集成到回测引擎

`SimpleBacktestEngine` 现在支持：
- `use_advanced_cost=True`：使用完整成本模型
- `use_advanced_cost=False`：使用简单成本率（向后兼容）

## 📈 测试结果

### 真实场景测试

**月度调仓**（换手率60%）：
- 简单模型成本：0.03%
- 完整模型成本：0.19%
- 成本差异：0.16%
- 年化收益差异：-39.44%

**周度调仓**（换手率40%）：
- 简单模型成本：0.02%
- 完整模型成本：0.13%
- 成本差异：0.11%
- 年化收益差异：-21.72%

### 成本构成分析

**高流动性低波动场景**（100万交易）：
- 固定成本：0.03%（买入）/ 0.13%（卖出）
- 滑点成本：0.21%
- 市场冲击：0.02%
- **双边总成本：0.63%**

**换手率影响**（1000万组合）：
- 10%换手 → 0.03%成本
- 50%换手 → 0.16%成本
- 100%换手 → 0.32%成本
- 159%换手 → 0.50%成本（每天完全换仓）

## 🎯 关键发现

1. **完整成本模型比简单模型高3-6倍**
   - 简单模型：0.05%单边
   - 完整模型：0.13-0.19%单边（取决于换手率）

2. **换手率是成本的关键驱动因素**
   - 月度调仓（60%换手）：年化成本约2.3%
   - 周度调仓（40%换手）：年化成本约6.6%
   - 日度调仓（159%换手）：年化成本约127%

3. **成本对策略收益影响巨大**
   - 月度调仓：成本导致收益下降39%
   - 周度调仓：成本导致收益下降22%

## 💡 使用建议

### 对于波段交易系统

**长周期策略**（持仓6月-2年）：
- 预期换手率：10-20%/年
- 使用完整成本模型
- 年化成本约0.3-0.6%

**短周期策略**（持仓1-4周）：
- 预期换手率：50-100%/年
- 使用完整成本模型
- 年化成本约1.6-3.2%

### 回测建议

1. **默认使用完整成本模型**，更接近真实交易
2. **降低换手率**是降低成本的最有效方法
3. **关注流动性**：避免交易低流动性股票
4. **考虑市场冲击**：大额交易需要分批执行

## 📁 相关文件

- `sage_core/backtest/cost_model.py` - 成本模型实现
- `sage_core/backtest/simple_engine.py` - 集成到回测引擎
- `scripts/backtest/test_cost_model.py` - 单元测试
- `scripts/backtest/compare_cost_models.py` - 模型对比
- `scripts/backtest/analyze_cost_breakdown.py` - 成本分析
- `scripts/backtest/test_realistic_cost.py` - 真实场景测试

## ✅ 完成状态

- [x] 实现完整的交易成本模型
- [x] 集成到回测引擎
- [x] 创建多种成本配置
- [x] 编写测试脚本
- [x] 验证真实场景
- [x] 成本构成分析

## 🔜 后续优化

1. 根据实际交易数据校准成本参数
2. 添加分批交易逻辑（降低市场冲击）
3. 考虑涨跌停板对成本的影响
4. 添加流动性过滤器（避免低流动性股票）
