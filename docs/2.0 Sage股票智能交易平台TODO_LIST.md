# Sage股票智能交易平台 TODO LIST

> 本TODO基于**现有代码与最终设计**整理，先给出"已实现/部分/未实现"清单，再列出待办。
>
> **目标**：工程上高质量 + 功能上高收益低回撤

## 0. 现状清单（基于当前仓库）
### 已实现（雏形/基础）
- 宏观/北向/NBS 数据拉取脚本：`scripts/data/macro/*`
- 趋势/排序/买卖点模型雏形：`sage_core/trend/*`、`sage_core/stock_selection/*`、`sage_core/execution/*`
- 主线与行业轮动原型脚本：`scripts/strategy/mainline_logic_system*.py`
- Walk-forward 回测框架（收益计算已接入真实价格）
- 政策信号管道雏形（政府站点抓取+规则打分）：`scripts/data/policy/*`

### 部分实现（有代码但未闭环）
- 数据源适配器：仅 Tushare/Baostock（NBS/Eastmoney/Akshare 未接入）
- 宏观模型：MacroPredictor/IndustryClassifier/CycleDetector 已有，但未对齐行业映射与T+2
- 趋势模型：规则版存在，但缺置信度/仓位与bug修复
- 排序/买卖点：模型有，未完成端到端训练与融合
- 政策信号：政府来源已接入且与东方财富行业研报合流，置信度/去重/来源稳定性已落地（仍需持续调优）

### 未实现（按设计必做）
- 统一字段规范（`ts_code`/`trade_date`）
- 信号契约与输出落地
- 交易成本/滑点/T+1/T+2 在回测中落地
- 异步任务调度（APScheduler）与推送落地

---

## P0 代码健康与数据规范（立即）
- [x] 统一股票代码字段（`ts_code`/`code`/`stock`）与日期字段（`trade_date`/`date`）
- [x] 修复 `run_weekly.py` 与 `DataLoader.load_all_baostock_data()` 接口不匹配
- [x] 修复 `features/price_features.py`、`features/market_features.py` 的语法/API问题
- [x] 修复 `trend_model.py`（`ma_medium` 赋值）与 `trend_model_enhanced.py` 的逻辑问题
- [x] 回测中移除随机收益占位，接入真实收益计算
- [x] 建立数据质量检查脚本与报告模板
- [x] 统一日志规范：`logs/<module>/<YYYYMMDD>_<NNN>.log`
- [x] 新增“防数据泄露检查”（标签列/未来信息过滤）
- [x] Tushare 默认数据根统一为 `data/tushare/`（兼容回退 `data/raw/tushare/` 只读）
- [x] 配置分层收敛：应用配置统一到 `config/app/`
- [x] 统一任务编排入口：`scripts/run_job.py`
- [x] `sage_core` 解除对 `scripts/*` 运行时路径的直接依赖

### 数据源适配器（细分）
- [x] Tushare/Baostock 接口存在（`sage_app/data/data_provider.py`）
- [x] NBS/Tushare 宏观脚本存在（`scripts/data/macro/*`）
- [x] Eastmoney 行业研报接入（政策行业模块）
- [ ] Eastmoney 其他数据源接入（如财报/事件，待评估）
- [ ] Akshare 接入
- [x] 统一下载入口重构：合并分散脚本到 `scripts/data/tushare_downloader.py`，避免重复脚本
- [x] 完成统一入口后移除 `scripts/data/tushare_suite.py` 旧入口
- [ ] Tushare 批量历史补数脚本（支持按任务批量回补，当前 `2020-2026` 可平滑扩展未来 `2~3` 年）

---

## P1 核心研究链路（短期）
### 宏观模型对齐
- [x] MacroPredictor/IndustryClassifier/CycleDetector 代码存在
- [x] 对齐 NBS → 申万映射（口径统一）
- [x] 行业口径统一（industry/sw_industry/industry_name）
- [x] 输出行业覆盖率审计报告（缺失行业清单）
- [x] 生成申万一级行业聚合特征（industry_features_sw_l1）
- [x] 行业景气度：个股信号聚合到申万一级
- [x] 北向行业配置比例落地（industry_northbound_flow）
- [x] T+2 延迟落地
- [x] 三大宏观信号导出到 `data/signals/`

### 趋势状态模型
- [x] 规则模型雏形存在
- [ ] 修复 bug
- [ ] 增加 `confidence/position_suggestion`
- [ ] 输出落地

### 主线与行业轮动
- [x] 主线脚本存在
- [x] 与信号融合对接（`industry_score_snapshot` + `industry_signal_snapshot` 已接入执行层overlay）
- [x] 行业信号新鲜度与覆盖治理（`northbound_ratio` 覆盖与滞后已修复，补齐代理延展与周度巡检）
- [x] P0：分状态行业叠加落地到周流程（`bull/sideways/bear` 支持 `signal_weights + industry_tilts`）
- [x] P0：牛市概念权重网格与硬门槛筛选（`optimize_bull_concept_weight.py`）
- [x] P0：景气评分分状态IC诊断（`diagnose_prosperity_ic_by_state.py`）

#### 主线模型V2（基于豆包方案）拆解
- [ ] V2-总项：门控 + 四维评分 + 动态权重 + A/B回测 + 监控全链路落地
- [ ] V2-0 数据源分层与可用性注册表（免费必备/可选付费/降级策略）
- [ ] V2-1 牛市土壤门控（趋势结构+市场广度+流动性+盈利预期代理）
- [ ] V2-2 四维主线评分引擎（产业/资金/业绩/结构）与行业Top2输出
- [ ] V2-3 四维子指标落地（政策强度、北向与成交、业绩上修代理、结构扩散/Hurst）
- [ ] V2-4 动态权重（IC/IR滚动12M）与静态权重回退
- [ ] V2-5 V2信号契约输出（`mainline_v2_score`, `mainline_v2_topn`, `mainline_v2_diag`）
- [ ] V2-6 A/B回测（V1对比V2，基准沪深300，周频，T+1/T+2约束）
- [ ] V2-7 风险约束联动（行业上限40%、拥挤度降温、趋势门控降仓）
- [ ] V2-8 监控与复盘（维度贡献、行业命中率、漂移告警）

#### 主线模型V2工作量评估（用于排期）
- [ ] 方案与数据对齐：2~3人日
- [ ] 指标与评分引擎开发：6~8人日
- [ ] 动态权重与信号输出：3~4人日
- [ ] 回测评估与参数定稿：4~6人日
- [ ] 监控与文档完善：2~3人日
- [ ] 合计：17~24人日（约3~5周，按单人并行度）

### 选股排序 + 买卖点
- [x] 排序模型/买卖点模型存在
- [ ] LGBM vs XGBoost 对比训练
- [ ] 与规则选股对照
- [ ] 与融合层闭环
- [x] Champion/Challenger 治理核心引擎落地（线上唯一冠军 + 影子挑战者）
- [x] 策略命名与注册：`seed_balance_strategy` / `balance_strategy_v1` / `positive_strategy_v1` / `value_strategy_v1` / `satellite_strategy_v1`
- [x] `multi_alpha_selector.py` 结果拆分为四个 Challenger 并统一输出契约（新增 `satellite_strategy_v1`）
- [x] 执行层治理接口仅读取 `active_champion_id`（在治理引擎层实现）
- [x] 选股统一信号契约（`stock_signal_contract.parquet`）落地
- [x] 执行层组合构建改为只消费统一契约，并接入行业契约叠加（`execution_signals_<date>.parquet`）
- [ ] 手动切换 Champion 配置（`effective_date` + `reason`）与审计日志
- [ ] 晋升门槛与自动降级（回退 `baseline_conservative`）实现与回测验证

### 信号契约
- [x] 统一 Signal Schema（趋势/主线行业/选股）并输出统一契约 `data/signals/contracts/unified_signal_contract_<trade_date>.parquet`
- [ ] `data/signals/` 输出落地
- [x] 行业信号统一契约落地（`industry_signal_contract.parquet`）
- [x] 选股信号统一契约落地（`stock_signal_contract.parquet`）
- [x] 行业/主线/选股信号字段收敛与版本化（`signal_name/source/model_version/confidence` 统一口径）

### LLM 模块
- [ ] 政策/产业/概念 LLM 模块设计与数据管道（细节后定，只做加权/过滤）

### 分 Regime 训练（优先级低，长期）
- [x] 按市场状态分模型训练（RegimeStockSelector，软分配 MoE）
  | Regime | 模型 |
  |--------|------|
  | 牛市 | Growth 模型 |
  | 熊市 | Value 模型 |
  | 震荡 | Neutral 模型 |
- [x] 推理时用趋势模型判断 Regime 选择模型
- [x] 标签周期优化（120d → 10/20d，对齐调仓频率）
- [x] Early Stopping 修复（独立验证集）
- [x] Walk-Forward 评估框架（Purging + Embargo + 分组回测）
- [x] IC 稳定性过滤（hit_rate ≥ 55%）
- [x] Regime 软分配（样本权重：目标1.0/相邻0.3/对立0.05）
- [x] 回测验证（2024-09 ~ 2026-01）：单一模型+68%, Regime+49%, 沪深300+45%
- [x] 时间衰减样本加权（指数衰减，半衰期~2年）
- [x] 硬分配训练（每个专家模型只用对应regime数据，区间二Regime +102%）
- [x] 固定 random_state (seed=42) 保证 Regime 模型可复现性
- [x] 补充股票名称映射（从 ths_member.parquet 读取，替代不存在的 stock_basic.parquet）

### 政策/产业/概念信号模块
- [x] 政府站点抓取（发改委/工信部/国务院/商务部/生态环境部/科技部/证监会/央行/财政部/国资委主站）
- [x] 规则版行业关键词映射 + 基础情绪分数
- [x] 输出 `policy_signals.parquet` 与摘要
- [x] 政策信号回测脚本雏形（行业级→股票池）
- [ ] Tushare 公告接入（暂缓；当前不接，待权限开通后再接）
- [ ] Tushare 研报接口（暂缓；当前不接，待权限/成本条件满足后再接）
- [x] 接入东方财富行业研报并合流
- [x] 输出增强信号（研报热度 + 行业动量）
- [x] 置信度输出（来源权重 + 关键词强度 + 频次）
- [x] 去重策略（同标题/同日/同源重复）
- [x] 行业映射覆盖率统计与修补（东方财富研报 → 申万L1）
- [ ] 研报“头部券商缺失”偏差说明与校准方案
- [x] 来源稳定性增强（source_health + 稳定性加权）
- [x] 国资委主站稳定入口替换移动版

### 概念/板块数据
- [x] 同花顺板块指数接口接入（ths_index / ths_daily）
- [x] 概念热度因子（基于 ths_daily）落地
- [x] ths_daily 按月全量拉取与完整性校验（按月批次 + 断点续传）
- [x] 概念热度接入主线评分正式链路（`industry_concept_bias.parquet` + Mainline优先读取）
- [x] 概念→行业映射覆盖率从 0.8439 提升至 ≥ 0.95（当前 0.9881，保留 high_conf=0.8439）

---

## P2 回测与评估（中期）
- [ ] Walk-forward/滚动回测一体化
- [ ] 交易成本/滑点/复权框架（已确认默认滑点）
- [x] T+1 卖出限制 & T+2 数据延迟入回测
- [ ] 评价指标：年化/回撤/IC/IR/胜率/换手率
- [x] 行业回测评估体系补齐（行业命中率、行业超额、行业回撤贡献、换手与成本后收益）脚本：`scripts/strategy/evaluate_industry_backtest.py`

---

## P3 监控与报告（中期）
- [x] 监控模块V1设计文档（覆盖数据/任务/信号/治理/风控/执行预留）
- [ ] 监控模块实现（暂缓；当前仅保留V1设计，后续统一开发）
- [ ] 数据缺失/异常监控
- [ ] 数据完整性巡检（国债收益率2Y/10Y、PMI等）
- [ ] 日报/周报模板
- [ ] 回测报告输出（markdown + csv）
- [x] 异步任务模块：趋势信号定时导出（APScheduler）
- [x] 异步任务模块：选股月度重训 + 周度信号导出（APScheduler）
- [ ] 异步任务模块：定时入库、推送与告警（APScheduler）
- [ ] 监控模块V1统一入口（`scripts/monitoring/run_monitoring.py`）
- [ ] 监控规则配置化（`config/monitoring/monitoring_rules.yaml`）
- [ ] 统一监控结果契约（PASS/WARN/FAIL + severity + metrics + thresholds）
- [ ] 数据监控纳管（macro/northbound/concepts/industry signals 核心数据集）
- [ ] 任务监控纳管（下载/特征/信号/周流程任务状态与耗时）
- [ ] 信号监控纳管（覆盖率/新鲜度/有效置信度/冲突率）
- [ ] 治理与风控监控纳管（Champion决策完整性、组合约束越界）
- [ ] 监控汇总日报与周报（`reports/monitoring/`）
- [ ] 告警通道预留（短信/webhook，先不启用）

---

## P4 重构与扩展（长期）
- [ ] 模块插件化（策略/模型可替换）
- [x] 预留实盘接口入口（平安证券 dry-run stub）
- [x] 订单生命周期状态机契约（NEW/ACK/PARTIAL/FILLED/CANCEL/REJECT）
- [ ] 平安证券实盘下单闭环（鉴权/下单/撤单/回报/持仓对账）
- [ ] 执行审计产物（orders/fills/reconcile）标准化落盘
- [ ] LLM/NLP模块接入（政策/产业/概念信号，输出结构化标签）
- [ ] LSTM 板块超额收益预测（研究型、非主链路）
- [ ] K-means 领涨板块自动识别（研究型、非主链路）
- [ ] LLM 政策语义分析增强（需规则版稳定后接入）

---

## Q&A
- Q: 是否保留/迁移 `ml_stock_forecast` 作为旧版基线？
  A: 已拆分为 `sage_core/`（核心）与 `sage_app/`（非核心管线），历史说明移至 `docs/legacy/ml_stock_forecast/`。
- Q: 低频调仓目标是"周/双周/月"？
  A: 周频调仓（已确认）。

---

# 工程质量与高收益体系补充（2026-02 新增）

> 基于代码审计与量化专家视角，补充以下高质量TODO项

---

## P0-工程 立即修复（影响正确性）

### 回测引擎修复
- [ ] 未来函数检查：建立数据快照机制，确保回测时序严格隔离
- [ ] `walk_forward.py` 收益计算添加显式时间戳校验（禁止使用未来数据）
- [ ] 添加停牌股票处理逻辑（标记为不可交易，收益置0）
- [ ] 添加涨跌停处理（涨停不可买入，跌停不可卖出）
- [ ] 回测结果添加数据完整性断言（确保无数据泄露）

### 交易成本模型升级
- [ ] 实现滑点模型（固定滑点 + 波动率滑点）
- [ ] 实现买卖价差成本（基于日内数据或固定比例）
- [ ] 实现市场冲击成本模型（Almgren-Chriss简化版）
- [ ] 成本模型参数配置化（`config/app/backtest_costs.yaml`）
- [ ] 添加成本敏感性分析报告

### 测试覆盖
- [ ] `sage_app/` 模块测试补充（当前仅 `sage_core/tests/`）
- [ ] 回测引擎端到端测试（模拟完整周期）
- [ ] 因子计算单元测试（每个因子独立验证）
- [ ] 添加 CI 自动化测试（GitHub Actions 或本地脚本）

---

## P0-风控 核心风控补齐（控制回撤）

### 止损体系完善
- [ ] 实现个股ATR动态止损（替代固定百分比）
- [ ] 实现行业层面止损（行业整体回撤超阈值 → 行业清仓）
- [ ] 实现组合层面止损（回撤分档降仓）
  ```
  -10%: 仓位降至80%
  -12%: 仓位降至60%
  -15%: 仓位降至30%
  ```
- [ ] 实现单日冲击止损（单日跌幅超3%触发降仓）
- [ ] 止损事件日志与报告（记录每次触发原因与执行情况）

### 仓位管理系统
- [x] 仓位管理方案对比分析文档（三来源：回测/设计文档/豆包方案，见 docs/2.15 第6节）
- [ ] P0：接入 confidence 动态仓位（趋势模型已输出 confidence，回测未接入；公式 `pos = base + (max-base) × confidence`）
- [ ] P0：个股追踪止损 + 组合层回撤降仓（当前完全无止损，最大回撤 -13%~-51% 无保护）
- [ ] 实现波动率目标仓位法（target_vol / estimated_vol）
- [ ] 实现趋势状态→仓位上限映射（已有配置，需接入回测与实盘）
- [ ] 实现预测加权个股分配（利用模型打分替代等权）
- [ ] 实现因子IC状态动态调仓（IC衰减时降仓）
- [ ] 仓位调整平滑机制（避免单日大幅变动）

### 行业暴露控制
- [ ] 实现行业暴露超限调整算法（当前 `risk_control.py:329` TODO）
- [ ] 添加行业集中度上限（单行业 ≤ 30%）
- [ ] 添加行业相关性检查（避免高相关行业过度暴露）

### 相关性风控
- [ ] 实现组合内股票相关性检查（|corr| < 0.6）
- [ ] 建立股票相关性矩阵定期更新机制
- [ ] 相关性超限时的替代选股逻辑

---

## P1-因子 因子体系升级（提升Alpha）

### 因子广度拓展
- [ ] 分析师预期因子
  - [ ] 盈利预测修正因子（EPS修正方向与幅度）
  - [ ] 评级变化因子（评级上调/下调）
  - [ ] 一致预期偏离因子（实际 vs 预期）
- [ ] 机构行为因子
  - [ ] 北向资金细分（配置型 vs 交易型识别）
  - [ ] 公募持仓变动因子（季报持仓变化）
  - [ ] 融资融券因子（融资余额变化）
  - [ ] 大宗交易因子（折价率、成交量）
- [ ] 另类数据因子（评估后选做）
  - [ ] 舆情情感因子（新闻情感分析）
  - [ ] 供应链关系因子

### 因子处理优化
- [ ] 实现因子正交化（消除风格共线性）
- [ ] 实现市值中性化（当前仅有行业中性化）
- [ ] 实现因子衰减分析（不同horizon的IC衰减曲线）
- [ ] 实现因子拥挤度监控（因子收益率趋势）

### 因子监控体系
- [ ] 建立因子IC日报（每日计算并记录）
- [ ] 建立因子IC滚动统计（5日/20日/60日均值）
- [ ] 建立因子衰减预警（IC连续5日低于阈值触发告警）
- [ ] 建立因子贡献归因（每期各因子对收益的贡献）

---

## P1-模型 模型能力补齐

### 趋势模型实现
- [ ] 实现 `TrendModelLGBM`（当前仅有 `pass` 占位）
- [ ] 实现 `TrendModelHMM`（隐马尔可夫状态识别）
- [ ] 趋势模型特征工程
  - [ ] 市场广度指标（上涨家数/下跌家数）
  - [ ] 创新高比例
  - [ ] 成交量趋势
  - [ ] 波动率状态转换

### 选股模型增强
- [x] 分Regime训练框架（牛市/熊市/震荡分别训练）
- [x] Walk-Forward评估框架（IC/IC_IR/分组回测）
- [ ] 模型集成（LGBM + XGB + NN Stacking）
- [x] 特征重要性稳定性监控（IC hit_rate过滤）
- [ ] 超参数自动搜索（Optuna或网格搜索）

### 多策略融合
- [ ] 建立多策略框架（动量/价值/质量/低波动）
- [ ] 实现策略权重动态分配（基于近期IC表现）
- [ ] 实现策略相关性控制（避免策略同质化）
- [ ] 策略层面回测与归因

---

## P2-归因 归因分析体系

### 收益归因
- [ ] 实现Brinson归因（配置效应 + 选股效应 + 交互效应）
- [ ] 实现因子收益归因（各风险因子贡献）
- [ ] 实现择时/选股收益分解

### 风险归因
- [ ] 实现风险模型（BARRA风格）
  - [ ] SIZE / BETA / MOMENTUM / VALUE / VOLATILITY / LIQUIDITY / QUALITY
  - [ ] 行业因子暴露
- [ ] 组合风险分解（系统性风险 vs 特质风险）

### 报告体系
- [ ] 周度自动报告生成
  - [ ] 绩效概览（收益/回撤/夏普）
  - [ ] 归因分析
  - [ ] 因子健康度
  - [ ] 持仓分析
- [ ] 月度深度报告
  - [ ] 策略表现对比
  - [ ] 风险分析
  - [ ] 市场环境回顾

---

## P2-执行 执行系统升级

### 订单执行优化
- [ ] 实现TWAP执行算法（时间加权平均价格）
- [ ] 实现VWAP执行算法（成交量加权平均价格）
- [ ] 实现智能拆单（大单分批执行）
- [ ] 盘口深度考虑（流动性约束）

### 券商适配增强
- [ ] 完善平安证券实盘闭环
  - [ ] 鉴权流程
  - [ ] 下单/撤单
  - [ ] 回报处理
  - [ ] 持仓对账
- [ ] 预留多券商接口（华泰/中信等）
- [ ] 失败重试机制
- [ ] 交易状态追踪看板

---

## P2-数据 数据治理升级

### 数据质量
- [ ] 复权价格校验脚本（前后复权一致性）
- [ ] 异常值自动清洗（3σ原则 + 业务规则）
- [ ] 数据完整性检查（断点检测与补数）
- [ ] 数据新鲜度监控（最后更新时间）

### 数据源扩展
- [ ] Eastmoney财报数据接入
- [ ] Eastmoney事件数据接入
- [ ] Akshare数据源接入评估
- [ ] 多源数据交叉验证机制

### 数据架构
- [ ] 建立特征库（标准化因子存储）
- [ ] 建立标签库（多horizon标签）
- [ ] 建立回测缓存（避免重复计算）
- [ ] 数据版本管理（支持回溯）

---

## P3-工程 工程质量提升

### 代码规范
- [ ] 添加类型注解（mypy静态检查）
- [ ] 统一代码风格（black + isort）
- [ ] 添加pre-commit hooks
- [ ] 移除 `scripts/legacy/` 历史代码

### 依赖管理
- [ ] 迁移到 `pyproject.toml`
- [ ] 添加版本锁定（`requirements-lock.txt`）
- [ ] 清理多余虚拟环境（保留单一开发环境）

### 日志与监控
- [ ] 结构化日志（JSON格式）
- [ ] 日志聚合（集中到单一目录结构）
- [ ] 关键指标监控仪表盘（Grafana或自建）

### 容器化
- [ ] 添加 Dockerfile
- [ ] 添加 docker-compose.yml（开发环境）
- [ ] 环境变量管理（.env.example 完善）

---

## P3-治理 持续迭代机制

### Champion-Challenger框架完善
- [ ] 自动化Challenger评估流程
- [ ] 晋升门槛量化定义（IC/IR/回撤综合评分）
- [ ] 自动降级机制（连续N期表现不佳触发）
- [ ] 切换审计日志

### A/B测试机制
- [ ] 建立策略A/B测试框架
- [ ] 统计显著性检验（t-test）
- [ ] 实盘小资金灰度测试流程

### 文档体系
- [ ] 因子字典文档（每个因子定义/计算方式/预期方向）
- [ ] 策略说明书（投资逻辑/风险点/适用环境）
- [ ] 运维手册（日常操作/故障处理）

---

## 优先级执行路线图

```
Week 1-2: P0-工程（回测正确性 + 成本模型 + 测试）
Week 3-4: P0-风控（止损体系 + 仓位管理）
Week 5-6: P1-因子（因子监控 + 关键因子补充）
Week 7-8: P1-模型（趋势模型实现 + 分Regime训练）
Week 9-10: P2-归因 + P2-执行
Week 11-12: P2-数据 + P3-工程
持续: P3-治理（文档、迭代机制）
```

---

## 关键指标目标

| 指标 | 当前状态 | 目标值 |
|------|----------|--------|
| 年化收益 | - | ≥ 15% |
| 最大回撤 | - | ≤ 10% |
| 夏普比率 | - | ≥ 1.5 |
| 卡玛比率 | - | ≥ 1.5 |
| 胜率 | - | ≥ 55% |
| 日均换手 | - | ≤ 5% |
| 测试覆盖率 | ~20% | ≥ 60% |
| 代码类型注解 | ~10% | ≥ 80% |
