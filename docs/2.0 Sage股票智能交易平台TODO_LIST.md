# Sage股票智能交易平台 TODO LIST

> **最后更新**：2026-02-21（高Alpha因子完整集成到选股器和回测引擎）
> **项目完成度**：约95%（18,800+行Python代码，新增8个核心模块/脚本）
> **目标**：工程上高质量 + 功能上高收益低回撤
> **下一步**：下载P1数据（forecast/express）或运行回测验证高Alpha因子效果

## 📊 实现状态总览

| 模块 | 完成度 | 状态 |
|------|--------|------|
| 核心选股系统 | 95% | ✅ 完整可用 |
| 趋势模型 | 90% | ✅ 规则版完整，HMM部分实现 |
| 组合管理 | 100% | ✅ 完整实现 |
| 执行系统 | 85% | ✅ 框架完整，EntryModel已实现，实盘未测试 |
| 回测系统 | 95% | ✅ Walk-Forward完整，成本模型完整+配置化，EntryModel集成完成 |
| 数据管道 | 75% | ⚠️ 基础完整，财务数据已补全，自动化不足 |
| 监控治理 | 65% | ⚠️ 基础完整，宏观模型已集成，告警缺失 |
| 文档 | 90% | ✅ 设计文档完整，长短周期系统设计完成，API文档缺失 |

## 0. 现状清单（基于2026-02-18全面扫描）

### ✅ 已完成（完整可用）
- **核心选股系统**：StockSelector/RegimeStockSelector/MultiAlphaStockSelector 完整实现
  - 30+因子特征工程、IC筛选防过拟合、分Regime训练
  - **回测结果**：Regime模型+80.69% vs 单一模型+61.60% vs 沪深300+44.88%
- **趋势模型**：TrendModelRuleV2 完整实现
  - 三层架构、状态机、熔断机制、波动率自适应、多时间框架确认
- **组合管理**：PortfolioManager + RiskControl 完整实现
  - 长线70%+短线30%、行业分散、流动性过滤、回撤控制
- **回测系统**：WalkForwardEvaluator 完整实现
  - Purge/Embargo防过拟合、分组回测、IC计算
- **交易成本模型**：TradingCostModel 完整实现
  - 固定成本（佣金+印花税+过户费）+ 滑点成本 + 市场冲击成本
  - 基于Almgren-Chriss模型，集成到SimpleBacktestEngine
  - **测试结果**：月度调仓成本2.3%，周度调仓成本6.6%
- **治理系统**：StrategyGovernance 完整实现
  - Champion/Challenger框架、自动晋升决策
  - **当前Champion**：regime_ma（Sharpe 2.20）
- **执行系统**：OrderLifecycle + BrokerAdapter + UnifiedSignalContract 框架完整
- **数据系统**：DataCatalog + Tushare下载 + 数据完整性检查
- **买卖点模型**：EntryModelLR 完整实现
  - Logistic回归，20+技术特征（均线偏离/量价/MACD/K线形态/波动率/趋势强度）
  - predict_batch 批量预测，已集成到 SimpleBacktestEngine
- **增强风控**：EnhancedRiskControl 完整实现
  - 5层风控：Confidence动态仓位、ATR止损、行业止损、分档降仓、冲击止损
  - 熊市最大回撤从-40%降至-13%，牛市回撤控制在-3.6%以内
- **长短周期并行交易系统**：设计文档完成（docs/2.16、docs/2.1）
  - 70%长线波段交易 + 30%短线动量交易（SeedBalance管理）
  - 长线：趋势驱动，持仓6月-2年，5只股票集中持仓
  - 短线：技术面/动量，持仓1-4周，10只股票分散持仓
- **长周期基本面特征**：LongTermFundamentalFeatures 已实现
  - 研发费用率、ROE 5年均值、营收/利润3年CAGR、利息保障倍数
- **混合选股器**：价值股选股器+成长股选股器（硬规则+线性模型）
  - 价值股+1.15%、成长股+6.70%超额收益
- **组合管理器**：整合长短线选股器、70/30资金分配、行业分散约束、风险控制
- **成本模型配置化**：`config/app/backtest_costs.yaml`，三套预设（default/conservative/aggressive）
- **代码规范整理**：pyproject.toml + pre-commit（black/isort/ruff）全部通过，62个lint错误已修复
- **Champion/Challenger回测修复**：预训练模式+P0回撤控制（-90%→-22%）
- **止损事件日志**：EnhancedRiskControl统一记录分档降仓/单日冲击/行业止损事件，BacktestResult含stop_loss_report
- **长周期选股器集成**：run_weekly.py支持70/30长短线整合，模型不存在时自动降级到短线
- **宏观模型集成**：MacroPredictor集成到run_weekly.py，行业倾斜（景气度→+5%/10%/15%）+仓位因子（系统衰退0.3/HIGH 0.6/MEDIUM 0.85/LOW 1.0）
- **XGBoost模型升级**：早停+时间序列验证集+样本权重，与LGBM功能对齐
- **LGBM vs XGBoost对比**：6窗口walk-forward验证，XGBoost 4/4维度胜出（超额0.43% vs 0.01%，胜率53.2% vs 46.5%）

### ⚠️ 部分实现（有代码但不完整）
- **特征系统**：FeaturePipeline框架完整，但高级特征未实现
  - SatelliteFeatures/FlowFeatures 仅占位符
  - LongTermFundamentalFeatures 已实现（研发费用率/ROE均值/CAGR/利息保障倍数）
- **行业分析**：IndustryBacktestEval 完整，但与选股集成不完整
  - CycleDetector/MacroPredictor 仅占位符
- **宏观模型**：MacroPredictor已集成到sage_core/，run_weekly.py接入行业倾斜+仓位因子，降级策略完备
- **监控系统**：数据质量检查完整，但缺乏实时仪表板和告警

### ❌ 未实现（需要开发）
- **自动化调度**：配置存在，但DAG调度逻辑不完整
- **因子体系**：缺乏分析师预期因子、机构行为因子、因子监控体系
- **归因分析**：缺乏Brinson归因、因子收益归因、风险模型

---

## 🔴 P0 优先级（立即处理）

### 1. 买卖点模型（关键缺失）✅
- [x] **EntryModel 实现**：EntryModelLR（Logistic回归）
  - [x] 买入点识别逻辑（20+技术特征：均线偏离/量价/MACD/K线形态/波动率/趋势强度）
  - [x] 卖出点识别逻辑（止盈/止损/趋势反转，由增强风控模块处理）
  - [x] 标签生成完整实现（未来N天收益≥5%且回撤≥-3%）
  - [x] 与选股模型集成（predict_batch集成到SimpleBacktestEngine）
  - [ ] 回测验证（待独立回测对比有/无EntryModel的效果）

### 2. 交易成本模型（回测准确性）✅
- [x] 单边成本率（已实现）
- [x] **滑点模型**：固定滑点 + 波动率滑点
- [x] **市场冲击成本**：Almgren-Chriss简化版
- [x] 成本模型集成到回测引擎（SimpleBacktestEngine）
- [x] 成本构成分析脚本（analyze_cost_breakdown.py）
- [x] 真实场景测试（月度/周度调仓）
- [x] 成本模型参数配置化（`config/app/backtest_costs.yaml`，支持default/conservative/aggressive三种预设）
- [ ] 买卖价差成本（基于日内数据或固定比例）

### 3. 风控体系补齐（控制回撤）✅
- [x] 基础止损/止盈（已实现）
- [x] **接入confidence动态仓位**：趋势模型已输出confidence，回测已接入
  - 公式：`pos = base + (max-base) × confidence`
- [x] **个股ATR动态止损**：替代固定百分比
- [x] **行业层面止损**：行业整体回撤超阈值 → 行业清仓
- [x] **组合层面分档降仓**：
  - -15%: 仓位降至50%
  - -25%: 清仓
- [x] **单日冲击止损**：单日跌幅超阈值触发降仓
- [x] 止损事件日志与报告（EnhancedRiskControl分档降仓/单日冲击事件记录，BacktestResult含stop_loss_report）

### 4. 概念数据获取问题（数据完整性）
- [ ] **问题**：Tushare IP限制，同花顺概念数据不完整
- [ ] **解决方案**：
  - [ ] 评估其他数据源（Akshare/Eastmoney）
  - [ ] 实现数据源降级策略
  - [ ] 建立概念数据缓存机制

### 5. 数据补充
- [x] 修改tushare_tasks.yaml年份范围（2016-2026）
- [x] 创建通用补充脚本（支持daily/monthly/single）
- [x] 补充2016-2019年财务数据（已完成，耗时51分钟，790,689条记录）
  - [x] fina_indicator_vip: 144,842条
  - [x] fina_mainbz_vip: 87,293条
  - [x] income: 191,736条
  - [x] balancesheet: 186,400条
  - [x] cashflow: 180,418条
- [ ] 补充2016-2019年日线数据（daily_basic、ths_daily等）
- [ ] 补充静态数据（northbound_hold、hs300_constituents等）
- [x] 运行 data_integrity_checker 并落地“检查→生成计划→补数→复查”闭环

---

## P0 代码健康与数据规范（已完成）
- [x] 统一股票代码字段（`ts_code`/`code`/`stock`）与日期字段（`trade_date`/`date`）
- [x] 修复 `run_weekly.py` 与 `DataLoader.load_all_baostock_data()` 接口不匹配
- [x] 修复 `features/price_features.py`、`features/market_features.py` 的语法/API问题
- [x] 修复 `trend_model.py`（`ma_medium` 赋值）与 `trend_model_enhanced.py` 的逻辑问题
- [x] 回测中移除随机收益占位，接入真实收益计算
- [x] 建立数据质量检查脚本与报告模板
- [x] 统一日志规范：`logs/<module>/<YYYYMMDD>_<NNN>.log`
- [x] 新增"防数据泄露检查"（标签列/未来信息过滤）
- [x] Tushare 默认数据根统一为 `data/tushare/`（兼容回退 `data/raw/tushare/` 只读）
- [x] 配置分层收敛：应用配置统一到 `config/app/`
- [x] 统一任务编排入口：`scripts/run_job.py`
- [x] `sage_core` 解除对 `scripts/*` 运行时路径的直接依赖

### 数据源适配器
- [x] Tushare/Baostock 接口存在（`sage_app/data/data_provider.py`）
- [x] NBS/Tushare 宏观脚本存在（`scripts/data/macro/*`）
- [x] Eastmoney 行业研报接入（政策行业模块）
- [ ] Eastmoney 其他数据源接入（如财报/事件，待评估）
- [ ] Akshare 接入
- [x] 统一下载入口重构：合并分散脚本到 `scripts/data/tushare_downloader.py`，避免重复脚本
- [x] 完成统一入口后移除 `scripts/data/tushare_suite.py` 旧入口
- [x] Tushare 批量历史补数脚本（`scripts/data/backfill_missing_data.py`）

---

## 🟡 P1 核心研究链路（短期）

### 宏观模型对齐
- [x] MacroPredictor/IndustryClassifier/CycleDetector 代码存在（但仅占位符）
- [x] 对齐 NBS → 申万映射（口径统一）
- [x] 行业口径统一（industry/sw_industry/industry_name）
- [x] 输出行业覆盖率审计报告（缺失行业清单）
- [x] 生成申万一级行业聚合特征（industry_features_sw_l1）
- [x] 行业景气度：个股信号聚合到申万一级
- [x] 北向行业配置比例落地（industry_northbound_flow）
- [x] T+2 延迟落地
- [x] 三大宏观信号导出到 `data/signals/`
- [x] **宏观模型集成到sage_core/**：run_weekly.py集成宏观预测（行业倾斜+仓位因子），降级策略完备
- [x] **实现MacroPredictor**：predict()输出系统场景/机会行业/风险等级，集成到周流程
- [ ] **实现CycleDetector**：当前仅占位符

### 趋势状态模型
- [x] **TrendModelRuleV2 完整实现**：三层架构、状态机、熔断机制、波动率自适应
- [x] 增加 `confidence/position_suggestion`
- [x] 输出落地
- [ ] **TrendModelLGBM 实现**：当前仅占位符
- [ ] **TrendModelHMM 优化**：已有框架，但实际使用较少

### 主线与行业轮动
- [x] 主线脚本存在
- [x] 与信号融合对接（`industry_score_snapshot` + `industry_signal_snapshot` 已接入执行层overlay）
- [x] 行业信号新鲜度与覆盖治理（`northbound_ratio` 覆盖与滞后已修复，补齐代理延展与周度巡检）
- [x] P0：分状态行业叠加落地到周流程（`bull/sideways/bear` 支持 `signal_weights + industry_tilts`）
- [x] P0：牛市概念权重网格与硬门槛筛选（`optimize_bull_concept_weight.py`）
- [x] P0：景气评分分状态IC诊断（`diagnose_prosperity_ic_by_state.py`）

#### 主线模型V2（基于豆包方案）拆解
- [ ] V2-总项：门控 + 四维评分 + 动态权重 + A/B回测 + 监控全链路落地
- [ ] V2-0 数据源分层与可用性注册表（免费必备/可选付费/降级策略）
- [ ] V2-1 牛市土壤门控（趋势结构+市场广度+流动性+盈利预期代理）
- [ ] V2-2 四维主线评分引擎（产业/资金/业绩/结构）与行业Top2输出
- [ ] V2-3 四维子指标落地（政策强度、北向与成交、业绩上修代理、结构扩散/Hurst）
- [ ] V2-4 动态权重（IC/IR滚动12M）与静态权重回退
- [ ] V2-5 V2信号契约输出（`mainline_v2_score`, `mainline_v2_topn`, `mainline_v2_diag`）
- [ ] V2-6 A/B回测（V1对比V2，基准沪深300，周频，T+1/T+2约束）
- [ ] V2-7 风险约束联动（行业上限40%、拥挤度降温、趋势门控降仓）
- [ ] V2-8 监控与复盘（维度贡献、行业命中率、漂移告警）
- **预计工作量**：17~24人日（约3~5周，按单人并行度）

### 选股排序 + 买卖点
- [x] **StockSelector 完整实现**：30+因子、IC筛选、三种模型
- [x] **RegimeStockSelector 完整实现**：分市场状态训练，Sharpe 2.20
- [x] **MultiAlphaStockSelector 完整实现**：多策略融合
- [x] LGBM vs XGBoost 对比训练（6窗口walk-forward完成，XGBoost 4/4维度胜出：超额0.43% vs 0.01%，胜率53.2% vs 46.5%）
- [ ] 与规则选股对照
- [ ] 与融合层闭环
- [x] Champion/Challenger 治理核心引擎落地（线上唯一冠军 + 影子挑战者）
- [x] 策略命名与注册：`seed_balance_strategy` / `balance_strategy_v1` / `positive_strategy_v1` / `value_strategy_v1` / `satellite_strategy_v1`
- [x] `multi_alpha_selector.py` 结果拆分为四个 Challenger 并统一输出契约（新增 `satellite_strategy_v1`）
- [x] 执行层治理接口仅读取 `active_champion_id`（在治理引擎层实现）
- [x] 选股统一信号契约（`stock_signal_contract.parquet`）落地
- [x] 执行层组合构建改为只消费统一契约，并接入行业契约叠加（`execution_signals_<date>.parquet`）
- [ ] 手动切换 Champion 配置（`effective_date` + `reason`）与审计日志
- [ ] 晋升门槛与自动降级（回退 `baseline_conservative`）实现与回测验证

### 信号契约
- [x] 统一 Signal Schema（趋势/主线行业/选股）并输出统一契约 `data/signals/contracts/unified_signal_contract_<trade_date>.parquet`
- [x] `data/signals/` 输出落地
- [x] 行业信号统一契约落地（`industry_signal_contract.parquet`）
- [x] 选股信号统一契约落地（`stock_signal_contract.parquet`）
- [x] 行业/主线/选股信号字段收敛与版本化（`signal_name/source/model_version/confidence` 统一口径）

### 分 Regime 训练（已完成）
- [x] 按市场状态分模型训练（RegimeStockSelector，软分配 MoE）
- [x] 推理时用趋势模型判断 Regime 选择模型
- [x] 标签周期优化（120d → 10/20d，对齐调仓频率）
- [x] Early Stopping 修复（独立验证集）
- [x] Walk-Forward 评估框架（Purging + Embargo + 分组回测）
- [x] IC 稳定性过滤（hit_rate ≥ 55%）
- [x] Regime 软分配（样本权重：目标1.0/相邻0.3/对立0.05）
- [x] 回测验证（2024-09 ~ 2026-01）：宏观标签后单一+61.60%, Regime+80.69%, 沪深300+44.88%
- [x] 时间衰减样本加权（指数衰减，半衰期~2年）
- [x] 硬分配训练（每个专家模型只用对应regime数据）
- [x] P6修复：predict_prepared全量预计算特征，消除score坍缩bug
- [x] 固定 random_state (seed=42) 保证 Regime 模型可复现性
- [x] 补充股票名称映射（从 ths_member.parquet 读取，替代不存在的 stock_basic.parquet）
- [x] 宏观Regime标签训练：训练用人工划分的宏观市场阶段（bull/bear/neutral），推理用趋势模型实时判断

### 政策/产业/概念信号模块
- [x] 政府站点抓取（发改委/工信部/国务院/商务部/生态环境部/科技部/证监会/央行/财政部/国资委主站）
- [x] 规则版行业关键词映射 + 基础情绪分数
- [x] 输出 `policy_signals.parquet` 与摘要
- [x] 政策信号回测脚本雏形（行业级→股票池）
- [ ] Tushare 公告接入（暂缓；当前不接，待权限开通后再接）
- [ ] Tushare 研报接口（暂缓；当前不接，待权限/成本条件满足后再接）
- [x] 接入东方财富行业研报并合流
- [x] 输出增强信号（研报热度 + 行业动量）
- [x] 置信度输出（来源权重 + 关键词强度 + 频次）
- [x] 去重策略（同标题/同日/同源重复）
- [x] 行业映射覆盖率统计与修补（东方财富研报 → 申万L1）
- [ ] 研报"头部券商缺失"偏差说明与校准方案
- [x] 来源稳定性增强（source_health + 稳定性加权）
- [x] 国资委主站稳定入口替换移动版

### 概念/板块数据
- [x] 同花顺板块指数接口接入（ths_index / ths_daily）
- [x] 概念热度因子（基于 ths_daily）落地
- [x] ths_daily 按月全量拉取与完整性校验（按月批次 + 断点续传）
- [x] 概念热度接入主线评分正式链路（`industry_concept_bias.parquet` + Mainline优先读取）
- [x] 概念→行业映射覆盖率从 0.8439 提升至 ≥ 0.95（当前 0.9881，保留 high_conf=0.8439）

### 因子体系升级（高 Alpha 因子扩展）

#### P0 因子（立即实施，无需/少量下载）✅
- [x] **资金流因子细分**（已有数据，可直接使用）✅
  - [x] 大单净流入占比：(buy_lg - sell_lg) / total_amount
  - [x] 主力资金持续流入天数：连续 N 天大单净流入 > 0
  - [x] 散户/机构资金分化度：corr(小单, 大单) 的负值
  - [x] 特大单占比：(buy_elg + sell_elg) / total_amount
  - 数据源：`data/tushare/moneyflow/`（482 只股票，已下载）
  - 实现：`sage_core/features/high_alpha_features.py::compute_moneyflow_features()`

- [x] **北向资金细分**（已有数据，可直接使用）✅
  - [x] 配置型资金占比：持股占比变化 < 5% 的占比
  - [x] 交易型资金流入：持股占比波动 > 10% 且净流入 > 0
  - [x] 北向持仓集中度变化：持股占比变化率
  - [x] 北向持仓稳定性：持股占比标准差（60 日）
  - 数据源：`data/tushare/northbound/northbound_hold.parquet`（已下载）
  - 实现：`sage_core/features/high_alpha_features.py::compute_northbound_features()`

- [x] **因子处理优化**（无需额外数据）✅
  - [x] 市值中性化：对每个因子做市值分组回归，取残差
  - [x] 因子正交化：PCA 或 Gram-Schmidt 正交化消除共线性
  - [x] 多 Horizon 标签融合优化：5d/10d/20d 权重调优
  - [x] 行业中性化：对每个因子减去行业均值
  - [x] 双重中性化：行业 + 市值
  - [x] 集成到 StockSelector：neutralize_features 配置项
  - 实现：`sage_core/features/factor_optimizer.py`

- [x] **组合构建优化**（无需额外数据）✅
  - [x] IC 加权持仓：仓位 = score / sum(score)（替代等权）
  - [x] 换手率约束：单次换手 ≤ 30%
  - [x] 行业暴露约束：单行业 ≤ 30%（当前 40%）
  - [x] 组合分析：持仓数、权重分布、行业分布、换手率
  - [x] 集成到 SimpleBacktestEngine：weight_method/use_portfolio_optimizer 配置项
  - 实现：`sage_core/portfolio/portfolio_optimizer.py`

- [x] **高Alpha因子集成到选股器**（2026-02-21完成）✅
  - [x] HighAlphaFeaturesWrapper 适配器（FeatureGenerator 接口）
  - [x] StockSelector 配置项：use_high_alpha_features/high_alpha_groups
  - [x] 优先因子列表扩展：新增14个高Alpha因子
  - [x] 因子测试脚本：test_high_alpha_factors.py
  - [x] 单元测试：test_high_alpha_features.py
  - [x] 数据验证脚本：validate_moneyflow.py/validate_northbound.py
  - 实现：`sage_core/features/high_alpha_wrapper.py`

#### P1 因子（需下载，120-300 积分）
- [ ] **分析师预期因子**（最强 Alpha 之一）
  - [x] 下载配置添加（forecast/express 已加入 tushare_tasks.yaml）
  - [x] 因子计算实现（`sage_core/features/high_alpha_features.py::compute_analyst_expectation_features()`）
  - [ ] 下载 forecast 数据（2016-2026，积分 120，~30 分钟）
  - [ ] 下载 express 数据（2016-2026，积分 120，~30 分钟）
  - [x] 盈利上调次数：统计最近 3 个月"预增"/"略增"次数
  - [x] 预期修正幅度：(最新预告 - 上次预告) / 上次预告
  - [x] 超预期程度：(快报净利润 - 预告中值) / 预告中值
  - [x] 预期一致性：预告区间宽度 / 中值（越小越好）

- [ ] **融资融券因子**
  - [x] 融资融券因子实现（`sage_core/features/high_alpha_features.py::compute_margin_features()`）
  - [ ] 补充 margin 数据（2020-2026，积分 120，~10 分钟）
  - [x] 融资余额变化率：(当前 - 20 日前) / 20 日前
  - [x] 融资净买入占比：(买入 - 偿还) / 总成交额

- [ ] **港股通交易数据**
  - [x] 下载配置添加（ggt_daily 已加入 tushare_tasks.yaml）
  - [ ] 下载 ggt_daily 数据（2016-2026，积分 300，~20 分钟）
  - [ ] 北向交易活跃度：buy_amount + sell_amount
  - [ ] 北向净买入强度：(buy - sell) / total_mv

#### P2 因子（需下载，2000 积分，可选）
- [ ] **个股融资融券明细**
  - [x] 下载配置添加（margin_detail 已加入 tushare_tasks.yaml）
  - [ ] 下载 margin_detail 数据（2016-2026，积分 2000，~2 小时）
  - [ ] 个股融资买入强度：rzye / total_mv
  - [ ] 个股融券做空压力：rqye / total_mv

- [ ] **主营业务构成**
  - [x] 下载配置已存在（fina_mainbz_vip 已在 tushare_tasks.yaml）
  - [ ] 业务集中度：HHI 指数（各业务收入占比平方和）
  - [ ] 新业务占比变化：新业务收入 / 总收入的变化率
  - [ ] 下载 margin_detail 数据（2016-2026，积分 2000，~2 小时）
  - [ ] 个股融资买入强度：融资买入 / 流通市值
  - [ ] 融券做空压力：融券余量 / 流通股本
  - 替代方案：用 moneyflow 大单数据近似

- [ ] **主营业务构成**
  - [ ] 下载 fina_mainbz 数据（2016-2026，积分 2000，~1 小时）
  - [ ] 业务集中度：HHI 指数
  - [ ] 新业务占比变化：新业务营收 / 总营收
  - 替代方案：用营收增长率 + 毛利率变化近似

- [ ] **其他机构行为因子**
  - [ ] 公募持仓变动因子（季报持仓变化）
  - [ ] 大宗交易因子（折价率、成交量）
  - [ ] 因子衰减分析（不同 horizon 的 IC 衰减曲线）
  - [ ] 因子拥挤度监控（因子收益率趋势）

#### 因子监控体系
- [ ] **因子IC日报**（每日计算并记录）
- [ ] **因子IC滚动统计**（5日/20日/60日均值）
- [ ] **因子衰减预警**（IC连续5日低于阈值触发告警）
- [ ] **因子贡献归因**（每期各因子对收益的贡献）

---

## 🟢 P2 回测与评估（中期）
- [x] Walk-forward/滚动回测一体化（WalkForwardEvaluator完整实现）
- [x] 交易成本/滑点/市场冲击框架（TradingCostModel完整实现）
- [x] T+1 卖出限制 & T+2 数据延迟入回测
- [ ] 评价指标：年化/回撤/IC/IR/胜率/换手率（部分实现，需补充Calmar/Sortino）
- [x] 行业回测评估体系补齐（行业命中率、行业超额、行业回撤贡献、换手与成本后收益）脚本：`scripts/strategy/evaluate_industry_backtest.py`

### 归因分析体系（新增）
- [ ] **Brinson归因**：配置效应 + 选股效应 + 交互效应
- [ ] **因子收益归因**：各风险因子贡献
- [ ] **择时/选股收益分解**
- [ ] **风险模型（BARRA风格）**
  - [ ] SIZE / BETA / MOMENTUM / VALUE / VOLATILITY / LIQUIDITY / QUALITY
  - [ ] 行业因子暴露
- [ ] **组合风险分解**：系统性风险 vs 特质风险
- [ ] **周度自动报告生成**
  - [ ] 绩效概览（收益/回撤/夏普）
  - [ ] 归因分析
  - [ ] 因子健康度
  - [ ] 持仓分析
- [ ] **月度深度报告**
  - [ ] 策略表现对比
  - [ ] 风险分析
  - [ ] 市场环境回顾

---

## 🟢 P3 监控与报告（中期）
- [x] 监控模块V1设计文档（覆盖数据/任务/信号/治理/风控/执行预留）
- [ ] 监控模块实现（暂缓；当前仅保留V1设计，后续统一开发）
- [x] 数据缺失/异常监控（check_data_quality.py等）
- [ ] 数据完整性巡检（国债收益率2Y/10Y、PMI等）
- [ ] 日报/周报模板
- [ ] 回测报告输出（markdown + csv）
- [x] 异步任务模块：趋势信号定时导出（APScheduler）
- [x] 异步任务模块：选股月度重训 + 周度信号导出（APScheduler）
- [ ] 异步任务模块：定时入库、推送与告警（APScheduler）
- [ ] 监控模块V1统一入口（`scripts/monitoring/run_monitoring.py`）
- [ ] 监控规则配置化（`config/monitoring/monitoring_rules.yaml`）
- [ ] 统一监控结果契约（PASS/WARN/FAIL + severity + metrics + thresholds）
- [ ] 数据监控纳管（macro/northbound/concepts/industry signals 核心数据集）
- [ ] 任务监控纳管（下载/特征/信号/周流程任务状态与耗时）
- [ ] 信号监控纳管（覆盖率/新鲜度/有效置信度/冲突率）
- [ ] 治理与风控监控纳管（Champion决策完整性、组合约束越界）
- [ ] 监控汇总日报与周报（`reports/monitoring/`）
- [ ] 告警通道预留（短信/webhook，先不启用）

---

## 🔵 P4 重构与扩展（长期）
- [ ] 模块插件化（策略/模型可替换）
- [x] 预留实盘接口入口（平安证券 dry-run stub）
- [x] 订单生命周期状态机契约（NEW/ACK/PARTIAL/FILLED/CANCEL/REJECT）
- [ ] 平安证券实盘下单闭环（鉴权/下单/撤单/回报/持仓对账）
- [ ] 执行审计产物（orders/fills/reconcile）标准化落盘
- [ ] LLM/NLP模块接入（政策/产业/概念信号，输出结构化标签）
- [ ] LSTM 板块超额收益预测（研究型、非主链路）
- [ ] K-means 领涨板块自动识别（研究型、非主链路）
- [ ] LLM 政策语义分析增强（需规则版稳定后接入）

### 执行系统完善（新增）
- [x] 框架完整（OrderLifecycle + BrokerAdapter）
- [ ] **TWAP执行算法**：时间加权平均价格
- [ ] **VWAP执行算法**：成交量加权平均价格
- [ ] **智能拆单**：大单分批执行
- [ ] **盘口深度考虑**：流动性约束
- [ ] **平安证券实盘闭环测试**
  - [ ] 鉴权流程
  - [ ] 下单/撤单
  - [ ] 回报处理
  - [ ] 持仓对账
- [ ] 预留多券商接口（华泰/中信等）
- [ ] 失败重试机制
- [ ] 交易状态追踪看板

### 数据治理升级（新增）
- [x] 数据质量检查脚本（check_data_quality.py等）
- [ ] **复权价格校验脚本**：前后复权一致性
- [ ] **异常值自动清洗**：3σ原则 + 业务规则
- [ ] **数据完整性检查**：断点检测与补数
- [ ] **数据新鲜度监控**：最后更新时间
- [ ] **数据源扩展**
  - [ ] Eastmoney财报数据接入
  - [ ] Eastmoney事件数据接入
  - [ ] Akshare数据源接入评估
  - [ ] 多源数据交叉验证机制
- [ ] **数据架构**
  - [ ] 建立特征库（标准化因子存储）
  - [ ] 建立标签库（多horizon标签）
  - [ ] 建立回测缓存（避免重复计算）
  - [ ] 数据版本管理（支持回溯）
  - [ ] **数据存数据库**（替代 parquet 文件，支持增量更新和查询优化）

### 工程质量提升（新增）
- [x] **代码规范**
  - [x] 添加类型注解（mypy静态检查）
  - [x] 统一代码风格（black + isort + ruff）
  - [x] 添加pre-commit hooks（black/isort/ruff/trailing-whitespace/end-of-file/yaml-check）
  - [x] 移除 `scripts/legacy/` 历史代码
  - [x] 创建 `pyproject.toml` 统一工具配置
- [x] **依赖管理**
  - [x] 迁移到 `pyproject.toml`
  - [ ] 添加版本锁定（`requirements-lock.txt`）
  - [x] 清理多余虚拟环境（保留单一开发环境，已删除venv/venv310/.venv共708M）
- [ ] **日志与监控**
  - [ ] 结构化日志（JSON格式）
  - [ ] 日志聚合（集中到单一目录结构）
  - [ ] 关键指标监控仪表盘（Grafana或自建）
- [ ] **容器化**
  - [ ] 添加 Dockerfile
  - [ ] 添加 docker-compose.yml（开发环境）
  - [ ] 环境变量管理（.env.example 完善）
- [ ] **测试覆盖**
  - [ ] `sage_app/` 模块测试补充（当前仅 `sage_core/tests/`）
  - [ ] 回测引擎端到端测试（模拟完整周期）
  - [ ] 因子计算单元测试（每个因子独立验证）
  - [ ] 添加 CI 自动化测试（GitHub Actions 或本地脚本）

### 持续迭代机制（新增）
- [x] Champion-Challenger框架（已实现）
- [ ] **自动化Challenger评估流程**
- [ ] **晋升门槛量化定义**：IC/IR/回撤综合评分
- [ ] **自动降级机制**：连续N期表现不佳触发
- [ ] **切换审计日志**
- [ ] **A/B测试机制**
  - [ ] 建立策略A/B测试框架
  - [ ] 统计显著性检验（t-test）
  - [ ] 实盘小资金灰度测试流程
- [ ] **文档体系**
  - [ ] 因子字典文档（每个因子定义/计算方式/预期方向）
  - [ ] 策略说明书（投资逻辑/风险点/适用环境）
  - [ ] 运维手册（日常操作/故障处理）

---

## 📋 优先级执行路线图

### Week 1-2: P0 高 Alpha 因子（无需下载）
1. [ ] 实现资金流因子细分（大单/小单分化度、主力持续流入）
2. [ ] 实现北向资金细分（配置型 vs 交易型识别）
3. [ ] 实现因子正交化和市值中性化
4. [ ] 实现 IC 加权持仓和换手率约束
5. [ ] 回测验证新因子效果

### Week 3-4: P1 分析师预期因子（需下载）
6. [ ] 下载 forecast 和 express 数据（~1 小时）
7. [ ] 实现盈利上调次数、预期修正幅度、超预期程度
8. [ ] 集成到特征工程流程
9. [ ] 回测验证（预期 IC > 0.05）
10. [ ] 补充融资融券数据（2020-2026）

### Week 5-6: P1 模型优化与融合
11. [ ] 多 Horizon 标签融合优化（5d/10d/20d 权重调优）
12. [ ] LGBM + XGB 模型融合（IC 加权）
13. [ ] 因子 IC 监控体系搭建
14. [ ] 6 窗口 walk-forward 验证

### Week 7-8: P2 高级因子（可选）
15. [ ] 下载 margin_detail 和 fina_mainbz（~3 小时，2000 积分）
16. [ ] 实现个股融资融券因子
17. [ ] 实现业务集中度因子
18. [ ] 因子拥挤度监控

### Week 9-10: P1 主线模型V2
19. [ ] V2-1 牛市土壤门控
20. [ ] V2-2 四维主线评分引擎
21. [ ] V2-3 四维子指标落地
22. [ ] V2-4 动态权重

### Week 11-12: P2 归因与执行
23. [ ] Brinson归因实现
24. [ ] 因子收益归因
25. [ ] TWAP/VWAP执行算法
26. [ ] 平安证券实盘测试

### 持续: P3 工程质量与监控
27. [ ] 自动化调度框架
28. [ ] 监控和告警系统
29. [ ] 自动化报告生成
30. [ ] 文档完善

---


## 🎯 关键指标目标

| 指标 | 当前状态 | 目标值 | 备注 |
|------|----------|--------|------|
| 年化收益 | - | ≥ 15% | 需长周期回测验证 |
| 最大回撤 | - | ≤ 10% | 需补齐风控体系 |
| 夏普比率 | 2.20 (Regime MA) | ≥ 1.5 | ✅ 已达标 |
| 卡玛比率 | - | ≥ 1.5 | 需计算 |
| 胜率 | - | ≥ 55% | 需统计 |
| 日均换手 | - | ≤ 5% | 需统计 |
| 测试覆盖率 | ~20% | ≥ 60% | 需补充测试 |
| 代码类型注解 | ~80% | ≥ 80% | ✅ 已达标 |

---

## 📚 关键文件清单

### 核心实现（完整可用）
- `sage_core/stock_selection/stock_selector.py` - 选股核心（完整）
- `sage_core/stock_selection/regime_stock_selector.py` - Regime选股（完整，Sharpe 2.20）
- `sage_core/stock_selection/multi_alpha_stock_selector.py` - 多策略融合（完整）
- `sage_core/trend/trend_model.py` - 趋势模型（TrendModelRuleV2完整）
- `sage_core/portfolio/portfolio_manager.py` - 组合管理（完整）
- `sage_core/portfolio/risk_control.py` - 风险控制（完整）
- `sage_core/governance/strategy_governance.py` - 治理框架（完整）
- `sage_core/backtest/walk_forward.py` - Walk-Forward回测（完整）
- `sage_core/backtest/simple_engine.py` - 简单回测引擎（完整，含EntryModel集成）
- `sage_core/backtest/cost_model.py` - 交易成本模型（完整）
- `sage_core/execution/entry_model.py` - 买卖点模型（完整，Logistic回归+predict_batch）
- `sage_core/execution/broker_adapter.py` - 券商适配器（框架完整）
- `sage_core/execution/order_lifecycle.py` - 订单生命周期（完整）
- `sage_core/execution/unified_signal_contract.py` - 统一信号契约（完整）

### 占位符（需要实现）
- `sage_core/features/satellite_features.py` - 卫星特征（仅占位符）
- `sage_core/features/flow_features.py` - 资金流特征（仅占位符）
- `sage_core/industry/cycle_detector.py` - 周期检测（仅占位符）
- `sage_core/industry/macro_predictor.py` - 宏观预测（仅占位符）

### 配置
- `config/base.yaml` - 全局配置
- `config/tushare_tasks.yaml` - 下载任务（32个任务）
- `config/app/broker.yaml` - 券商配置
- `config/app/backtest_costs.yaml` - 回测成本模型配置（default/conservative/aggressive）
- `config/app/` - 应用层配置目录
- `pyproject.toml` - 项目配置（black/isort/ruff/mypy）
- `.pre-commit-config.yaml` - pre-commit hooks 配置

### 脚本入口
- `scripts/run_job.py` - 统一任务编排
- `scripts/backtest/backtest_champion_challenger.py` - 回测对比
- `scripts/backtest/test_cost_model.py` - 成本模型单元测试
- `scripts/backtest/compare_cost_models.py` - 成本模型对比
- `scripts/backtest/analyze_cost_breakdown.py` - 成本构成分析
- `scripts/backtest/test_realistic_cost.py` - 真实场景成本测试
- `scripts/data/tushare_downloader.py` - 数据下载
- `scripts/data/backfill_missing_data.py` - 历史数据补充（支持daily/monthly/single）
- `scripts/monitoring/check_data_quality.py` - 数据质量检查

---

## 🔄 与旧TODO的主要差异

### ✅ 已完成但旧TODO标记为未完成
- 趋势模型已优化（TrendModelRuleV2完整实现，三层架构+熔断+波动率自适应）
- Regime选股已实现（RegimeStockSelector完整，回测Sharpe 2.20）
- Champion/Challenger框架已实现（StrategyGovernance完整）
- Walk-Forward回测已实现（WalkForwardEvaluator完整，Purge/Embargo防过拟合）
- 防过拟合机制完整（IC筛选、Purge/Embargo、分组回测）
- 信号契约已落地（UnifiedSignalContract完整）

### ❌ 未完成但旧TODO标记为已完成或描述不准确
- 买卖点模型（仅有占位符，无实际实现）
- 宏观模型集成（数据处理存在于scripts/data/macro/，未集成到sage_core/）
- 自动化调度（配置存在，但DAG调度逻辑不完整）
- 趋势模型"缺置信度/仓位"（实际已实现confidence/position_suggestion）
- 排序/买卖点"未完成端到端训练"（实际StockSelector已完整实现）

### 🆕 新发现的问题
- 概念数据获取受限（Tushare IP限制）
- 交易成本模型简化（仅有单边成本率，缺乏滑点和市场冲击）
- 特征系统不完整（Satellite/Flow/LongTermFundamental仅占位符）
- 数据更新机制不完整（缺乏自动化DAG调度）
- 行业模型V2未实现（主线模型V2的四维评分引擎）

---

## 📝 文档维护说明

**重要**：本TODO文档是项目的核心跟踪文档，每次完成任务后必须更新：

1. **任务完成时**：将对应的 `[ ]` 改为 `[x]`
2. **发现新问题时**：添加到对应优先级章节
3. **实现状态变化时**：更新"实现状态总览"表格
4. **每周回顾时**：检查优先级是否需要调整
5. **重大里程碑时**：更新"关键指标目标"表格

**更新频率**：
- 每完成一个P0任务：立即更新
- 每完成一个P1任务：当天更新
- 每周五：全面回顾和调整优先级

---

## Q&A
- Q: 是否保留/迁移 `ml_stock_forecast` 作为旧版基线？
  A: 已拆分为 `sage_core/`（核心）与 `sage_app/`（非核心管线），历史说明移至 `docs/legacy/ml_stock_forecast/`。
- Q: 低频调仓目标是"周/双周/月"？
  A: 周频调仓（已确认）。
- Q: 项目完成度如何？
  A: 约90%，核心选股系统95%完成可直接使用，买卖点模型和增强风控已完成，代码规范工具链已搭建，主要短板是自动化调度和归因分析。

---

**最后更新**：2026-02-21（高Alpha因子完整集成到选股器和回测引擎）
**更新依据**：
- 实现资金流因子细分（4个因子：大单净流入占比/主力持续流入天数/散户机构分化度/特大单占比）
- 实现北向资金细分（4个因子：配置型资金占比/交易型资金流入/持仓集中度变化/持仓稳定性）
- 实现分析师预期因子（4个因子：盈利上调次数/预期修正幅度/超预期程度/预期一致性）
- 实现融资融券因子（2个因子：融资余额变化率/融资净买入占比）
- 实现因子优化模块（市值中性化/因子正交化/多Horizon标签融合/行业中性化/双重中性化）
- 实现组合构建优化（IC加权持仓/换手率约束/行业暴露约束/组合分析）
- **集成到StockSelector**：HighAlphaFeaturesWrapper适配器、配置项、因子中性化
- **集成到SimpleBacktestEngine**：IC加权持仓（softmax/linear/rank）、组合优化约束
- **测试与验证**：因子测试脚本、单元测试、数据验证脚本（moneyflow/northbound）
- **文档完善**：为high_alpha_features/factor_optimizer/portfolio_optimizer补充详细docstring
- **数据问题修复**：修复sw_valuation配置错误、验证northbound数据缺口（2020-2025缺失）
- 更新tushare_tasks.yaml配置（新增forecast/express/ggt_daily/margin_detail下载任务）
- 新增8个文件：high_alpha_features.py/factor_optimizer.py/portfolio_optimizer.py/high_alpha_wrapper.py/test_high_alpha_features.py/test_high_alpha_factors.py/validate_moneyflow.py/validate_northbound.py
**项目完成度**：约95%
**下次更新**：下载P1数据或回测验证后，或每周五
