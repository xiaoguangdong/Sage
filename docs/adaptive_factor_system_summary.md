# 自适应因子系统总结

## 项目概述

构建了一个基于市场风格状态机的自适应股票选股系统，通过识别市场风格动态调整因子权重，以应对A股市场风格多变的挑战。

## 时间线

- **2026-02-09**: 完成因子计算、回测分析、市场风格状态机、自适应权重系统

## 系统架构

### 1. 因子计算系统

**文件**: `scripts/models/calculate_stock_factors.py`

**计算因子**（8个，分4类）：

| 类别 | 因子 | 说明 |
|------|------|------|
| **动量 (Momentum)** | 4w_ret | 4周收益率 |
|  | 12w_ret | 12周收益率 |
| **质量 (Quality)** | roe_ttm | ROE（TTM） |
|  | gross_margin | 毛利率 |
| **流动性 (Liquidity)** | turnover | 换手率 |
|  | amt_rank | 成交额排名 |
| **风险 (Risk)** | vol_12w | 12周波动率 |
|  | beta | Beta系数 |

**横截面排名得分**：
- 所有因子归一化到 0-100
- 综合得分 = 各因子排名的平均值

**性能优化**：
- 质量因子计算：从 17 分钟 → 4 秒（优化 255 倍）
- 风险因子计算：修复 beta 计算逻辑
- 使用向量化操作替代嵌套循环

**数据覆盖**：
- 时间范围：2020-2026年
- 股票数量：5,690 只
- 总记录数：6,945,861 条

### 2. 市场风格状态机

**文件**: `ml_stock_forecast/scripts/calculate_market_regime.py`

**计算10个风格特征**：

| 编号 | 特征 | 计算方法 | 意义 |
|------|------|---------|------|
| 1 | 动量IC | corr(rank(ret_4w), rank(fwd_ret_4w)) | 趋势还是反转 |
| 2 | 成交额解释力 | corr(rank(turnover_chg_4w), rank(fwd_ret_2w)) | 资金是否追逐热点 |
| 3 | 波动-收益相关性 | corr(rank(vol_2w), rank(fwd_ret_2w)) | 情绪市还是厌恶风险 |
| 4 | ROE IC | corr(rank(roe_ttm), rank(fwd_ret_12w)) | 基本面是否有效 |
| 5 | 收益集中度 | top10_ret_sum / market_ret_sum | 妖股还是扩散 |
| 6 | 大小盘相对强度 | ret_small_cap - ret_large_cap | 风格切换 |
| 7 | 高换手胜率 | mean(fwd_ret_1w[turnover_rank > 0.8]) | 短线生态健康度 |
| 8 | 行业轮动速度 | count_top_industry_change(rolling=4w) | 风格稳定性 |
| 9 | 市场趋势强度 | index_price / index_ma_20w - 1 | 做多环境 |
| 10 | 横截面相关性 | mean_pairwise_corr(stock_returns_1w) | 系统性风险 |

**四个风格维度**：

```python
trend_raw = (
    mom_ic * 1.0
    + index_trend * 0.6
    - industry_switch * 0.3
)

liquidity_raw = (
    liq_ic * 1.0
    + small_big * 0.5
    + high_turn_ret * 0.5
)

fundamental_raw = (
    roe_ic * 1.2
    - ret_concentration * 0.5
)

speculative_raw = (
    vol_ret_corr * 0.8
    + ret_concentration * 1.0
    + industry_switch * 0.5
)
```

**统计结果**（2020-2025年，288个数据点）：

| 风格维度 | 平均值 | 标准差 | 中位数 | 范围 |
|---------|--------|--------|--------|------|
| trend_raw | 0.05 | 3.86 | **-0.38** | -8.91 ~ 12.77 |
| liquidity_raw | 0.37 | 3.00 | 0.09 | -10.37 ~ 18.43 |
| fundamental_raw | 0.01 | 0.17 | 0.03 | -0.49 ~ 0.38 |
| speculative_raw | 0.78 | 0.23 | 0.77 | 0.28 ~ 2.00 |

**核心发现**：
1. **基本面长期失效**：fundamental_raw 中位数仅 0.03，几乎为零
2. **投机情绪持续高涨**：speculative_raw 长期为正（平均 0.78）
3. **趋势不稳定**：trend_raw 中位数 -0.38，大部分时间是震荡或反转

### 3. 自适应因子权重系统

**文件**: `ml_stock_forecast/scripts/adaptive_factor_weights.py`

**权重调整逻辑**：

```python
# 根据趋势风格调整动量因子权重
if trend_raw > 0:
    # 趋势市，增加动量权重
    momentum_weight = 0.38 + (trend_raw / 10) * 0.2
else:
    # 反转市，降低动量权重
    momentum_weight = 0.38 - (abs(trend_raw) / 10) * 0.15

# 根据基本面风格调整质量因子权重
if fundamental_raw > 0:
    quality_weight = 0.25 + fundamental_raw * 0.5
else:
    quality_weight = 0.25 + fundamental_raw * 0.3

# 根据投机风格调整风险因子权重
if speculative_raw > 0:
    # 投机市，降低风险权重（鼓励冒险）
    risk_weight = 0.13 - speculative_raw * 0.05
else:
    # 风险厌恶，增加风险权重
    risk_weight = 0.13 - speculative_raw * 0.03

# 权重归一化
total = momentum_weight + quality_weight + liquidity_weight + risk_weight
momentum_weight /= total
quality_weight /= total
liquidity_weight /= total
risk_weight /= total
```

**权重调整范围**：

| 因子 | 最小值 | 最大值 | 变动幅度 |
|------|--------|--------|----------|
| momentum_weight | 0.2449 | 0.5684 | 0.3235 |
| quality_weight | 0.1374 | 0.4038 | 0.2664 |
| liquidity_weight | 0.1367 | 0.4274 | 0.2907 |
| risk_weight | 0.0683 | 0.1539 | 0.0856 |

## 回测结果

### 固定因子回测

**测试设置**：
- 测试日期：68个（按月选择）
- 时间范围：2020-04-03 至 2025-11-03
- 选股策略：Top 10 高分股票 vs Bottom 10 低分股票
- 评估周期：1周、4周、12周

**结果汇总**：

| 周期 | Top10平均 | Bottom10平均 | 超额收益 | 超额胜率 |
|------|-----------|-------------|----------|----------|
| 1周  | 0.12% | 0.18% | **-0.06%** | 55.9% |
| 4周  | 0.80% | -0.82% | **1.62%** | 50.0% |
| 12周 | 3.07% | 2.92% | **0.15%** | **47.1%** |

**关键问题**：
1. **12周超额收益仅 0.15%**，几乎为零
2. **胜率 47.1%**，低于随机（50%）
3. 长期无显著优势

### 失效案例分析：2024年7-10月

**回测结果**：

| 日期 | 4周超额 | 12周超额 | 情况 |
|------|---------|----------|------|
| 2024-07-01 | **-28.24%** | **-31.40%** | 低分股大涨30% |
| 2024-08-01 | -5.92% | **-46.90%** | 低分股大涨58% |
| 2024-09-02 | -16.80% | **-65.02%** | 低分股暴涨75% |
| 2024-10-08 | -27.96% | -33.63% | 连续3个月失效 |

**根本原因**：

| 时期 | trend_raw | liquidity_raw | speculative_raw | 结果 |
|------|-----------|--------------|----------------|------|
| **2024年7-10月（失效）** | **-0.28** ❌ | -0.64 | 0.72 | 反转市，动量因子失效 |
| **2025年7月（有效）** | **1.20** ✅ | -0.07 | 0.78 | 趋势市，动量因子有效 |

**结论**：选股因子是**动量驱动的**，在反转市中完全失效。

### 自适应因子回测

**测试设置**：
- 测试日期：271个（每5天一个）
- 时间范围：2020-2026年
- 对比：固定因子 vs 自适应因子

**结果对比**：

| 指标 | 固定因子 | 自适应因子 | 改善 |
|------|---------|-----------|------|
| **平均收益%** | 1.78% | 1.76% | -0.02% |
| **胜率%** | 50.7% | 50.4% | -0.3% |
| **超额收益%** | -4.74% | **-2.64%** | **+2.10%** ✅ |
| **超额胜率%** | 45.5% | 44.2% | -1.3% |

**2024年7-10月（失效期）对比**：

| 日期 | 固定12周收益% | 自适应12周收益% | 改善 |
|------|--------------|----------------|------|
| 2024-07-04 | 7.57 | 5.90 | -1.67 |
| 2024-07-25 | 14.54 | 8.97 | -5.57 |
| 2024-08-08 | 16.14 | 25.72 | +9.58 ✅ |
| 2024-09-05 | 20.77 | 19.28 | -1.49 |
| 2024-10-21 | -5.74 | 7.74 | +13.48 ✅ |

**评估**：
- ✅ **成功识别市场风格**：trend_raw < 0 识别出反转市
- ✅ **自动调整因子权重**：反转市降低动量权重
- ⚠️ **改善幅度有限**：超额收益从 -4.74% 提升到 -2.64%
- ❌ **策略调整不够激进**：只是降低权重，没有反转策略

## 核心结论

### 1. 市场风格多变是根本原因

- A股市场风格切换频繁
- 固定因子无法适应风格变化
- 必须建立风格状态机实时识别市场风格

### 2. 基本面长期失效

- fundamental_raw 中位数仅 0.03
- ROE、毛利率等基本面指标长期无预测能力
- 解释了"白马失效"现象

### 3. 投机情绪持续高涨

- speculative_raw 长期为正（平均 0.78）
- 市场长期处于"题材市"、"情绪市"
- 波动率与收益正相关

### 4. 趋势vs反转是关键

- trend_raw 是风格识别的锚点
- 趋势市（trend_raw > 0）：动量因子有效
- 反转市（trend_raw < 0）：动量因子失效

### 5. 自适应权重系统有效但不足

- ✅ 成功识别市场风格
- ✅ 自动调整因子权重
- ⚠️ 改善幅度有限（+2.10%）
- ❌ 策略调整不够激进

## 技术要点

### 性能优化

1. **质量因子计算优化**：
   - 问题：嵌套循环遍历 6,516 只股票 × 1,500 个交易日
   - 解决：使用 pandas 向量化操作
   - 效果：17 分钟 → 4 秒（优化 255 倍）

2. **风险因子计算修复**：
   - 问题：beta 计算返回列表，reset_index 导致数据不匹配
   - 解决：直接赋值，不使用 reset_index
   - 效果：成功计算 vol_12w 和 beta

3. **自适应权重数据修复**：
   - 问题：风格特征数据按周（288条），因子数据按天（1420条）
   - 解决：使用 ffill() 向前填充到所有日期
   - 效果：所有日期都有风格数据

### 代码质量

- 完整的日志系统
- 进度反馈机制
- 错误处理和边界情况检查
- 后台任务支持（nohup）

## 文件清单

| 文件 | 说明 |
|------|------|
| `scripts/models/calculate_stock_factors.py` | 因子计算系统 |
| `ml_stock_forecast/scripts/calculate_market_regime.py` | 市场风格状态机 |
| `ml_stock_forecast/scripts/adaptive_factor_weights.py` | 自适应因子权重系统 |
| `run_factor_calculation.sh` | 后台任务运行脚本 |
| `data/tushare/factors/stock_factors_with_score.parquet` | 固定因子得分 |
| `data/tushare/factors/stock_factors_with_adaptive_score.parquet` | 自适应因子得分 |
| `data/tushare/factors/market_regime_features.parquet` | 市场风格特征 |
| `data/tushare/factors/adaptive_factor_weights.csv` | 因子权重历史 |

## 数据统计

### 因子数据
- 总记录数：6,945,861 条
- 股票数量：5,690 只
- 时间范围：2020-2026年
- vol_12w 非空：6,940,200 条
- beta 非空：6,940,200 条

### 风格特征数据
- 总记录数：288 条（按周）
- 时间范围：2020-2025年
- 10个风格特征
- 4个风格维度

### 权重历史数据
- 总记录数：1,420 条（按天）
- 时间范围：2020-2026年
- 4个因子权重

## 下一步建议

### 策略改进

**方案1：激进策略 - 反转动量因子**
```python
if trend_raw < 0:
    # 反转市，反转动量因子符号
    4w_ret_adj = -4w_ret
    12w_ret_adj = -12w_ret
else:
    # 趋势市，正常动量因子
    4w_ret_adj = 4w_ret
    12w_ret_adj = 12w_ret
```

**方案2：保守策略 - 放弃动量因子**
```python
if trend_raw < 0:
    # 反转市，只使用质量、流动性、风险因子
    momentum_weight = 0
    quality_weight = 0.33
    liquidity_weight = 0.33
    risk_weight = 0.34
```

### 因子扩展

1. **反转因子**：
   - 短期反转：-1w_ret, -2w_ret
   - RSI超卖
   - 相对强弱

2. **技术指标**：
   - MACD
   - KDJ
   - 布林带

3. **情绪指标**：
   - 融资融券
   - 北向资金
   - 涨跌停统计

### 风险控制

1. **市场过滤**：
   - 只在趋势市中使用因子
   - 反转市降低仓位或空仓

2. **止损机制**：
   - 单股止损
   - 组合止损
   - 动态调整仓位

3. **组合优化**：
   - 行业分散
   - 风格平衡
   - 波动率控制

## 总结

通过构建市场风格状态机，成功识别了A股市场的风格特征，并实现了自适应因子权重调整系统。虽然改善幅度有限（超额收益提升2.10%），但验证了风格识别的有效性，为后续策略改进奠定了基础。

核心发现：
1. A股市场风格多变，固定因子无法适应
2. 基本面长期失效，投机情绪持续高涨
3. 趋势vs反转是关键风格维度
4. 自适应权重系统有效但需要更激进的策略调整

下一步建议实现更激进的策略调整（反转动量因子或放弃动量因子），并扩展因子库（反转因子、技术指标、情绪指标），同时加强风险控制机制。