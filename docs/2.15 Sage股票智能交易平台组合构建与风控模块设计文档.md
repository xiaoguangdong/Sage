# Sage股票智能交易平台组合构建与风控模块设计文档

## 1. 模块定位
将候选股票构建为组合，并执行风控约束。

---

## 2. 组合约束（已确认）
- 最大持仓数：10
- 权重方式：等权
- 单行业最大权重：40%（申万一级）
- 单股最大权重：不设（可配置）

---

## 3. 输入 / 输出
**输入**：
- 候选股票（已过滤）
- 行业标签（申万一级）

**输出**：
```json
{
  "date": "2026-02-13",
  "positions": [
    {"ts_code": "600519.SH", "weight": 0.1}
  ],
  "risk_flags": []
}
```

**输出落地（建议）**：
- `data/signals/portfolio/positions_<YYYYMMDD>.parquet`
- 字段：`trade_date/ts_code/weight/sector/risk_flags`

---

## 4. 风控检查
- 行业暴露限制
- 总仓位限制
- 回撤阈值（可选）

### 4.1 流程图（Mermaid）
```mermaid
flowchart LR
  A["候选股列表"] --> B["等权分配"]
  B --> C["行业暴露校验"]
  C --> D["输出组合"]
```

---

## 5. 与现有代码映射
- `sage_core/portfolio/construction.py`
- `sage_core/portfolio/risk_control.py`

---

## 6. 仓位管理方案对比分析（2026-02-18）

> 基于三个来源的仓位管理方案梳理：当前回测实现、趋势模型设计文档、豆包聊天记录完整方案

### 6.1 当前回测实现（backtest_multi_period.py）

**总仓位**：静态映射

| 市场状态 | 仓位比例 |
|---------|---------|
| bear (0) | 30% |
| neutral (1) | 60% |
| bull (2) | 100% |

**个股仓位**：等权分配（Top30 每只 1/30）

**止损**：无

**问题**：bear=30% 过于保守（区间二 bear 期均收益 +17.32%，仅拿到 30% 仓位），牛市永远满仓无风控。

### 6.2 趋势模型设计文档（docs/2.2）

**总仓位**：动态映射，基于 state × confidence

```
position = base + (max - base) × confidence
```

| 市场状态 | 仓位区间 [base, max] |
|---------|---------------------|
| RISK_ON | [0.70, 0.95] |
| NEUTRAL | [0.30, 0.60] |
| RISK_OFF | [0.00, 0.25] |

示例：RISK_ON + confidence=0.8 → 0.70 + 0.25×0.8 = 0.90

**个股仓位**：未定义

**止损**：未定义

**特点**：比静态映射更精细，引入置信度维度。趋势模型已输出 confidence，但回测未接入。

### 6.3 豆包聊天记录（完整方案）

**总仓位**：5 种模型可选

| 模型 | 公式/逻辑 | 适用场景 |
|------|----------|---------|
| 固定比例 | bear=30%, neutral=60%, bull=100% | 基线 |
| 目标波动率 | target_vol / estimated_vol | 风险预算型 |
| Kelly公式 | f = (p×b - q) / b | 理论最优 |
| 市场自适应 | 基于趋势强度+波动率动态调整 | 综合型 |
| CPPI | floor + multiplier × (portfolio - floor) | 保本型 |

**个股仓位**：3 种分配方式

| 方式 | 逻辑 |
|------|------|
| 等权 | 1/N |
| 预测加权 | 按模型打分比例分配 |
| 风险平价 | 按波动率倒数分配 |

**止损体系**：

| 层级 | 规则 |
|------|------|
| 个股追踪止损 | 从最高点回撤 10% 卖出 |
| 个股固定止损 | 买入价下跌 15% 卖出 |
| 组合日止损 | 单日跌 2% → 减仓 10% |
| 组合周止损 | 单周跌 5% → 减仓 50% |

**熊市特殊规则**：target_vol=10%，最大仓位 50%，动态对冲

### 6.4 差距分析

| 维度 | 当前实现 | 设计文档 | 豆包方案 | 差距 |
|------|---------|---------|---------|------|
| 总仓位 | 静态3档 | 动态(state×confidence) | 5种模型 | 未接入 confidence |
| 个股仓位 | 等权 | 未定义 | 3种方式 | 缺预测加权/风险平价 |
| 止损 | 无 | 无 | 4层止损 | 完全缺失 |
| 熊市风控 | 仅降仓30% | 降仓0~25% | vol目标+上限+对冲 | 缺失 |

### 6.5 建议实施优先级

| 优先级 | 事项 | 说明 |
|--------|------|------|
| P0 | 接入 confidence 动态仓位 | 设计文档方案，改动最小，趋势模型已输出 confidence |
| P0 | 个股追踪止损 + 组合层回撤降仓 | 豆包方案止损体系，当前最大回撤 -13%~-51% 无保护 |
| P1 | 目标波动率仓位模型 | 替代固定比例，风险预算型 |
| P1 | 预测加权个股分配 | 利用已有模型打分，替代等权 |
| P2 | 风险平价 + CPPI 等高级方案 | 长期优化 |

---

## Q&A
- Q: 是否引入波动率或风险平价权重？
  A: 暂不优先，但已纳入 P1/P2 规划（见 6.5 节）。
