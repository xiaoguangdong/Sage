# Sage股票智能交易平台宏观模型模块设计文档

## 1. 模块定位
宏观模型用于**识别行业景气度与场景**，不直接给买卖点，只输出行业机会与风险等级，作为选股与信号融合的“方向盘”。

---

## 2. 输入 / 输出
**输入**：
- NBS 行业数据：PPI分项、FAI、产量等（月度/季度）
- Tushare 宏观：CPI/PPI/PMI/利率/社融等
- 北向资金/资金流（可选）
- 行业映射（NBS → 申万）

**输出**：
```json
{
  "date": "2026-02-13",
  "systemic_scenario": "NORMAL",
  "opportunity_industries": [
    {"industry": "电力设备", "scenario": "RECOVERY", "confidence": 0.72}
  ],
  "risk_level": "MEDIUM"
}
```

**输出落地（建议）**：
- `data/signals/macro_opportunity_<YYYYMM>.parquet`
- 字段：`date/industry/scenario/confidence/boom_score`

**工业品产量说明（重要）**：
- 统计局提供的是**产品级产量**，不是行业产量。
- 平台保留**产品级产量特征**，并在需要时通过“产品→行业”的映射生成**行业代理特征**。
- 映射来源：`config/nbs_product_sw_mapping.yaml`（基于统计局目录说明 + GB/T 4754-2017）。

---

## 3. 核心逻辑
1. **系统性风险判定**
   - PMI、社融增速等触发 “SYSTEMIC RECESSION”
2. **行业景气度评分**
   - PPI改善、FAI增速、库存拐点、估值分位
3. **场景分类**
   - RECOVERY / BOOM / RECESSION / NEUTRAL
4. **置信度评分**
   - 指标偏离阈值程度 + 一致性
5. **资金流信号（市场级）**
   - 北向资金行业配置比例突破布林带上轨（优先）
   - 若无行业数据则退化为市场级净流入突破

### 3.1 指标清单（MVP v1）
- 宏观：`pmi_turning_point`, `yield_spread(10Y-2Y)`, `yield_spread_signal`
- 行业：`revenue_acceleration`, `gross_margin_change`, `prosperity_signal`
- 资金：`northbound_industry_ratio`（布林带突破），缺失时退化为`northbound_net_flow`

### 3.2 现有实现与落地
- 核心信号实现：`sage_core/models/signal_indicators.py`
- 一键导出脚本：`scripts/models/macro/export_macro_signals.py`
- 输出路径（建议）：`data/signals/`
  - `macro_pmi_signal_YYYYMMDD.parquet`
  - `macro_yield_spread_YYYYMMDD.parquet`
  - `industry_prosperity_YYYYMMDD.parquet`
  - `northbound_flow_YYYYMMDD.parquet`
  - `northbound_industry_ratio_YYYYMMDD.parquet`（若有行业数据）

> 导出脚本默认已应用 T+2 延迟（可通过参数调整）。
> 支持 `--tushare-root` 指定数据根目录（包含 macro/fundamental/northbound）。

**工业品产量对齐脚本**：
- `scripts/data/macro/align_nbs_industrial_data.py`
- 输出两套结果：
  - `data/processed/nbs_output_product_level.parquet`（产品级）
  - `data/processed/nbs_industrial_aligned.parquet`（行业代理）

### 3.3 流程图（Mermaid）
```mermaid
flowchart LR
  A["宏观/NBS/资金数据"] --> B["行业映射与对齐"]
  B --> C["指标计算/评分"]
  C --> D["场景分类+置信度"]
  D --> E["行业机会列表"]
```

---

## 4. 数据延迟
财报/公告/北向等按 **T+2** 延迟，严格防止前视。

---

## 5. 与现有代码映射
- `sage_core/models/macro_predictor.py`
- `sage_core/models/industry_classifier.py`
- `sage_core/models/cycle_detector.py`
- `sage_core/models/signal_indicators.py`
- `scripts/models/macro/export_macro_signals.py`

---

## 6. 测试策略
- 单元测试：场景分类边界  
- 回测验证：是否提升行业轮动与回撤  

---

## Q&A
- Q: 行业映射口径是否统一申万一级？  
  A: 当前默认申万一级，后续可配置。
- Q: 行业景气度是否已聚合到行业层？  
  A: 目前为个股财务信号，行业聚合待补（后续接入申万成分映射）。
