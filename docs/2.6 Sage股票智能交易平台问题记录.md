# Sage股票智能交易平台问题记录

## 已知问题（代码层）
1. **数据字段不统一**：`stock`/`code`/`ts_code` 混用
2. **run_weekly 与 DataLoader 接口不匹配**
3. **特征脚本存在语法/API错误**（`price_features.py` / `market_features.py`）
4. **趋势模型逻辑问题**（`ma_medium` 赋值 / 未定义变量）
5. **回测存在随机收益占位**（无法评估真实策略）

## 已知问题（数据层）
1. **Tushare IP/积分限制**：批量下载易中断
2. **NBS 爬虫尚未稳定**
3. **概念/北向数据存在缺口**
4. **行业映射不完整**（NBS → 申万）

## 已知问题（工程层）
1. 脚本分散且命名不统一
2. 日志规范未完全落地

---

## 已解决问题（2026-02-17）

### P1. 趋势模型配置不一致
- **现象**：`backtest_multi_period.py` 和 `show_stock_picks.py` 使用 TrendModelConfig 默认值 (5/8/10)，而 `test_trend_model_v2.py` 使用 (3/5/7)，导致回测结果不可复现
- **影响**：状态识别滞后，Regime模型训练标签与推理标签不一致
- **修复**：统一为 (confirmation_periods=3, exit_tolerance=5, min_hold_periods=7)

### P2. 行业映射逻辑错误
- **现象**：`show_stock_picks.py` 直接读取 `sw_industry_l1.parquet` 做映射，未通过 `sw_index_member.parquet` 关联，导致 `backtest_picks.csv` 行业列全空
- **修复**：改为 sw_index_member → sw_industry_l1 两表 join

## 待解决问题（2026-02-17）

### P3. Regime模型对配置高度敏感（已解决）
- **现象**：趋势模型配置从 (5/8/10) 改为 (3/5/7) 后，Regime模型累计收益从 +68.77% 降至 +49.17%（降幅28.5%），而单一模型几乎不变
- **根因**：软分配下其他regime数据污染专家模型，配置变更导致样本重新分配
- **修复**：改为硬分配（只用对应regime数据）+ 时间衰减，Regime模型恢复至 +102.20%

### P4. Regime训练样本分布不均衡（已解决）
- **现象**：2020-2024训练期 bear=44.1%, neutral=34.7%, bull=21.2%；bull样本主要来自2020年（111天），远期数据占比过高
- **修复**：硬分配 + 时间衰减加权（指数衰减，半衰期~2年），近期数据权重更高，远期陈旧模式被抑制
- **注意**：硬分配要求训练数据≥3年，否则子模型样本不足会崩溃（区间一仅1年数据，Regime -42%）

### P5. 股票名称加载路径错误（已解决）
- **现象**：脚本从不存在的 `stock_basic.parquet` 读取股票名称，导致选股清单名称列为空
- **根因**：路径问题，非数据缺失。股票名称已存在于 `concepts/ths_member.parquet`（con_code + con_name，11041只）
- **修复**：改为从 `ths_member.parquet` 读取名称映射

### P6. 选股预测 Score 坍缩（已解决）
- **现象**：回测中所有股票预测分数完全一致（如单一模型全部0.5052，Regime neutral全部0.4823），选股实质为按ts_code字母排序的随机选择
- **根因**：`predict()` 在回测循环中接收单日数据（每只股票仅1行），`prepare_features()` 计算 pct_change / rolling mean / rolling std 等时序特征时，单行数据全部返回 NaN；`_fill_missing_features()` 用截面中位数填充 → 所有股票特征向量完全相同 → 预测分数一致
- **影响**：此前所有回测结果（含 +102% Regime模型）均基于随机选股，不可信；趋势模型和训练流程不受影响
- **修复**：新增 `predict_prepared()` 方法，先对全量时序数据调用 `prepare_features(df_all)` 预计算特征，回测循环中按日期切片后直接预测，保留完整时序信息
- **验证**：修复后区间二（2024-2026）Top5 score 有明显分化（0.5462~0.5421），两模型重叠仅4~6/30

### P7. Regime训练标签噪声导致专家模型同质化（已解决）
- **现象**：三个Regime专家模型（bull/neutral/bear）收敛到完全相同的策略，均以 pb_percentile 为主导特征，IC方向一致
- **根因**：趋势模型对短期反弹过度敏感，生成的regime标签碎片化（如2023Q1被标为bull，实际是深度熊市），导致各专家训练数据混杂，学不到差异化模式
- **影响**：Regime模型区间二仅+54.94%，不如单一模型+61.60%；区间一-10.82%远差于单一模型+2.43%
- **修复**：训练改用人工划分的宏观市场阶段标签（bull:2020.01~2021.02/2024.09~, bear:2021.03~2023.12, neutral:2024.01~2024.08），推理仍用趋势模型实时判断
- **验证**：Regime模型区间二从+54.94%提升至+80.69%（Sharpe 1.95），区间一从-10.82%提升至+9.14%

## 进行中问题
- 2年期国债收益率下载不完整
- 概念板块分页与断点续传

---

## Q&A
- Q: 是否保留 Baostock 作为主数据源？
  A: 优先级为 Tushare > NBS > Eastmoney > Akshare
- Q: 现有 `ml_stock_forecast` 是否直接重构进新架构？
  A: 已拆分为 `sage_core/`（核心）与 `sage_app/`（非核心管线），历史说明移至 `docs/legacy/ml_stock_forecast/`
