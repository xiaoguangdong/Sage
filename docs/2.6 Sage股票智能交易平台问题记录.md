# Sage股票智能交易平台问题记录

## 已知问题（代码层）
1. **数据字段不统一**：`stock`/`code`/`ts_code` 混用  
2. **run_weekly 与 DataLoader 接口不匹配**  
3. **特征脚本存在语法/API错误**（`price_features.py` / `market_features.py`）  
4. **趋势模型逻辑问题**（`ma_medium` 赋值 / 未定义变量）  
5. **回测存在随机收益占位**（无法评估真实策略）  

## 已知问题（数据层）
1. **Tushare IP/积分限制**：批量下载易中断  
2. **NBS 爬虫尚未稳定**  
3. **概念/北向数据存在缺口**  
4. **行业映射不完整**（NBS → 申万）  

## 已知问题（工程层）
1. 脚本分散且命名不统一  
2. 日志规范未完全落地  

---

## 已解决问题（2026-02-17）

### P1. 趋势模型配置不一致
- **现象**：`backtest_multi_period.py` 和 `show_stock_picks.py` 使用 TrendModelConfig 默认值 (5/8/10)，而 `test_trend_model_v2.py` 使用 (3/5/7)，导致回测结果不可复现
- **影响**：状态识别滞后，Regime模型训练标签与推理标签不一致
- **修复**：统一为 (confirmation_periods=3, exit_tolerance=5, min_hold_periods=7)

### P2. 行业映射逻辑错误
- **现象**：`show_stock_picks.py` 直接读取 `sw_industry_l1.parquet` 做映射，未通过 `sw_index_member.parquet` 关联，导致 `backtest_picks.csv` 行业列全空
- **修复**：改为 sw_index_member → sw_industry_l1 两表 join

## 待解决问题（2026-02-17）

### P3. Regime模型对配置高度敏感
- **现象**：趋势模型配置从 (5/8/10) 改为 (3/5/7) 后，Regime模型累计收益从 +68.77% 降至 +49.17%（降幅28.5%），而单一模型几乎不变
- **根因**：配置变更同时影响训练期 regime 标签和推理期 regime 选择，导致样本在三个专家模型间重新分配
- **方案**：引入时间衰减样本加权，降低远期数据影响（见TODO P4）

### P4. Regime训练样本分布不均衡
- **现象**：2020-2024训练期 bear=44.1%, neutral=34.7%, bull=21.2%；bull样本主要来自2020年（111天），远期数据占比过高
- **影响**：等权训练导致2020年陈旧bull模式主导牛市专家模型，2024年新模式被稀释
- **方案**：
  1. 时间衰减加权（指数衰减，半衰期~2年，近期数据权重从37%提升至62%）
  2. 动态训练窗口（按regime分别选取最近N个月样本，即使窗口不统一也可保证样本新鲜度）
  3. 固定 random_state 保证可复现性

### P5. stock_basic.parquet 缺失
- **现象**：`data/tushare/stock_basic.parquet` 不存在，导致选股清单中股票名称列为空
- **方案**：补充下载 stock_basic 数据

## 进行中问题
- 2年期国债收益率下载不完整
- 概念板块分页与断点续传

---

## Q&A
- Q: 是否保留 Baostock 作为主数据源？  
  A: 优先级为 Tushare > NBS > Eastmoney > Akshare
- Q: 现有 `ml_stock_forecast` 是否直接重构进新架构？  
  A: 已拆分为 `sage_core/`（核心）与 `sage_app/`（非核心管线），历史说明移至 `docs/legacy/ml_stock_forecast/`
