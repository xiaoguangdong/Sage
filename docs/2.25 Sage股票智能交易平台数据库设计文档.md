# Sage股票智能交易平台数据库设计文档

## 1. 设计目标

将现有 parquet 文件存储迁移至关系型数据库（PostgreSQL），实现：
- 增量更新（避免全量覆盖 parquet）
- 高效查询（按股票代码、日期范围索引）
- 数据一致性（事务保证、去重约束）
- 多进程并发读写安全

---

## 2. 技术选型

| 组件 | 选择 | 理由 |
|---|---|---|
| 数据库 | PostgreSQL 16 | 成熟稳定，支持分区表、JSON、时序扩展 |
| 连接池 | SQLAlchemy + psycopg2 | Python 生态标准 |
| 迁移工具 | Alembic | 版本化 DDL 管理 |
| 容器化 | Docker Compose | 与应用一起编排 |

---

## 3. 数据库架构

### 3.1 Schema 划分

```
sage_db
├── market      -- 行情数据（日线、指数）
├── fundamental -- 财务数据（利润表、资产负债表、现金流）
├── factor      -- 因子与特征
├── macro       -- 宏观数据
├── flow        -- 资金流向（北向、融资融券、个股资金流）
├── concept     -- 概念与行业分类
└── meta        -- 元数据（数据源状态、更新日志）
```

### 3.2 核心表设计

#### market.daily_kline — 日线K线
```sql
CREATE TABLE market.daily_kline (
    ts_code      VARCHAR(12)    NOT NULL,
    trade_date   DATE           NOT NULL,
    open         NUMERIC(12,4),
    high         NUMERIC(12,4),
    low          NUMERIC(12,4),
    close        NUMERIC(12,4),
    pre_close    NUMERIC(12,4),
    change       NUMERIC(12,4),
    pct_chg      NUMERIC(10,4),
    vol          NUMERIC(18,2),
    amount       NUMERIC(18,4),
    PRIMARY KEY (ts_code, trade_date)
) PARTITION BY RANGE (trade_date);
```

#### market.daily_basic — 日线基本面指标
```sql
CREATE TABLE market.daily_basic (
    ts_code        VARCHAR(12)  NOT NULL,
    trade_date     DATE         NOT NULL,
    close          NUMERIC(12,4),
    turnover_rate  NUMERIC(10,4),
    turnover_rate_f NUMERIC(10,4),
    volume_ratio   NUMERIC(10,4),
    pe             NUMERIC(14,4),
    pe_ttm         NUMERIC(14,4),
    pb             NUMERIC(14,4),
    ps             NUMERIC(14,4),
    ps_ttm         NUMERIC(14,4),
    dv_ratio       NUMERIC(10,4),
    dv_ttm         NUMERIC(10,4),
    total_share    NUMERIC(18,4),
    float_share    NUMERIC(18,4),
    free_share     NUMERIC(18,4),
    total_mv       NUMERIC(18,4),
    circ_mv        NUMERIC(18,4),
    PRIMARY KEY (ts_code, trade_date)
) PARTITION BY RANGE (trade_date);
```

#### market.index_ohlc — 指数日线
```sql
CREATE TABLE market.index_ohlc (
    ts_code      VARCHAR(12)  NOT NULL,
    trade_date   DATE         NOT NULL,
    open         NUMERIC(12,4),
    high         NUMERIC(12,4),
    low          NUMERIC(12,4),
    close        NUMERIC(12,4),
    pre_close    NUMERIC(12,4),
    change       NUMERIC(12,4),
    pct_chg      NUMERIC(10,4),
    vol          NUMERIC(18,2),
    amount       NUMERIC(18,4),
    PRIMARY KEY (ts_code, trade_date)
);
```

#### fundamental.income — 利润表
```sql
CREATE TABLE fundamental.income (
    ts_code       VARCHAR(12)  NOT NULL,
    ann_date      DATE,
    f_ann_date    DATE,
    end_date      DATE         NOT NULL,
    report_type   VARCHAR(4),
    comp_type     VARCHAR(4),
    basic_eps     NUMERIC(12,4),
    diluted_eps   NUMERIC(12,4),
    total_revenue NUMERIC(18,4),
    revenue       NUMERIC(18,4),
    total_cogs    NUMERIC(18,4),
    oper_cost     NUMERIC(18,4),
    operate_profit NUMERIC(18,4),
    n_income      NUMERIC(18,4),
    n_income_attr_p NUMERIC(18,4),
    -- 其余字段参考 Tushare income_vip 接口（共84列）
    PRIMARY KEY (ts_code, end_date, report_type)
);
```

#### fundamental.balancesheet — 资产负债表
```sql
CREATE TABLE fundamental.balancesheet (
    ts_code       VARCHAR(12)  NOT NULL,
    ann_date      DATE,
    f_ann_date    DATE,
    end_date      DATE         NOT NULL,
    report_type   VARCHAR(4),
    comp_type     VARCHAR(4),
    total_assets  NUMERIC(18,4),
    total_liab    NUMERIC(18,4),
    total_hldr_eqy_exc_min_int NUMERIC(18,4),
    -- 其余字段参考 Tushare balancesheet_vip 接口（共152列）
    PRIMARY KEY (ts_code, end_date, report_type)
);
```

#### fundamental.cashflow — 现金流量表
```sql
CREATE TABLE fundamental.cashflow (
    ts_code       VARCHAR(12)  NOT NULL,
    ann_date      DATE,
    f_ann_date    DATE,
    end_date      DATE         NOT NULL,
    report_type   VARCHAR(4),
    comp_type     VARCHAR(4),
    n_cashflow_act NUMERIC(18,4),
    n_cashflow_inv_act NUMERIC(18,4),
    n_cash_flows_fnc_act NUMERIC(18,4),
    -- 其余字段参考 Tushare cashflow_vip 接口（共97列）
    PRIMARY KEY (ts_code, end_date, report_type)
);
```

#### fundamental.fina_indicator — 财务指标
```sql
CREATE TABLE fundamental.fina_indicator (
    ts_code       VARCHAR(12)  NOT NULL,
    ann_date      DATE,
    end_date      DATE         NOT NULL,
    roe           NUMERIC(12,4),
    roa           NUMERIC(12,4),
    grossprofit_margin NUMERIC(12,4),
    netprofit_margin   NUMERIC(12,4),
    debt_to_assets     NUMERIC(12,4),
    current_ratio      NUMERIC(12,4),
    quick_ratio        NUMERIC(12,4),
    -- 其余字段参考 Tushare fina_indicator_vip 接口（共109列）
    PRIMARY KEY (ts_code, end_date)
);
```

#### fundamental.dividend — 分红送股
```sql
CREATE TABLE fundamental.dividend (
    ts_code       VARCHAR(12)  NOT NULL,
    end_date      DATE         NOT NULL,
    ann_date      DATE,
    div_proc      VARCHAR(20),
    stk_div       NUMERIC(12,6),
    stk_bo_rate   NUMERIC(12,6),
    stk_co_rate   NUMERIC(12,6),
    cash_div      NUMERIC(12,6),
    cash_div_tax  NUMERIC(12,6),
    record_date   DATE,
    ex_date       DATE,
    pay_date      DATE,
    div_listdate  DATE,
    PRIMARY KEY (ts_code, end_date, div_proc)
);
```

#### flow.northbound_flow — 北向资金流向
```sql
CREATE TABLE flow.northbound_flow (
    trade_date     DATE PRIMARY KEY,
    ggt_ss         NUMERIC(18,4),
    ggt_sz         NUMERIC(18,4),
    hgt            NUMERIC(18,4),
    sgt            NUMERIC(18,4),
    north_money    NUMERIC(18,4),
    south_money    NUMERIC(18,4)
);
```

#### flow.margin — 融资融券
```sql
CREATE TABLE flow.margin (
    trade_date   DATE         NOT NULL,
    exchange_id  VARCHAR(10)  NOT NULL,
    rzye         NUMERIC(18,4),
    rzmre        NUMERIC(18,4),
    rzche        NUMERIC(18,4),
    rqye         NUMERIC(18,4),
    rqmcl        NUMERIC(18,4),
    rzrqye       NUMERIC(18,4),
    rqylje       NUMERIC(18,4),
    PRIMARY KEY (trade_date, exchange_id)
);
```

#### flow.moneyflow — 个股资金流向
```sql
CREATE TABLE flow.moneyflow (
    ts_code        VARCHAR(12)  NOT NULL,
    trade_date     DATE         NOT NULL,
    buy_sm_vol     NUMERIC(18,2),
    buy_sm_amount  NUMERIC(18,4),
    sell_sm_vol    NUMERIC(18,2),
    sell_sm_amount NUMERIC(18,4),
    buy_md_vol     NUMERIC(18,2),
    buy_md_amount  NUMERIC(18,4),
    sell_md_vol    NUMERIC(18,2),
    sell_md_amount NUMERIC(18,4),
    buy_lg_vol     NUMERIC(18,2),
    buy_lg_amount  NUMERIC(18,4),
    sell_lg_vol    NUMERIC(18,2),
    sell_lg_amount NUMERIC(18,4),
    buy_elg_vol    NUMERIC(18,2),
    buy_elg_amount NUMERIC(18,4),
    sell_elg_vol   NUMERIC(18,2),
    sell_elg_amount NUMERIC(18,4),
    net_mf_vol     NUMERIC(18,2),
    net_mf_amount  NUMERIC(18,4),
    PRIMARY KEY (ts_code, trade_date)
) PARTITION BY RANGE (trade_date);
```

#### concept.ths_index — 同花顺概念指数
```sql
CREATE TABLE concept.ths_index (
    ts_code    VARCHAR(20)  PRIMARY KEY,
    name       VARCHAR(100),
    count      INTEGER,
    exchange   VARCHAR(10),
    list_date  DATE,
    type       VARCHAR(10)
);
```

#### concept.ths_daily — 概念日线
```sql
CREATE TABLE concept.ths_daily (
    ts_code      VARCHAR(20)  NOT NULL,
    trade_date   DATE         NOT NULL,
    open         NUMERIC(12,4),
    high         NUMERIC(12,4),
    low          NUMERIC(12,4),
    close        NUMERIC(12,4),
    pct_change   NUMERIC(10,4),
    vol          NUMERIC(18,2),
    turnover_rate NUMERIC(10,4),
    total_mv     NUMERIC(18,4),
    float_mv     NUMERIC(18,4),
    pe            NUMERIC(14,4),
    PRIMARY KEY (ts_code, trade_date)
);
```

#### concept.sw_industry — 申万行业分类
```sql
CREATE TABLE concept.sw_industry (
    index_code   VARCHAR(20)  PRIMARY KEY,
    industry_name VARCHAR(100),
    level        VARCHAR(4),
    src          VARCHAR(10)
);
```

#### concept.sw_index_member — 行业成分股
```sql
CREATE TABLE concept.sw_index_member (
    index_code   VARCHAR(20)  NOT NULL,
    index_name   VARCHAR(100),
    con_code     VARCHAR(12)  NOT NULL,
    con_name     VARCHAR(100),
    in_date      DATE,
    out_date     DATE,
    PRIMARY KEY (index_code, con_code)
);
```

#### macro.sw_valuation — 申万行业估值
```sql
CREATE TABLE macro.sw_valuation (
    trade_date   DATE         NOT NULL,
    index_code   VARCHAR(20)  NOT NULL,
    name         VARCHAR(100),
    pe           NUMERIC(14,4),
    pb           NUMERIC(14,4),
    float_share  NUMERIC(18,4),
    total_mv     NUMERIC(18,4),
    float_mv     NUMERIC(18,4),
    turnover_rate NUMERIC(10,4),
    pct_change   NUMERIC(10,4),
    vol          NUMERIC(18,2),
    amount       NUMERIC(18,4),
    PRIMARY KEY (trade_date, index_code)
);
```

#### macro.yield_curve — 国债收益率
```sql
CREATE TABLE macro.yield_curve (
    trade_date   DATE         NOT NULL,
    curve_type   VARCHAR(20)  NOT NULL,
    curve_term   NUMERIC(6,2) NOT NULL,
    yield        NUMERIC(10,6),
    PRIMARY KEY (trade_date, curve_type, curve_term)
);
```

#### macro.cn_macro — 宏观经济指标（CPI/PPI/PMI）
```sql
CREATE TABLE macro.cn_macro (
    month        VARCHAR(10)  NOT NULL,
    indicator    VARCHAR(20)  NOT NULL,
    nt_val       NUMERIC(12,4),
    nt_yoy       NUMERIC(10,4),
    nt_mom       NUMERIC(10,4),
    nt_accu      NUMERIC(12,4),
    PRIMARY KEY (month, indicator)
);
```

#### meta.data_sync_log — 数据同步日志
```sql
CREATE TABLE meta.data_sync_log (
    id           SERIAL PRIMARY KEY,
    task_name    VARCHAR(50)  NOT NULL,
    start_date   DATE,
    end_date     DATE,
    record_count INTEGER,
    status       VARCHAR(20),
    error_msg    TEXT,
    created_at   TIMESTAMP DEFAULT NOW()
);
```

---

## 4. 分区策略

大表按年分区，减少查询扫描范围：

```sql
-- daily_kline 按年分区示例
CREATE TABLE market.daily_kline_2016 PARTITION OF market.daily_kline
    FOR VALUES FROM ('2016-01-01') TO ('2017-01-01');
CREATE TABLE market.daily_kline_2017 PARTITION OF market.daily_kline
    FOR VALUES FROM ('2017-01-01') TO ('2018-01-01');
-- ... 2018-2026
```

需要分区的表：
- `market.daily_kline` — 720万+ 行
- `market.daily_basic` — 720万+ 行
- `flow.moneyflow` — 97万+ 行（按成分股，后续全市场会更大）

---

## 5. 索引策略

```sql
-- 按股票代码查询（选股场景）
CREATE INDEX idx_daily_kline_ts_code ON market.daily_kline (ts_code);
CREATE INDEX idx_daily_basic_ts_code ON market.daily_basic (ts_code);

-- 按日期查询（回测场景）
CREATE INDEX idx_daily_kline_trade_date ON market.daily_kline (trade_date);
CREATE INDEX idx_daily_basic_trade_date ON market.daily_basic (trade_date);

-- 财务数据按公告日期查询（避免未来数据泄露）
CREATE INDEX idx_income_ann_date ON fundamental.income (ann_date);
CREATE INDEX idx_balancesheet_ann_date ON fundamental.balancesheet (ann_date);
CREATE INDEX idx_fina_indicator_ann_date ON fundamental.fina_indicator (ann_date);
```

---

## 6. 数据迁移方案

### 6.1 迁移流程

```
parquet 文件 → pandas.read_parquet() → DataFrame → to_sql() → PostgreSQL
```

### 6.2 迁移脚本设计

```python
# db/dml/migrate_parquet_to_pg.py
# 1. 读取 parquet
# 2. 字段类型转换（trade_date: str → date）
# 3. 批量 UPSERT（ON CONFLICT DO UPDATE）
# 4. 记录同步日志
```

### 6.3 增量更新

下载器写入数据库而非 parquet：
```python
# tushare_downloader.py 改造
# 原: df.to_parquet(output_path)
# 新: df.to_sql(table, engine, if_exists='append', method='multi')
#     + ON CONFLICT 去重
```

---

## 7. 与现有系统的兼容

迁移期间保持双写（parquet + DB），通过配置切换读取源：

```yaml
# config/data_source.yaml
storage:
  backend: parquet  # parquet | postgresql
  postgresql:
    host: localhost
    port: 5432
    database: sage_db
    user: sage
    password: ${SAGE_DB_PASSWORD}
```

---

## 8. 容量估算

| 表 | 预估行数 | 预估大小 |
|---|---|---|
| daily_kline | 720万 | ~1.5 GB |
| daily_basic | 720万 | ~2 GB |
| fina_indicator | 62万 | ~500 MB |
| income | 19万 | ~200 MB |
| moneyflow | 97万 | ~300 MB |
| 其他 | - | ~500 MB |
| **合计** | - | **~5 GB** |

PostgreSQL 轻松承载，无需分库。

---

## 9. 实施路线

1. Docker Compose 部署 PostgreSQL
2. 执行 DDL 建表
3. 编写迁移脚本，parquet → DB
4. 改造 data_provider 支持 DB 读取
5. 改造 downloader 支持 DB 写入
6. 验证回测结果一致性
7. 下线 parquet 双写

---

**最后更新**：2026-02-19
