# Sage股票智能交易平台特征与标签模块设计文档

## 1. 模块定位
统一特征计算、标签生成与特征版本管理，避免数据泄露。

---

## 2. 特征类型
- 动量因子  
- 质量因子（ROE/毛利率等）  
- 流动性因子  
- 风险因子（波动率/回撤）  

## 2.1 特征清单（MVP v1）
**排序模型特征（来自 `RankModelLGBM`）**：
- 动量类：`return_4d`, `return_12d`, `return_20d`
- 均线比：`ma_ratio_4d`, `ma_ratio_12d`, `ma_ratio_20d`
- 流动性：`turnover_4d_mean`, `turnover_4d_std`, `turnover_ratio_4d`
- 流动性：`turnover_12d_mean`, `turnover_12d_std`, `turnover_ratio_12d`
- 稳定性：`volatility_4d`, `volatility_12d`
- 价格波动：`price_std_4d`, `price_std_12d`
- 技术指标：`rsi_14`, `macd`, `macd_signal`, `bollinger_upper`, `bollinger_lower`

**趋势模型特征（来自 `MarketFeatures/TrendModel`）**：
- `ma_20`, `ma_60`, `ma_120`
- `ret_4w`, `ret_12w`
- `vol_4w`, `vol_12w`
- `trend_strength`, `vol_ratio`
- `max_dd_20d`, `drawdown_count`, `atr`

---

## 3. 标签定义（已确认）
### 3.0 多周期标签（确认）
- 未来20/60/120日收益  
- 行业内 rank  
- 任务类型：回归排序  

### 3.1 标签构造示意
```
future_return_h = close.shift(-h) / close - 1  # h in [20,60,120]
rank_label_h = future_return_h.rank(pct=True, group=industry)
```

---

## 4. 防数据泄露
- 使用未来收益时必须 shift  
- 财报/公告/北向数据按 **T+2** 延迟  

---

## 5. 输出落地（建议）
- `data/features/features_<YYYYMMDD>.parquet`
- `data/features/labels_<YYYYMMDD>.parquet`

---

## 5. 与现有代码映射
- `ml_stock_forecast/features/*`
- `ml_stock_forecast/models/rank_model.py`  

---

## Q&A
- Q: 是否引入更多因子（宏观/情绪）？  
  A: 后续按需求扩展。
