# 选股模型回测报告

> 生成日期：2026-02-18（宏观Regime标签重训后重跑）
> 模型版本：P6修复 + 宏观Regime标签训练（训练用人工划分的宏观市场阶段，推理用趋势模型实时判断）

## 1. 回测设置

| 参数 | 值 |
|------|-----|
| 持仓周期 | 20个交易日（月度调仓） |
| 每期选股 | Top 30 等权 |
| 模型类型 | LightGBM（行业中性化标签） |
| IC筛选 | 阈值0.02, IC_IR≥0.3, hit_rate≥55% |
| 标签周期 | (10d, 20d)，权重(0.4, 0.6) |
| 基准 | 沪深300指数 |

### 策略说明

| 策略 | 说明 |
|------|------|
| 单一模型 | 全市场统一训练一个LightGBM，始终满仓Top30 |
| Regime模型 | 按宏观市场阶段(bull/bear/neutral)分别训练专家模型，推理时用趋势模型判断当前状态选对应模型打分，始终满仓Top30 |
| 趋势+单一 | 单一模型选股 + 趋势模型仓位联动（bull=100%, neutral=60%, bear=30%） |
| 趋势+Regime | Regime模型选股 + 趋势模型仓位联动 |

---

## 2. 回测结果汇总

### 2.1 区间一：2021-02 ~ 2024-02（熊市主导）

训练数据：2020年（仅1年）

| 策略 | 累计收益 | Sharpe | 最大回撤 | 胜率 | 期数 |
|------|---------|--------|---------|------|------|
| **单一模型** | **+2.43%** | 0.13 | -16.00% | 45.9% | 37 |
| **Regime模型** | **+9.14%** | 0.28 | -13.00% | 48.6% | 37 |
| 趋势+单一 | +2.73% | 0.18 | -5.90% | 45.9% | 37 |
| **趋势+Regime** | **+9.45%** | **0.51** | **-4.27%** | 48.6% | 37 |
| 沪深300 | -40.61% | — | — | — | — |

**分Regime表现（每期平均收益）：**

| 市场状态 | 单一模型 | Regime模型 | 趋势+单一 | 趋势+Regime | 期数 |
|---------|---------|-----------|----------|------------|------|
| bull | -0.07% | +2.06% | -0.07% | +2.06% | 3 |
| neutral | +0.43% | +0.43% | +0.26% | +0.26% | 14 |
| bear | -0.02% | -0.02% | -0.01% | -0.01% | 20 |

### 2.2 区间二：2024-09 ~ 2026-01（牛市主导）

训练数据：2020~2024年（5年）

| 策略 | 累计收益 | Sharpe | 最大回撤 | 胜率 | 期数 |
|------|---------|--------|---------|------|------|
| **单一模型** | +61.60% | 1.70 | -10.51% | 75.0% | 16 |
| **Regime模型** | **+80.69%** | **1.95** | -10.33% | 75.0% | 16 |
| 趋势+单一 | +18.38% | 1.17 | -6.31% | 75.0% | 16 |
| 趋势+Regime | +24.13% | 1.65 | -6.20% | 75.0% | 16 |
| 沪深300 | +44.88% | — | — | — | — |

**分Regime表现（每期平均收益）：**

| 市场状态 | 单一模型 | Regime模型 | 趋势+单一 | 趋势+Regime | 期数 |
|---------|---------|-----------|----------|------------|------|
| bull | +0.22% | +0.34% | +0.22% | +0.34% | 6 |
| neutral | +0.73% | +0.98% | +0.44% | +0.59% | 6 |
| bear | +11.66% | +14.10% | +3.50% | +4.23% | 4 |

---

## 3. 关键发现

### 3.1 选股Alpha有效性
- **两个区间均跑赢沪深300**：熊市区间超额约43%（+2.43% vs -40.61%），牛市区间超额约17%（+61.60% vs +44.88%）
- 单一模型在极端熊市（2021-2024）中实现了+2.43%正收益，而同期沪深300暴跌40%，说明选股因子具备防御能力

### 3.2 训练数据量的影响
- 2021-02区间仅用2020年1年数据训练，模型在第2轮即早停（几乎没学到有效模式），score几乎无分化
- 2024-09区间用5年数据训练，模型训练到342轮，score有明显分化，效果显著更好
- **结论：训练数据至少需要3年以上**

### 3.3 趋势仓位联动的价值
- **回撤控制显著**：趋势联动将最大回撤从-16.00%降至-5.90%（熊市区间），从-10.51%降至-6.31%（牛市区间）
- **熊市区间将亏损转为盈利**：单一模型+2.43% → 趋势+单一+2.73%，Sharpe从0.13提升至0.18
- **牛市区间牺牲收益换回撤**：+61.60% → +18.38%，因为bear状态仅30%仓位但实际收益+11.66%/期
- **结论：趋势联动适合风险厌恶型配置，需优化bear状态的仓位比例**

### 3.4 ⭐ P6修复：Score坍缩bug（2026-02-18）

**问题**：此前回测中 `predict()` 接收单日数据，时序特征（pct_change/rolling）全部为NaN，填充后所有股票分数一致，选股实质为随机排序。此前报告中的 +102% Regime模型等数据均不可信。

**修复**：新增 `predict_prepared()` 方法，先对全量数据预计算特征，循环中按日期切片直接预测。

**修复后真实结果（区间二）：**

| 策略 | 修复前(随机选股) | 修复后(真实) | 说明 |
|------|----------------|-------------|------|
| 单一模型 | +76.04% | **+61.60%** | 收益下降但仍跑赢基准 |
| Regime模型 | +102.20% | **+80.69%** | 宏观标签训练后大幅提升 |
| 趋势+Regime | +29.96% | **+24.13%** | Sharpe 1.65 |

**新发现**：
- Regime模型收益（+80.69%）大幅超越单一模型（+61.60%），Sharpe 1.95 vs 1.70
- Regime所有状态均优于单一模型：bull期+0.34% vs +0.22%，neutral期+0.98% vs +0.73%，bear期+14.10% vs +11.66%
- 宏观标签训练是关键改进（见3.7节）

### 3.5 趋势模型配置敏感性（已失效）

> ⚠️ 此节数据基于P6修复前的随机选股结果，不再有效。配置敏感性需在P6修复后重新评估。

### 3.6 Regime训练样本分布问题（已解决）

2020-2024训练期样本分布（基于沪深300趋势标签）：

| 状态 | 天数 | 占比 | 主要来源年份 |
|------|------|------|-------------|
| bear | 509 | 44.1% | 2022(163), 2023(148) |
| neutral | 401 | 34.7% | 2021(107), 2024(95) |
| bull | 245 | 21.2% | 2020(111), 2024(72) |

**核心问题**：趋势模型标签噪声严重（如2023Q1被标为bull，实际是深度熊市），导致专家模型学到错误模式。

**解决方案**：改用宏观级别人工划分标签训练（见3.7节），趋势模型仅用于推理时实时状态判断。

### 3.7 ⭐ 宏观Regime标签训练（2026-02-18）

**问题诊断**：趋势模型对短期反弹过度敏感，生成的regime标签碎片化且与宏观市场阶段不匹配。三个专家模型因标签噪声收敛到相同策略（均以pb_percentile为主导特征）。

**方案（Plan 3）**：训练用人工划分的宏观市场阶段，推理用趋势模型实时判断。

宏观阶段划分：
| 阶段 | 时间 | 标签 | 沪深300涨幅 |
|------|------|------|------------|
| 牛市 | 2020.01~2021.02 | bull | +28.5% |
| 熊市 | 2021.03~2023.12 | bear | -36.7% |
| 震荡 | 2024.01~2024.08 | neutral | -1.9% |
| 牛市 | 2024.09~ | bull | +41.8% |

**效果对比（Regime模型，宏观标签 vs 趋势标签）：**

| 区间 | 趋势标签 | 宏观标签 | 提升 |
|------|---------|---------|------|
| 熊市区间 | -10.82% | **+9.14%** | +20pp |
| 牛市区间 | +54.94% | **+80.69%** | +26pp |

---

## 4. 已知局限

1. **无交易成本**：未扣除佣金（万2.5）、印花税（千1）、滑点，实际收益会降低约3~5%/年
2. **无涨跌停/停牌处理**：假设所有股票均可自由买卖
3. **无T+1限制**：假设当日买入次日即可卖出
4. **等权配置**：未考虑市值加权或波动率加权
5. **训练数据不滚动**：每个区间只训练一次，未做Walk-Forward滚动重训

---

## 5. 后续优化方向

1. **趋势仓位参数优化**：bear状态30%仓位过于保守，可调整为50%
2. **Walk-Forward滚动重训**：每3~6个月重训模型，适应市场变化
3. **交易成本纳入**：扣除真实成本后评估净收益
4. **多策略融合**：结合动量/价值/质量因子的多策略组合
5. **止损机制**：个股ATR动态止损 + 组合层面回撤降仓
