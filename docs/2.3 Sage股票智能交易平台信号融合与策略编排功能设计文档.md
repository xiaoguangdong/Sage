# Sage股票智能交易平台信号融合与策略编排功能设计文档

## 1. 功能定位
该功能负责将 **宏观/趋势/主线/选股/买卖点** 等模块结果统一融合为可执行的组合信号，输出仓位与风控建议。

---

## 2. 输入 / 输出
**输入**：
- 宏观模型输出（行业景气度、场景、置信度）
- 趋势状态输出（RISK_ON/OFF/NEUTRAL）
- 主线/行业轮动得分
- 选股排序结果（score/rank）
- 买卖点过滤结果（规则/模型）
- LLM/NLP信号（政策/产业/概念：主题/情绪/风险标签）
- 风控约束（仓位上限、行业暴露）

**输出**：
```json
{
  "date": "2026-02-13",
  "state": "RISK_ON",
  "positions": [
    {"ts_code": "600519.SH", "weight": 0.08, "action": "BUY"}
  ],
  "risk_flags": ["行业集中度偏高"]
}
```

**输出落地（建议）**：
- `data/portfolio/positions_<YYYYMMDD>.parquet`
- 字段：`trade_date/ts_code/weight/action/risk_flags`

---

## 3. 融合规则（优先级）
1. **趋势门控**：RISK_OFF → 空仓  
2. **宏观过滤**：仅保留景气度 TopN 行业  
3. **主线加权**：行业主线分高 → 权重上调  
4. **选股排序**：行业内 TopK  
5. **买卖点过滤**：规则/模型通过  
6. **LLM仅作为加权/过滤**：不得单独触发交易  
6. **风险裁剪**：单股/行业/总仓位限制  

### 3.1 冲突处理原则
- 信号冲突时以“风险优先”原则裁决  
- LLM信号仅加权，不可改变趋势门控  

---

## 4. 信号评分（示意）
```
final_score = w1*rank_score + w2*macro_conf + w3*mainline_score
```
权重可配置，并随市场状态调整。

### 4.1 流程图（Mermaid）
```mermaid
flowchart LR
  A["宏观/趋势/主线/排序/买卖点/LLM"] --> B["规则优先级融合"]
  B --> C["风险裁剪"]
  C --> D["组合输出"]
```

---

## 5. 模块扩展
- 策略注册机制：`StrategyRegistry`
- 多策略并行：支持融合或优先级裁决
- 模块替换：规则/树模型可插拔

---

## 6. 测试
- 单元测试：规则优先级与裁剪逻辑  
- 集成测试：多模块输入联动  

---

## Q&A
- Q: 多策略冲突时如何裁决？  
  A: 待确认（优先级 / 加权融合）。
 趋势第一位，买卖点第二位，主线第三位，股票第四位，宏观第四位
- Q: 输出包含“建议换手率/调仓频率”吗？  
  A: 需要
- Q: LLM信号来源（政策/公告/研报/舆情）与频率？  
  A: TODOLIST
