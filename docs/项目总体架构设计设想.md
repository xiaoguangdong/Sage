# 项目总体架构设计设想

## 一、概述

本项目是一个综合性的量化交易系统，通过多层次、多维度的方式，结合宏观基本面、市场趋势、概念板块和个股选择，实现对股市结构性行情的精准捕捉，并提供买卖交易决策支持。

### 1.1 核心理念

**"宏观定方向，趋势择时，结构选股，交易执行"**

- **宏观模型**：定方向，识别哪些行业具有宏观机会
- **趋势模型**：择时，判断当前市场环境（牛市/熊市/震荡）
- **选股模型**：选结构，结合宏观、趋势、概念，筛选结构性行情
- **买卖模型**：执行，给出具体的买卖时机和仓位管理

### 1.2 系统目标

1. **降低风险**：通过多层次判断，降低投资风险
2. **提高胜率**：结合多个维度的信息，提高预测准确率
3. **捕捉结构性行情**：在分化市场中，识别强势板块和个股
4. **提供决策支持**：给出清晰的买卖信号和仓位建议

---

## 二、系统架构图

### 2.1 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         数据层                                   │
├─────────────────────────────────────────────────────────────────┤
│  宏观数据   行业数据   个股数据   资金数据   概念板块数据           │
│  (NBS)    (Tushare)  (Tushare)  (Tushare)   (Tushare/Eastmoney)  │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       处理层                                     │
├─────────────────────────────────────────────────────────────────┤
│  数据清洗    特征工程    数据对齐    持久化存储                    │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       模型层                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  宏观模型     │  │  趋势模型     │  │  选股模型     │          │
│  │  (行业机会)   │  │  (市场环境)   │  │  (结构行情)   │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                 │                 │                    │
│         └─────────────────┴─────────────────┘                    │
│                           │                                      │
│                           ▼                                      │
│                  ┌──────────────┐                               │
│                  │  买卖模型     │                               │
│                  │  (交易执行)   │                               │
│                  └──────────────┘                               │
│                                                                  │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       应用层                                     │
├─────────────────────────────────────────────────────────────────┤
│  信号生成    报告输出    可视化    回测系统    风险控制             │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流图

```
                    ┌─────────────────┐
                    │   数据采集       │
                    │  (多数据源)      │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  宏观数据     │   │  行业/个股数据 │   │  概念/资金数据 │
│  - CPI/PPI    │   │  - 财报数据    │   │  - 概念列表    │
│  - PMI        │   │  - K线数据     │   │  - 成分股      │
│  - 社融        │   │  - 行业分类    │   │  - 北向资金    │
│  - FAI        │   │  - 估值数据    │   │  - 换手率      │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
                    ┌─────────────────┐
                    │   数据清洗       │
                    │   特征工程       │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  宏观模型     │   │  趋势模型     │   │  概念模型     │
│  - 行业景气度  │   │  - 市场状态   │   │  - 概念热度    │
│  - 复苏判断    │   │  - 趋势方向   │   │  - 主线识别    │
│  - 估值位置    │   │  - 波动率     │   │  - 持续性      │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
                    ┌─────────────────┐
                    │    选股模型      │
                    │  - 行业筛选      │
                    │  - 概念筛选      │
                    │  - 个股评分      │
                    │  - 组合构建      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   买卖模型      │
                    │  - 买入信号      │
                    │  - 卖出信号      │
                    │  - 仓位管理      │
                    │  - 风险控制      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   输出结果       │
                    │  - 推荐列表      │
                    │  - 买卖信号      │
                    │  - 仓位建议      │
                    │  - 风险提示      │
                    └─────────────────┘
```

---

## 三、核心模块详解

### 3.1 宏观模型

#### 3.1.1 功能定位
**定方向**：识别哪些行业在宏观层面具有投资机会。

#### 3.1.2 输入数据
- **国家统计局数据**：
  - CPI（居民消费价格指数）
  - PPI（工业生产者出厂价格指数）
  - PMI（采购经理指数）
  - 固定资产投资（分行业）
  - 分行业PPI
  - 工业增加值
  - 主要工业品产量
- **Tushare宏观数据**：
  - 社融存量
  - M1/M2
  - 10年期国债收益率
  - 期限利差

#### 3.1.3 输出结果
- **行业景气度评分**：每个行业的景气度得分（0-100）
- **行业场景分类**：
  - 复苏（RECOVERY）
  - 大涨（BOOM）
  - 衰退（RECESSION）
  - 震荡（NEUTRAL）
- **行业机会列表**：Top N 个具有宏观机会的行业
- **估值位置**：每个行业的估值分位数

#### 3.1.4 核心逻辑
```
1. 获取NBS数据（月度）
2. 获取Tushare宏观数据（月度/日度）
3. 行业映射（NBS行业 → 申万行业）
4. 计算行业指标：
   - PPI分项变化
   - 固定资产投资增速
   - 库存周期（存货/营收）
   - 估值位置（PB/PE分位）
5. 场景分类：
   - 判断行业处于哪个场景
   - 计算置信度
6. 输出机会列表
```

#### 3.1.5 预测场景
| 场景 | 触发条件 | 投资建议 |
|------|----------|----------|
| 复苏 | PPI回升 + 库存出清 + 估值合理 | 建议配置，左侧布局 |
| 大涨 | 估值极高 + 换手率高 + 动量强 | 谨慎持有，准备止盈 |
| 衰退 | 价格暴跌 + 扩产停止 + 盈利恶化 | 规避风险 |
| 震荡 | 其他情况 | 观望等待 |

---

### 3.2 趋势模型

#### 3.2.1 功能定位
**择时**：判断当前市场环境（牛市/熊市/震荡），决定整体仓位。

#### 3.2.2 输入数据
- **指数数据**：
  - 沪深300指数（000300.SH）
  - 中证500指数（000905.SH）
  - 中证1000指数（000852.SH）
  - 创业板指数（399006.SZ）
- **市场情绪指标**：
  - 成交量
  - 换手率
  - 融资融券余额
  - 北向资金净流入
- **波动率指标**：
  - 历史波动率
  - VIX/IVIX（如果有）

#### 3.2.3 输出结果
- **市场状态**：牛市、熊市、震荡
- **趋势方向**：上升、下降、横盘
- **波动率水平**：低、中、高
- **建议仓位**：0-100%
- **风险等级**：低、中、高

#### 3.2.4 核心逻辑
```
1. 获取指数数据（日度）
2. 计算技术指标：
   - 均线系统（MA20/MA60/MA120）
   - 趋势强度（ADX）
   - 相对强度（RPS）
   - 波动率
3. 市场环境判断：
   - 牛市：MA20>MA60>MA120，成交放大
   - 熊市：MA20<MA60<MA120，成交萎缩
   - 震荡：均线缠绕，成交平稳
4. 仓位建议：
   - 牛市：80-100%仓位
   - 震荡：30-70%仓位
   - 熊市：0-30%仓位
5. 输出市场环境报告
```

#### 3.2.5 市场状态分类
| 状态 | 特征 | 建议仓位 | 操作策略 |
|------|------|----------|----------|
| 牛市 | 均线多头排列，成交放大 | 80-100% | 积极进攻，持股待涨 |
| 震荡 | 均线缠绕，成交平稳 | 30-70% | 高抛低吸，精选个股 |
| 熊市 | 均线空头排列，成交萎缩 | 0-30% | 防御为主，控制风险 |

---

### 3.3 选股模型

#### 3.3.1 功能定位
**选结构**：结合宏观模型、趋势模型和当前热门概念，筛选具有结构性行情的概念和行业，选出优质个股。

#### 3.3.2 输入数据
- **宏观模型输出**：
  - 行业机会列表
  - 行业景气度评分
  - 行业场景分类
- **趋势模型输出**：
  - 市场状态
  - 建议仓位
  - 趋势方向
- **概念板块数据**：
  - 概念列表（Tushare 879个概念 / 东方财富 5000个概念）
  - 概念成分股
  - 概念K线
  - 概念换手率
  - 概念涨跌幅
- **个股数据**：
  - 财报数据（营收、净利润、ROE等）
  - 估值数据（PE、PB、PS等）
  - 技术指标（动量、趋势等）
  - 资金流向（主力资金、北向资金等）

#### 3.3.3 输出结果
- **推荐概念列表**：Top N 个推荐概念
- **推荐行业列表**：Top N 个推荐行业
- **推荐股票列表**：每个概念/行业推荐 Top N 只股票
- **综合评分**：每只股票的综合得分
- **风险提示**：潜在风险点

#### 3.3.4 核心逻辑
```
1. 获取宏观模型输出
   - 优先选择宏观模型推荐行业
2. 获取趋势模型输出
   - 根据市场状态调整筛选标准
   - 牛市：激进筛选
   - 熊市：保守筛选
3. 概念板块分析
   - 计算概念热度（涨跌幅、换手率、涨停家数）
   - 识别主线概念（持续性、扩散性、拥挤度）
   - 筛选活跃概念（Top N）
4. 个股筛选（在推荐概念/行业内）
   - 基本面筛选（成长、质量、估值）
   - 技术面筛选（动量、趋势）
   - 资金面筛选（主力资金、北向资金）
5. 综合评分
   - 加权评分（基本面40% + 技术面30% + 资金面30%）
6. 输出推荐列表
```

#### 3.3.5 评分体系

**个股五维评分**：
| 维度 | 权重 | 指标 |
|------|------|------|
| 成长性 | 25% | 营收增速、净利润增速、ROE |
| 质量性 | 20% | 毛利率、净利率、现金流 |
| 估值空间 | 25% | PE分位、PB分位、PEG |
| 价格结构 | 15% | 相对强度、动量、位置 |
| 流动性 | 15% | 换手率、主力资金、北向资金 |

**概念五维评分**：
| 维度 | 权重 | 指标 |
|------|------|------|
| 领涨强度 | 30% | 涨跌幅、涨幅领先程度 |
| 扩散速度 | 25% | 上涨股票占比、持续性 |
| 持续性 | 20% | 上榜次数、稳定性 |
| 兑现度 | 15% | 业绩兑现能力 |
| 拥挤度 | 10% | 换手率、成交额 |

---

### 3.4 买卖模型

#### 3.4.1 功能定位
**执行**：给出具体的买卖时机和仓位管理建议。

#### 3.4.2 输入数据
- **选股模型输出**：
  - 推荐股票列表
  - 每只股票的综合评分
- **个股数据**：
  - 实时K线
  - 技术指标
  - 资金流向
  - 成交量
- **市场数据**：
  - 大盘走势
  - 板块走势
  - 整体风险水平

#### 3.4.3 输出结果
- **买入信号**：
  - 买入时机（精确到日）
  - 建议价格
  - 建议仓位
  - 止损价格
  - 目标价格
- **卖出信号**：
  - 卖出时机（精确到日）
  - 卖出原因
  - 卖出比例
- **持仓管理**：
  - 加仓信号
  - 减仓信号
  - 止损执行

#### 3.4.4 核心逻辑
```
1. 买入信号判断
   - 技术面：趋势向上、突破关键位
   - 资金面：主力资金流入、北向资金增持
   - 基本面：业绩改善、估值合理
   - 市场面：大盘稳定、板块强势
   - 综合判断：多维度共振 → 买入信号

2. 卖出信号判断
   - 止损：跌破止损价
   - 止盈：达到目标价
   - 趋势反转：技术面转弱
   - 基本面恶化：业绩不及预期
   - 风险控制：大盘风险过高

3. 仓位管理
   - 根据市场状态调整总仓位
   - 根据个股评分分配仓位
   - 分批建仓/减仓
   - 动态调整

4. 输出买卖建议
```

#### 3.4.5 买卖信号分类

**买入信号**：
| 类型 | 触发条件 | 操作建议 |
|------|----------|----------|
| 强买入 | 多维度共振，高置信度 | 满仓买入 |
| 买入 | 多个指标支持，中等置信度 | 分批买入 |
| 观察 | 部分指标支持，低置信度 | 小仓位试探 |

**卖出信号**：
| 类型 | 触发条件 | 操作建议 |
|------|----------|----------|
| 止损 | 跌破止损价 | 全部卖出 |
| 止盈 | 达到目标价 | 分批卖出 |
| 趋势反转 | 技术面转弱 | 逐步减仓 |
| 基本面恶化 | 业绩不及预期 | 清仓离场 |

---

## 四、模块间协作

### 4.1 协作流程

```
1. 宏观模型（月度运行）
   ↓ 输出：行业机会列表
2. 趋势模型（日度运行）
   ↓ 输出：市场状态、建议仓位
3. 选股模型（日度/周度运行）
   ↓ 输入：宏观机会 + 趋势状态 + 概念热度
   ↓ 输出：推荐股票列表
4. 买卖模型（日度运行）
   ↓ 输入：推荐股票 + 实时数据
   ↓ 输出：买卖信号、仓位建议
```

### 4.2 数据流转

```
宏观数据 → 宏观模型 → 行业机会 → 选股模型
                          ↓
指数数据 → 趋势模型 → 市场状态 → 选股模型
                          ↓
概念数据 → 概念分析 → 概念热度 → 选股模型
                          ↓
个股数据 → 选股模型 → 推荐股票 → 买卖模型 → 交易信号
```

### 4.3 决策树

```
开始
  │
  ├─ 趋势模型：判断市场状态
  │   ├─ 熊市 → 降低仓位，保守策略
  │   ├─ 震荡 → 适中仓位，精选个股
  │   └─ 牛市 → 提高仓位，积极进攻
  │
  ├─ 宏观模型：识别行业机会
  │   └─ 输出：行业机会列表
  │
  ├─ 概念分析：识别主线概念
  │   └─ 输出：活跃概念列表
  │
  ├─ 选股模型：筛选优质个股
  │   ├─ 在机会行业内筛选
  │   ├─ 在活跃概念内筛选
  │   └─ 综合评分排序
  │   └─ 输出：推荐股票列表
  │
  └─ 买卖模型：执行交易
      ├─ 买入信号 → 建仓
      ├─ 持仓管理 → 加仓/减仓
      └─ 卖出信号 → 止盈/止损
```

---

## 五、风险控制

### 5.1 多层次风控

#### 5.1.1 市场级别风控
- **趋势模型判断**：熊市降低总仓位
- **波动率控制**：高波动率降低仓位
- **系统性风险**：全行业衰退时空仓

#### 5.1.2 行业级别风控
- **行业分散**：不超过3个行业
- **行业仓位**：单个行业不超过30%
- **行业轮动**：定期调整行业配置

#### 5.1.3 个股级别风控
- **止损设置**：严格止损（-8%至-15%）
- **仓位控制**：单只股票不超过10%
- **止盈设置**：分批止盈

#### 5.1.4 组合级别风控
- **最大回撤控制**：整体回撤不超过20%
- **夏普比率监控**：确保风险收益比合理
- **流动性管理**：确保有足够的流动性

### 5.2 黑天鹅预警

- **异常值检测**：检测极端值
- **事件驱动**：识别重大事件影响
- **紧急停损**：异常情况下自动减仓

---

## 六、实施计划

### 6.1 第一阶段：基础框架（1-2周）
- [ ] 搭建数据层
- [ ] 实现数据清洗和特征工程
- [ ] 建立数据存储

### 6.2 第二阶段：模型开发（3-4周）
- [ ] 实现宏观模型
- [ ] 实现趋势模型
- [ ] 实现概念分析
- [ ] 实现选股模型
- [ ] 实现买卖模型

### 6.3 第三阶段：集成测试（1-2周）
- [ ] 模块集成
- [ ] 端到端测试
- [ ] 性能优化

### 6.4 第四阶段：回测验证（2-3周）
- [ ] 历史回测
- [ ] 参数优化
- [ ] 风险评估

### 6.5 第五阶段：上线运行（持续）
- [ ] 实盘运行
- [ ] 持续监控
- [ ] 不断优化

---

## 七、技术栈

### 7.1 编程语言
- **Python 3.10+**：主要开发语言

### 7.2 数据库
- **Parquet**：数据存储格式
- **SQLite/PostgreSQL**：元数据存储

### 7.3 数据处理
- **Pandas**：数据处理
- **NumPy**：数值计算
- **Scikit-learn**：机器学习

### 7.4 数据可视化
- **Matplotlib**：图表绘制
- **Plotly**：交互式图表

### 7.5 数据来源
- **Tushare Pro**：主要数据源
- **国家统计局**：宏观数据
- **东方财富**：概念数据（可选）

---

## 八、总结

本系统通过"宏观定方向，趋势择时，结构选股，交易执行"的完整流程，实现对股市结构性行情的精准捕捉。系统具有以下特点：

1. **多层次**：从宏观到微观，从行业到个股
2. **多维度**：基本面、技术面、资金面、情绪面
3. **智能化**：结合规则模型和机器学习
4. **可扩展**：模块化设计，易于扩展
5. **风险可控**：多层次风控机制

通过本系统，投资者可以在复杂的市场环境中，更准确地识别投资机会，降低投资风险，提高投资收益。
