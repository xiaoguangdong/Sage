# Sage 股票智能交易平台 — 使用手册

## 1. 环境配置

### 1.1 Python 环境

```bash
# 推荐 Python 3.10+
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

核心依赖：pandas, numpy, pyarrow, tushare, lightgbm, scikit-learn, pyyaml, requests

### 1.2 Tushare Token 配置

```bash
# 复制模板
cp .env.example .env

# 编辑 .env，填入你的 Tushare token
TUSHARE_TOKEN=your_token_here
```

Token 获取：注册 [Tushare](https://tushare.pro/) 账号，在个人中心获取 API Token。部分接口需要 2000+ 积分。

### 1.3 数据目录

默认数据目录配置在 `config/base.yaml`：

```yaml
data:
  root: data/                              # 主数据目录
  backup: /Volumes/SPEED/BizData/Stock/Sage/data  # 备份目录（可选）
```

首次运行前确保 `data/` 目录存在。

---

## 2. 数据下载

### 2.1 下载器入口

统一入口脚本：`scripts/data/tushare_downloader.py`

```bash
# 下载指定任务
python scripts/data/tushare_downloader.py --task daily_kline --start-date 20200101 --end-date 20241231

# 启用断点续传
python scripts/data/tushare_downloader.py --task daily_kline --start-date 20200101 --end-date 20241231 --resume
```

主要参数：
- `--task`：任务名称（对应 `config/tushare_tasks.yaml` 中的任务 key）
- `--start-date`：开始日期（YYYYMMDD）
- `--end-date`：结束日期（YYYYMMDD）
- `--resume`：启用断点续传，跳过已下载的数据

### 2.2 任务配置

所有下载任务定义在 `config/tushare_tasks.yaml`，共 65+ 个任务，按类别分组：

| 类别 | 任务示例 | 说明 |
|---|---|---|
| 行情数据 | `daily_kline`, `daily_basic` | 日线 K 线、每日基本面 |
| 指数数据 | `ths_index`, `ths_daily`, `sw_industry_daily` | 同花顺/申万指数 |
| 成分数据 | `hs300_constituents`, `sw_index_member` | 沪深300/申万成分 |
| 资金数据 | `moneyflow`, `northbound_flow`, `northbound_hold` | 资金流向、北向资金 |
| 财务数据 | `income`, `balancesheet`, `fina_indicator`, `fina_mainbz_vip` | 三大报表、财务指标 |
| 宏观数据 | `cn_cpi`, `cn_ppi`, `cn_pmi` | CPI/PPI/PMI |

### 2.3 断点续传与状态文件

每个任务有独立的状态文件（位于 `data/states/` 目录），记录已下载的时间窗口。启用 `--resume` 后，下载器会跳过已完成的窗口。

如果下载中断，直接重新运行相同命令加 `--resume` 即可继续。

### 2.4 批量下载脚本

统一批量下载入口：`scripts/data/download_missing_data.sh`

```bash
# 下载全部任务（30个，按依赖顺序串行执行）
nohup bash scripts/data/download_missing_data.sh > logs/data/download_all.log 2>&1 &

# 只下载指定任务
bash scripts/data/download_missing_data.sh ths_daily ths_member ths_index

# 指定日期范围 + 指定任务
bash scripts/data/download_missing_data.sh --start 20200101 --end 20241231 daily_kline daily_basic

# 查看所有可用任务
bash scripts/data/download_missing_data.sh --list

# 调整请求间隔（默认40秒）
bash scripts/data/download_missing_data.sh --sleep 60 fina_mainbz_vip
```

特性：
- 覆盖 `tushare_tasks.yaml` 全部 30 个任务
- 按依赖顺序执行（元数据 → list任务 → 日期范围任务）
- `--resume` 断点续传，已完成的任务自动跳过
- 单个任务失败不中断，继续下一个
- 每个任务独立日志文件（`logs/data/`）
- 结束时汇总成功/失败数

注意：避免同时启动多个下载进程，会导致 Tushare API 限流和数据文件冲突。

### 2.5 常见问题

**IP 限流**：Tushare 对免费用户有频率限制（约 200 次/分钟）。下载器内置 `sleep_seconds=60` 的限速配置，一般不会触发。如果遇到 429 错误，增大 `config/base.yaml` 中的 `sleep_seconds`。

**积分不足**：部分接口（如 `fina_indicator_vip`、`fina_mainbz_vip`）需要 2000+ 积分。检查 Tushare 个人中心的积分余额。

**数据缺失**：某些股票在特定日期可能无数据（停牌、退市等），这是正常现象，不影响回测。

---

## 3. 历史数据补充

### 3.1 数据完整性检查

检查核心数据文件是否齐全：

```bash
# 检查日线数据（按年份存储）
ls data/tushare/daily/daily_*.parquet

# 检查财务数据
ls data/tushare/fundamental/fina_indicator_*.parquet

# 检查指数数据
ls data/tushare/index/index_000300_SH_ohlc.parquet
```

### 3.2 补充下载

如果发现某些年份/季度数据缺失，指定对应的日期范围重新下载：

```bash
# 补充 2016-2019 年财务指标
python scripts/data/tushare_downloader.py --task fina_indicator_vip --start-date 20160101 --end-date 20191231 --resume

# 补充北向资金数据
python scripts/data/tushare_downloader.py --task northbound_flow --start-date 20160101 --end-date 20201231 --resume
```

### 3.3 宏观数据检查

```bash
# 运行宏观数据巡检
bash scripts/macro/check_macro_data.sh
```

---

## 4. 回测运行

### 4.1 Champion/Challenger 回测

```bash
python scripts/backtest/backtest_champion_challenger.py \
    --start-date 20230601 \
    --end-date 20241231 \
    --top-n 10 \
    --strategies regime,champion
```

参数说明：
- `--start-date` / `--end-date`：回测区间
- `--top-n`：选股数量（默认 10）
- `--strategies`：策略列表，可选 `regime`, `champion`, `balance`, `positive`, `value`, `satellite`
- `--cost-rate`：交易成本率（默认 0.003）
- `--initial-capital`：初始资金（默认 100 万）

结果输出到 `data/backtest/champion_challenger/`。

### 4.2 增强风控回测

```bash
python scripts/backtest/test_enhanced_risk_integration.py
```

该脚本对比有/无增强风控的策略表现，包括 ATR 止损、分档降仓等机制。

### 4.3 风控参数调优

关键参数在 `RiskControlConfig` 中：

| 参数 | 默认值 | 说明 |
|---|---|---|
| `atr_stop_multiplier` | 2.0 | ATR 止损倍数，越大越宽松 |
| `drawdown_reduce_threshold` | 0.15 | 回撤降仓阈值 |
| `drawdown_clear_threshold` | 0.25 | 回撤清仓阈值 |
| `max_single_weight` | 0.30 | 单股最大权重 |
| `max_industry_weight` | 0.40 | 单行业最大权重 |

---

## 5. 周流程运行

```bash
python sage_app/pipelines/run_weekly.py
```

执行顺序：
1. 加载行情数据
2. 趋势判定（沪深300 MA 状态）
3. 短周期策略竞争（Champion/Challenger）
4. 波段策略调仓检查
5. 统一信号契约生成
6. 行业叠加
7. 多策略组合构建（70% 波段 + 30% 短周期）
8. 仓位与风控
9. 输出组合建议

产出文件：
- `data/portfolio/portfolio_YYYYMMDD.csv` — 目标持仓与权重
- `data/portfolio/execution_context_YYYYMMDD.json` — 决策上下文

---

## 6. 常见问题与排错

**Q: 回测报错 "signals 缺少字段"**
A: 检查信号 DataFrame 是否包含 `trade_date` 和 `ts_code` 列。

**Q: 回测结果全是 0 收益**
A: 检查 returns DataFrame 的 `ret` 列是否有有效数据，以及信号日期是否在 returns 的日期范围内。

**Q: LightGBM 训练报错**
A: 确认 `lightgbm` 已正确安装。macOS 上可能需要 `brew install libomp`。

**Q: Tushare 返回空数据**
A: 检查 token 是否有效、积分是否充足、日期范围是否合理。部分接口在非交易日无数据。

**Q: 内存不足**
A: 全量回测（2016-2026）需要较大内存。建议分段回测，或增加系统 swap。
