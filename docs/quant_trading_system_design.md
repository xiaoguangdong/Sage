# é‡åŒ–äº¤æ˜“ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

**åŸºäºChatGPTé‡åŒ–äº¤æ˜“é—®ç­”çš„Aè‚¡å®ç›˜çº§æ ‘æ¨¡å‹æ–¹æ¡ˆ**

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡åŸåˆ™](#ä¸€è®¾è®¡åŸåˆ™)
2. [ç³»ç»Ÿæ¶æ„](#äºŒç³»ç»Ÿæ¶æ„)
3. [æ¨¡å‹åˆ†å·¥](#ä¸‰æ¨¡å‹åˆ†å·¥)
4. [è¶‹åŠ¿çŠ¶æ€æ¨¡å‹](#å››è¶‹åŠ¿çŠ¶æ€æ¨¡å‹)
5. [é€‰è‚¡æ’åºæ¨¡å‹](#äº”é€‰è‚¡æ’åºæ¨¡å‹)
6. [ä¹°å–ç‚¹è¿‡æ»¤æ¨¡å‹](#å…­ä¹°å–ç‚¹è¿‡æ»¤æ¨¡å‹)
7. [ç»„åˆæ„å»ºä¸é£æ§](#ä¸ƒç»„åˆæ„å»ºä¸é£æ§)
8. [æ•°æ®æµç¨‹](#å…«æ•°æ®æµç¨‹)
9. [é˜²è¿‡æ‹Ÿåˆæœºåˆ¶](#ä¹é˜²è¿‡æ‹Ÿåˆæœºåˆ¶)
10. [å®æ–½è·¯çº¿å›¾](#åå®æ–½è·¯çº¿å›¾)

---

## ä¸€ã€è®¾è®¡åŸåˆ™

### 1.1 æ ¸å¿ƒç†å¿µ

> **"å®ç›˜é‡åŒ–ä¸æ˜¯é¢„æµ‹å‡†ï¼Œè€Œæ˜¯åœ¨ä¸ç¡®å®šä¸­æŒç»­æš´éœ²åœ¨ä¸€ä¸ªæœ‰æ­£æœŸæœ›çš„ç»“æ„ä¸Šã€‚"**

### 1.2 å››å¤§é“å¾‹

- **æ¨¡å‹è¶Šç®€å•è¶Šå¥½** - èƒ½çº¿æ€§ç»ä¸ç”¨éçº¿æ€§ï¼Œèƒ½è§„åˆ™ç»ä¸ç”¨å­¦ä¹ 
- **æ¨¡å‹åªè´Ÿè´£æ’åº/çŠ¶æ€/ç½®ä¿¡åº¦ï¼Œä¸è´Ÿè´£ç¡®å®šä¹°å–ç‚¹**
- **å›æµ‹æ˜¯ç”¨æ¥æ‰¾æ­»å› çš„ï¼Œä¸èƒ½ç”¨æ¥è¯æ˜æ¨¡å‹**
- **ä¸€ä¸ªæ¨¡å‹åªèƒ½èµšä¸€ç§é’±**

### 1.3 Aè‚¡ç‰¹æ®Šæ€§

- Aè‚¡ä¸æ˜¯è¶‹åŠ¿å¸‚åœºï¼Œè€Œæ˜¯"æ”¿ç­–+æµåŠ¨æ€§+æƒ…ç»ª+ç»“æ„è½®åŠ¨"å¸‚åœº
- é¢„æµ‹è¶Š"å‡†"è¶Šå±é™©
- ä¸éœ€è¦"é¢„æµ‹é£æ ¼"ï¼Œä½†å¿…é¡»"æ„ŸçŸ¥é£æ ¼æ˜¯å¦åœ¨åˆ‡æ¢"

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
å¸‚åœºæ•°æ®å±‚ï¼ˆBaostock + Tushareï¼‰
    â†“
è¶‹åŠ¿çŠ¶æ€æ¨¡å‹ï¼ˆåˆ¤æ–­ï¼šæ˜¯å¦å¼€ä»“ï¼‰
    â†“
è‚¡ç¥¨æ’åºæ¨¡å‹ï¼ˆå†³å®šï¼šä¹°è°ï¼‰
    â†“
ä¹°å–ç‚¹è¿‡æ»¤æ¨¡å‹ï¼ˆå†³å®šï¼šä½•æ—¶è¿›å‡ºï¼‰
    â†“
ç»„åˆæ„å»ºä¸é£æ§ï¼ˆæ‰§è¡Œï¼šä¹°å¤šå°‘ï¼‰
    â†“
å®ç›˜æ‰§è¡Œ
```

### 2.2 ç›®å½•ç»“æ„ï¼ˆå·²å®ç°ï¼‰

```
Sage/
â”œâ”€â”€ sage_core/                # æ ¸å¿ƒç®—æ³•åº“ï¼ˆæ¨¡å‹/ç‰¹å¾/å›æµ‹/ç»„åˆï¼‰
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ backtest/
â”‚   â”œâ”€â”€ portfolio/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ sage_app/                 # éæ ¸å¿ƒç®¡çº¿ï¼ˆæ•°æ®æ¥å…¥/è°ƒåº¦/å…¥å£ï¼‰
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ data/
â”‚   â””â”€â”€ pipelines/
â”œâ”€â”€ scripts/                  # åˆ†æ¨¡å—è„šæœ¬ï¼ˆdata/models/strategy/backtest/monitoring/legacyï¼‰
â”œâ”€â”€ data/                     # æ•°æ®åŒºï¼ˆåŸå§‹/å¤„ç†/ç‰¹å¾/ä¿¡å·ï¼‰
â”œâ”€â”€ docs/                     # æ–‡æ¡£
â”œâ”€â”€ checkpoints/              # æ¨¡å‹ä¿å­˜
â””â”€â”€ logs/                     # æ—¥å¿—
```

---

## ä¸‰ã€æ¨¡å‹åˆ†å·¥

### 3.1 ä¸‰ç§é¢„æµ‹ä»»åŠ¡çš„å»ºæ¨¡æ–¹å¼

| ä»»åŠ¡ | æœ¬è´¨é—®é¢˜ | å»ºæ¨¡æ–¹å¼ | ä¸å¹²ä»€ä¹ˆ |
|------|---------|---------|---------|
| **è¶‹åŠ¿é¢„æµ‹** | çŠ¶æ€è¯†åˆ« | è§„åˆ™ï¼ˆMAåˆ¤æ–­ï¼‰æˆ–HMM | é¢„æµ‹æŒ‡æ•°ç‚¹ä½ |
| **é€‰è‚¡æ’åº** | æ¨ªæˆªé¢å¯¹æ¯” | LightGBM Ranking | é¢„æµ‹æ”¶ç›Šç‡æ•°å€¼ |
| **ä¹°å–ç‚¹è¿‡æ»¤** | ç½®ä¿¡åº¦åˆ†ç±» | Logistic Regression + è§„åˆ™ | è¾“å‡ºç²¾ç¡®ä¹°å–ç‚¹ |

### 3.2 æ¨¡å‹ååŒé€»è¾‘

```python
# ä¼ªä»£ç 
state = trend_model()  # è¾“å‡ºï¼š'RISK_ON' / 'éœ‡è¡' / 'RISK_OFF'

if state == 'RISK_OFF':
    return empty_portfolio()

# è‚¡ç¥¨æ’åº
all_stocks = rank_model()  # è¾“å‡ºï¼š{è‚¡ç¥¨: score}
top_stocks = all_stocks.head(20)  # Top 20

# ä¹°å–ç‚¹è¿‡æ»¤
filtered_stocks = []
for stock in top_stocks:
    prob = entry_model(stock)  # è¾“å‡ºï¼šæ¦‚ç‡
    if prob > 0.6 and check_rules(stock):  # è§„åˆ™è¿‡æ»¤
        filtered_stocks.append(stock)

# ç»„åˆæ„å»º
if len(filtered_stocks) > 0:
    portfolio = equal_weight(filtered_stocks)  # ç­‰æƒ
else:
    portfolio = empty_portfolio()
```

---

## å››ã€è¶‹åŠ¿çŠ¶æ€æ¨¡å‹

### 4.1 æ ¸å¿ƒæ€æƒ³

**åŸºäºæ²ªæ·±300æŒ‡æ•°ï¼ˆ000300.SHï¼‰åˆ¤æ–­æ•´ä¸ªAè‚¡å¸‚åœºçš„è¶‹åŠ¿çŠ¶æ€**

**æ ¸å¿ƒé€»è¾‘**ï¼š
```
æ²ªæ·±300æŒ‡æ•°çŠ¶æ€ â†’ æ•´ä¸ªAè‚¡å¸‚åœºçŠ¶æ€

å¦‚æœæ²ªæ·±300å¤„äºRISK_ONçŠ¶æ€ï¼š
â†’ æ²ªæ·±300ä¸Šæ¶¨ã€æ³¢åŠ¨ç‡ä½ã€æµåŠ¨æ€§å¥½
â†’ æ•´ä¸ªAè‚¡å¸‚åœºå¤§æ¦‚ç‡ä¹Ÿæ˜¯RISK_ON
â†’ å¯ä»¥å…¨ä»“å‚ä¸

å¦‚æœæ²ªæ·±300å¤„äºRISK_OFFçŠ¶æ€ï¼š
â†’ æ²ªæ·±300ä¸‹è·Œã€æ³¢åŠ¨ç‡é«˜ã€æµåŠ¨æ€§å·®
â†’ æ•´ä¸ªAè‚¡å¸‚åœºå¤§æ¦‚ç‡ä¹Ÿæ˜¯RISK_OFF
â†’ åº”è¯¥ç©ºä»“é˜²å®ˆ
```

### 4.2 20ä¸ªç¡¬æ ¸æŒ‡æ ‡ï¼ˆå…¨éƒ¨åŸºäºæ²ªæ·±300æŒ‡æ•°ï¼‰

**åŸºç¡€æŒ‡æ ‡ï¼ˆ8ä¸ªï¼‰**ï¼š
```python
æ•°æ®æ¥æºï¼šæ²ªæ·±300æŒ‡æ•°ï¼ˆ000300.SHï¼‰
1. ret_4wï¼šæ²ªæ·±300 4å‘¨æ”¶ç›Š
2. ret_12wï¼šæ²ªæ·±300 12å‘¨æ”¶ç›Š
3. vol_4wï¼šæ²ªæ·±300 4å‘¨æ³¢åŠ¨ç‡
4. vol_12wï¼šæ²ªæ·±300 12å‘¨æ³¢åŠ¨ç‡
5. amt_chgï¼šæ²ªæ·±300 æˆäº¤é¢å˜åŒ–
6. ma_20ï¼šæ²ªæ·±300 20æ—¥å‡çº¿
7. ma_60ï¼šæ²ªæ·±300 60æ—¥å‡çº¿
8. ma_120ï¼šæ²ªæ·±300 120æ—¥å‡çº¿
```

**ç¡¬æ ¸æŒ‡æ ‡ï¼ˆ10ä¸ªï¼‰**ï¼š
```python
åŸºäºæ²ªæ·±300æŒ‡æ•°ï¼š
9. price_rank_20dï¼šæ²ªæ·±300 20æ—¥å†…ä»·æ ¼æ’å
10. price_rank_60dï¼šæ²ªæ·±300 60æ—¥å†…ä»·æ ¼æ’å
11. trend_strengthï¼šæ²ªæ·±300 è¶‹åŠ¿å¼ºåº¦
12. vol_ratioï¼šæ²ªæ·±300 æ³¢åŠ¨ç‡æ¯”ç‡
13. extreme_vol_countï¼šæ²ªæ·±300 æç«¯æ³¢åŠ¨æ¬¡æ•°
14. amt_trend_20dï¼šæ²ªæ·±300 æˆäº¤é¢è¶‹åŠ¿
15. price_volume_corrï¼šæ²ªæ·±300 é‡ä»·ç›¸å…³æ€§
16. max_dd_20dï¼šæ²ªæ·±300 20æ—¥æœ€å¤§å›æ’¤
17. drawdown_countï¼šæ²ªæ·±300 å›æ’¤é¢‘ç‡
18. atrï¼šæ²ªæ·±300 ATRï¼ˆçœŸå®æ³¢åŠ¨å¹…åº¦ï¼‰

åŸºäºå…¨å¸‚åœºæ•°æ®ï¼ˆ2ä¸ªï¼‰ï¼š
19. advance_decline_ratioï¼šå…¨å¸‚åœºæ¶¨è·Œå®¶æ•°æ¯”ç‡ï¼ˆæ–°æµªæ•°æ®ï¼‰
20. market_breadthï¼šå…¨å¸‚åœºå®½åº¦ï¼ˆæ–°æµªæ•°æ®ï¼‰
```

### 4.3 æ ‡ç­¾æ„é€ 

```python
def make_trend_label(df_index, window=20):
    """
    æ„é€ è¶‹åŠ¿çŠ¶æ€æ ‡ç­¾

    æ•°æ®æ¥æºï¼šæ²ªæ·±300æŒ‡æ•°ï¼ˆ000300.SHï¼‰

    å®šä¹‰ï¼š
    - RISK_ONï¼šæ²ªæ·±300å¤„äºä¸Šå‡è¶‹åŠ¿ä¸”æ³¢åŠ¨ç‡ä½
    - éœ‡è¡ï¼šæ²ªæ·±300æ¨ªç›˜æ•´ç†
    - RISK_OFFï¼šæ²ªæ·±300å¤„äºä¸‹é™è¶‹åŠ¿
    """
    df_index = get_index_data('000300.SH')

    ma_20 = df_index['close'].rolling(window=20).mean()
    ma_60 = df_index['close'].rolling(window=60).mean()
    ma_120 = df_index['close'].rolling(window=120).mean()
    vol_4w = df_index['close'].pct_change().rolling(window=4).std()
    vol_median = vol_4w.rolling(window=60).median()

    price = df_index['close'].iloc[-1]

    # åˆ¤æ–­æ¡ä»¶
    is_up_trend = (ma_20.iloc[-1] > ma_60.iloc[-1] and
                   ma_60.iloc[-1] > ma_120.iloc[-1] and
                   price > ma_120.iloc[-1])

    is_low_vol = (vol_4w.iloc[-1] < vol_median.iloc[-1])

    # æ„é€ æ ‡ç­¾
    if is_up_trend and is_low_vol:
        label = 2  # RISK_ON
    elif is_up_trend and not is_low_vol:
        label = 1  # éœ‡è¡ï¼ˆä¸Šè¡Œé«˜æ³¢ï¼‰
    elif not is_up_trend and price > ma_60.iloc[-1]:
        label = 1  # éœ‡è¡ï¼ˆæ¨ªç›˜ï¼‰
    else:
        label = 0  # RISK_OFF

    return label
```

### 4.4 æ¨¡å‹é€‰æ‹©

**Phase 1ï¼ˆæœ€å°å¯è¡Œç³»ç»Ÿï¼‰**ï¼š
- ä½¿ç”¨è§„åˆ™æ–¹æ¡ˆï¼ˆMAåˆ¤æ–­ï¼‰
- ç®€å•ã€ç¨³å®šã€å¯è§£é‡Š
- ä¸éœ€è¦é¢å¤–æ•°æ®

**Phase 2ï¼ˆä¼˜åŒ–è¿­ä»£ï¼‰**ï¼š
- å¦‚æœè§„åˆ™æ–¹æ¡ˆæ•ˆæœå¥½ï¼Œå°è¯•LightGBM
- ä½¿ç”¨20ä¸ªç‰¹å¾è®­ç»ƒ

**Phase 3ï¼ˆè¿›é˜¶ï¼‰**ï¼š
- å°è¯•HMMï¼ˆ3ä¸ªçŠ¶æ€ï¼‰

### 4.5 é…ç½®å¼€å…³

```python
# config/trend_model.yaml
trend_model:
  # æ˜¯å¦å¯ç”¨è¶‹åŠ¿æ¨¡å‹
  enabled: true
  
  # æ¨¡å‹ç±»å‹ï¼šruleï¼ˆè§„åˆ™ï¼‰ / lgbmï¼ˆLightGBMï¼‰ / hmmï¼ˆHMMï¼‰
  model_type: rule
  
  # æ˜¯å¦ä½¿ç”¨20ä¸ªç‰¹å¾ï¼ˆruleæ¨¡å¼ä¸‹ä¸ºfalseï¼‰
  use_all_features: false
  
  # æ•°æ®æºé…ç½®
  data_sources:
    index: "000300.SH"  # æ²ªæ·±300æŒ‡æ•°
    market_breadth: "sina"  # æ–°æµªAPIï¼ˆéœ€ç”³è¯·keyï¼‰
    tushare: true  # æ˜¯å¦å¯ç”¨Tushare
    tushare_token: "2bcc0e9feb650d9862330a9743e5cc2e6469433c4d1ea0ce2d79371e"
```

---

## äº”ã€é€‰è‚¡æ’åºæ¨¡å‹

### 5.1 æ ¸å¿ƒæ€æƒ³

**åœ¨åŒä¸€æ—¶åˆ»ï¼Œåˆ¤æ–­è‚¡ç¥¨ä¹‹é—´"è°æ›´å¥½"ï¼Œè¾“å‡ºæ’åºscore**

### 5.2 æ ‡ç­¾è®¾è®¡

```python
def make_rank_label(df, horizon=4):
    """
    æ„é€ æ’åºæ ‡ç­¾
    
    æ ‡ç­¾ï¼šæœªæ¥4å‘¨æ”¶ç›Šçš„æ’å
    """
    future_ret = df.groupby("stock")["close"].pct_change(horizon).shift(-horizon)
    return future_ret.groupby(df["date"]).rank(pct=True)
```

**å…³é”®**ï¼šæ°¸è¿œrankï¼Œä¸å›å½’æ•°å€¼

### 5.3 20ä¸ªå› å­

**åŠ¨é‡ç±»ï¼ˆ8ä¸ªï¼‰**ï¼š
```python
1. mom_4wï¼š4å‘¨åŠ¨é‡
2. mom_12wï¼š12å‘¨åŠ¨é‡
3. mom_20wï¼š20å‘¨åŠ¨é‡
4. rs_4wï¼šç›¸å¯¹å¼ºåº¦vsæŒ‡æ•°ï¼ˆ4å‘¨ï¼‰
5. rs_12wï¼šç›¸å¯¹å¼ºåº¦vsæŒ‡æ•°ï¼ˆ12å‘¨ï¼‰
6. rs_20wï¼šç›¸å¯¹å¼ºåº¦vsæŒ‡æ•°ï¼ˆ20å‘¨ï¼‰
7. mom_accelerationï¼šåŠ¨é‡åŠ é€Ÿåº¦
8. relative_strengthï¼šç›¸å¯¹å¼ºåº¦
```

**æµåŠ¨æ€§ç±»ï¼ˆ6ä¸ªï¼‰**ï¼š
```python
9. turnover_4wï¼š4å‘¨å¹³å‡æ¢æ‰‹ç‡
10. turnover_12wï¼š12å‘¨å¹³å‡æ¢æ‰‹ç‡
11. amt_chg_4wï¼š4å‘¨æˆäº¤é¢å˜åŒ–
12. amt_chg_12wï¼š12å‘¨æˆäº¤é¢å˜åŒ–
13. volume_trendï¼šæˆäº¤é‡è¶‹åŠ¿
14. liquidity_ratioï¼šæµåŠ¨æ€§æ¯”ç‡
```

**ç¨³å®šæ€§ç±»ï¼ˆ4ä¸ªï¼‰**ï¼š
```python
15. vol_4wï¼š4å‘¨æ³¢åŠ¨ç‡
16. vol_12wï¼š12å‘¨æ³¢åŠ¨ç‡
17. max_dd_4wï¼š4å‘¨æœ€å¤§å›æ’¤
18. price_stabilityï¼šä»·æ ¼ç¨³å®šæ€§
```

**æŠ€æœ¯æŒ‡æ ‡ï¼ˆ2ä¸ªï¼‰**ï¼š
```python
19. ma_slopeï¼šå‡çº¿æ–œç‡
20. rsiï¼šRSIï¼ˆ14æ—¥ï¼‰
```

### 5.4 æ¨¡å‹å‚æ•°

```python
import lightgbm as lgb

model = lgb.LGBMRanker(
    objective='lambdarank',
    num_leaves=16,
    max_depth=4,
    learning_rate=0.05,
    n_estimators=200,
    subsample=0.8,
    colsample_bytree=0.8,
    reg_alpha=1.0,
    reg_lambda=1.0
)
```

### 5.5 Walk-forwardè®­ç»ƒ

```python
def walk_forward_train(df, model, train_weeks=130):
    """
    Walk-forwardè®­ç»ƒ
    
    å‚æ•°ï¼š
    - train_weeks: 130å‘¨ï¼ˆçº¦2.5å¹´ï¼‰
    - æµ‹è¯•çª—å£ï¼š26å‘¨ï¼ˆçº¦åŠå¹´ï¼‰
    - æ»šåŠ¨æ­¥é•¿ï¼šæ¯åŠå¹´ä¸€æ¬¡
    """
    for current_date in weekly_dates:
        train_data = df[df["date"] < current_date].tail(train_weeks * 5)
        test_data = df[df["date"] == current_date]

        model.fit(
            train_data[features],
            train_data["label"],
            group=train_data.groupby("date").size().values
        )

        yield current_date, model.predict(test_data[features])
```

### 5.6 é…ç½®å¼€å…³

```python
# config/rank_model.yaml
rank_model:
  # æ˜¯å¦å¯ç”¨ICåŠ¨æ€æƒé‡
  enable_ic_weight: false
  
  # ICçª—å£å¤§å°
  ic_window: 20
  
  # ICæƒé‡å¹³æ»‘
  ic_smooth: false
```

---

## å…­ã€ä¹°å–ç‚¹è¿‡æ»¤æ¨¡å‹

### 6.1 æ ¸å¿ƒæ€æƒ³

**ä¸æ˜¯é¢„æµ‹"ç²¾ç¡®ä¹°å–ç‚¹"ï¼Œè€Œæ˜¯è¯†åˆ«"å®‰å…¨çš„å…¥åœºçª—å£"**

### 6.2 æ ‡ç­¾è®¾è®¡

```python
def entry_label(df):
    """
    æ„é€ ä¹°å–ç‚¹æ ‡ç­¾
    
    æ ‡ç­¾ï¼šæ˜¯å¦å­˜åœ¨å®‰å…¨çš„æ­£æœŸæœ›çª—å£
    """
    future_max = df["close"].rolling(4).max().shift(-4)
    future_dd = (df["close"] / future_max - 1).rolling(4).min()

    return ((future_max / df["close"] - 1 > 0.05) & (future_dd > -0.03)).astype(int)
```

### 6.3 20ä¸ªç‰¹å¾

**è‚¡ç¥¨ç›¸å¯¹å†å²ä½ç½®ï¼ˆ4ä¸ªï¼‰**ï¼š
```python
1. price_percentile_60dï¼šç›¸å¯¹60æ—¥æœ€ä½ç‚¹çš„ä½ç½®
2. price_percentile_120dï¼šç›¸å¯¹120æ—¥ä½ç½®çš„ç™¾åˆ†ä½
3. price_vs_ma20ï¼šç›¸å¯¹20æ—¥å‡çº¿
4. price_vs_ma60ï¼šç›¸å¯¹60æ—¥å‡çº¿
```

**äº¤æ˜“é‡åˆ†æï¼ˆ4ä¸ªï¼‰**ï¼š
```python
5. volume_bottom_surgeï¼šåº•éƒ¨æ”¾é‡
6. volume_top_shrinkï¼šé«˜ä½ç¼©é‡
7. volume_trend_5dï¼š5æ—¥æˆäº¤é‡è¶‹åŠ¿
8. volume_trend_10dï¼š10æ—¥æˆäº¤é‡è¶‹åŠ¿
```

**MACDå½¢æ€ï¼ˆ4ä¸ªï¼‰**ï¼š
```python
9. macd_golden_crossï¼šMACDé‡‘å‰
10. macd_death_crossï¼šMACDæ­»å‰
11. macd_histogramï¼šMACDæŸ±çŠ¶å›¾
12. macd_signal_lineï¼šMACDä¿¡å·çº¿
```

**å½¢æ€å­¦åˆ†æï¼ˆ4ä¸ªï¼‰**ï¼š
```python
13. is_consolidationï¼šæ˜¯å¦æ¨ªç›˜æ•´ç†
14. is_breakoutï¼šæ˜¯å¦çªç ´
15. is_pullbackï¼šæ˜¯å¦å›è°ƒ
16. support_levelï¼šæ”¯æ’‘ä½å¼ºåº¦
```

**å…¶ä»–æŠ€æœ¯æŒ‡æ ‡ï¼ˆ4ä¸ªï¼‰**ï¼š
```python
17. rsiï¼šç›¸å¯¹å¼ºå¼±æŒ‡æ•°ï¼ˆ14æ—¥ï¼‰
18. atrï¼šå¹³å‡çœŸå®æ³¢åŠ¨å¹…åº¦
19. volatility_20dï¼š20æ—¥æ³¢åŠ¨ç‡
20. is_near_limitï¼šæ˜¯å¦æ¥è¿‘æ¶¨åœ
```

### 6.4 æ¨¡å‹é€‰æ‹©

**Phase 1**ï¼šLogistic Regression
```python
from sklearn.linear_model import LogisticRegression

model = LogisticRegression(
    multi_class='binary',
    solver='lbfgs',
    C=0.5,
    max_iter=1000
)
```

**Phase 2**ï¼šLightGBMï¼ˆå¦‚æœæ•ˆæœå¥½ï¼‰
```python
model = lgb.LGBMClassifier(
    max_depth=3,
    num_leaves=8,
    learning_rate=0.05,
    n_estimators=200
)
```

### 6.5 è§¦å‘è§„åˆ™ï¼ˆæ–¹æ¡ˆBï¼‰

```python
if prob > 0.6  # æ¦‚ç‡é˜ˆå€¼ï¼ˆå¹³è¡¡å‹ï¼‰
AND price > ma_20  # ä»·æ ¼é«˜äº20æ—¥å‡çº¿
AND volatility < 0.05:  # æ³¢åŠ¨ç‡å°äº5%
    å…è®¸å¼€ä»“
```

### 6.6 é…ç½®å¼€å…³

```python
# config/entry_model.yaml
entry_model:
  # æ¨¡å‹ç±»å‹ï¼šlrï¼ˆLogistic Regressionï¼‰ / lgbmï¼ˆLightGBMï¼‰
  model_type: lr
  
  # è§¦å‘è§„åˆ™å‚æ•°
  rules:
    prob_threshold: 0.6  # æ¦‚ç‡é˜ˆå€¼
    ma_period: 20  # å‡çº¿å‘¨æœŸ
    vol_threshold: 0.05  # æ³¢åŠ¨ç‡é˜ˆå€¼
```

---

## ä¸ƒã€ç»„åˆæ„å»ºä¸é£æ§

### 7.1 ç»„åˆè§„åˆ™

```python
# é€‰Top Nåªè‚¡ç¥¨
top_n = 15

# ç­‰æƒç»„åˆ
portfolio = equal_weight(top_stocks)

# é£æ§å‚æ•°
single_stock_max_weight = 0.10  # å•è‚¡æœ€å¤§æƒé‡10%
industry_max_weight = 0.30  # å•è¡Œä¸šæœ€å¤§æƒé‡30%

# å‘¨é¢‘å†å¹³è¡¡
rebalance_freq = 'weekly'
```

### 7.2 é£æ§å‚æ•°

```python
# å•è‚¡è½¯æ­¢æŸ
stop_loss_threshold = -0.10  # -10%

# ç»„åˆæœ€å¤§å›æ’¤æ§åˆ¶
max_drawdown_threshold = 0.20  # 20%

# è¶‹åŠ¿æ¨¡å‹å¤±æ•ˆâ†’ç©ºä»“
trend_fallback_mode = 'empty_portfolio'
```

---

## å…«ã€æ•°æ®æµç¨‹

### 8.1 æ•°æ®æº

**ä¸»æ•°æ®æº**ï¼šBaostock
- å·²ä¸‹è½½ï¼š2020-2026å¹´ï¼Œ9868åªè‚¡ç¥¨
- å­—æ®µï¼šdate, code, open, high, low, close, volume, amountç­‰

**è¾…åŠ©æ•°æ®æº**ï¼šTushare
- Tokenï¼š2bcc0e9feb650d9862330a9743e5cc2e6469433c4d1ea0ce2d79371e
- ç”¨é€”ï¼šæŒ‡æ•°æ•°æ®ã€è´¢åŠ¡æ•°æ®ã€èµ„é‡‘æµå‘æ•°æ®

**å¸‚åœºå®½åº¦æ•°æ®**ï¼šæ–°æµªAPI
- éœ€è¦ç”³è¯·key
- ç”¨é€”ï¼šæ¶¨è·Œå®¶æ•°ã€æ¶¨åœå®¶æ•°

### 8.2 æ•°æ®æ¸…æ´—æ­¥éª¤

**æ­¥éª¤1**ï¼šæ£€æŸ¥ç¼ºå¤±å€¼
**æ­¥éª¤2**ï¼šæ£€æŸ¥å¼‚å¸¸å€¼
**æ­¥éª¤3**ï¼šæ£€æŸ¥ä¸€è‡´æ€§
**æ­¥éª¤4**ï¼šæ•°æ®ä¿®å¤ï¼ˆwinsorizeã€æ’å€¼ï¼‰

### 8.3 æ•°æ®éªŒè¯

**å¯¹æ¯”Baostockå’ŒTushareçš„æ•°æ®**ï¼š
- é‡ç‚¹å¯¹æ¯”ä»·æ ¼ã€æˆäº¤é‡ã€æŒ‡æ•°æ•°æ®
- å‘ç°ä¸ä¸€è‡´æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨Tushareæ•°æ®

---

## ä¹ã€é˜²è¿‡æ‹Ÿåˆæœºåˆ¶

### 9.1 é€šç”¨é“å¾‹

1. **æ•°æ®å…ˆäºæ¨¡å‹** - æ²¡æœ‰ç»“æ„æ€§æ•°æ®ä¼˜åŠ¿ï¼Œä¸è¦ç©å¤æ‚æ¨¡å‹
2. **æ¨¡å‹è¶Šç®€å•è¶Šå¥½** - èƒ½çº¿æ€§ç»ä¸ç”¨éçº¿æ€§ï¼Œèƒ½è§„åˆ™ç»ä¸ç”¨å­¦ä¹ 
3. **å›æµ‹æ˜¯ç”¨æ¥æ‰¾æ­»å› çš„** - çœ‹æœ€å¤§å›æ’¤ã€å¤±æ•ˆæœŸã€å‚æ•°ç¨³å®šæ€§
4. **ä¸€ä¸ªæ¨¡å‹åªèƒ½èµšä¸€ç§é’±** - åŠ¨é‡ã€å‡å€¼å›å½’ã€é£é™©æº¢ä»·ä¸è¦æ··

### 9.2 å…·ä½“æªæ–½

**æ¨¡å‹å±‚é¢**ï¼š
- è¶‹åŠ¿æ¨¡å‹ï¼šè§„åˆ™ä¼˜å…ˆï¼Œç®€å•ç¨³å®š
- æ’åºæ¨¡å‹ï¼šmax_depthâ‰¤4, num_leavesâ‰¤16
- ä¹°å–ç‚¹æ¨¡å‹ï¼šLogistic Regressionä¼˜å…ˆ

**æ•°æ®å±‚é¢**ï¼š
- ä¸¥ç¦å…¨æ ·æœ¬fit
- å¿…é¡»æ—¶é—´åˆ‡åˆ†ï¼ˆWalk-forwardï¼‰
- 2.5å¹´è®­ç»ƒï¼ŒåŠå¹´æµ‹è¯•ï¼Œæ¯åŠå¹´æ»šåŠ¨

**ç‰¹å¾å±‚é¢**ï¼š
- æ’åºæ¨¡å‹ï¼šâ‰¤20ä¸ªå› å­
- ä¹°å–ç‚¹æ¨¡å‹ï¼šâ‰¤20ä¸ªç‰¹å¾
- è¶‹åŠ¿æ¨¡å‹ï¼šâ‰¤20ä¸ªç‰¹å¾

### 9.3 å®ç›˜è‡ªæ£€æ¸…å•

ä¸Šçº¿å‰å¿…é¡»èƒ½å›ç­”ï¼š
1. è¿™ä¸ªä¿¡å·èµšçš„æ˜¯ä»€ä¹ˆé’±ï¼Ÿ
2. å¦‚æœå¸‚åœºæ¨ªç›˜6ä¸ªæœˆï¼Œå®ƒä¼šæ€æ ·ï¼Ÿ
3. å‚æ•°æ”¹20%ï¼Œæ˜¯å¦è¿˜æ´»ç€ï¼Ÿ
4. åˆ é™¤30%ç‰¹å¾ï¼Œæ•ˆæœæ˜¯å¦è¿˜åœ¨ï¼Ÿ
5. è¿™ä¸ªæ¨¡å‹æ˜¯å¦ä¾èµ–æŸä¸€å°æ®µæ—¶é—´ï¼Ÿ
6. ç©ºä»“æœŸ>20%ï¼Ÿ
7. ä¸ä¾èµ–æŸä¸€åªè‚¡ç¥¨ï¼Ÿ

---

## åã€å®æ–½è·¯çº¿å›¾

### 10.1 Phase 0ï¼šæ•°æ®å‡†å¤‡ï¼ˆå½“å‰ï¼‰

**ç›®æ ‡**ï¼šæ•°æ®æ¸…æ´—å’ŒéªŒè¯

**ä»»åŠ¡**ï¼š
1. âœ… æ£€æŸ¥Baostockæ•°æ®ç¼ºå¤±å€¼
2. âœ… æ£€æŸ¥Baostockæ•°æ®å¼‚å¸¸å€¼
3. âœ… ä¸‹è½½Tushareçš„æŒ‡æ•°æ•°æ®ï¼ˆæ²ªæ·±300ã€ä¸­è¯500ï¼‰
4. âœ… å¯¹æ¯”Baostockå’ŒTushareçš„ä»·æ ¼æ•°æ®
5. âœ… ä¸‹è½½æ•°æ®æ¸…æ´—ä»£ç 
6. âœ… ä¸‹è½½æ•°æ®éªŒè¯ä»£ç 
7. âœ… ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š

### 10.2 Phase 1ï¼šæœ€å°å¯è¡Œç³»ç»Ÿï¼ˆä¸‹ä¸€æ­¥ï¼‰

**ç›®æ ‡**ï¼šå®ç°åŸºç¡€çš„æ ‘æ¨¡å‹ç³»ç»Ÿ

**å…³é”®æ–‡ä»¶**ï¼š
- `sage_core/stock_selection/rank_model.py` - æ’åºæ¨¡å‹
- `sage_core/features/` - ç‰¹å¾å·¥ç¨‹ï¼ˆç›®å½•ï¼‰
- `scripts/models/rank_trainer.py` - æ’åºæ¨¡å‹è®­ç»ƒï¼ˆå¾…å®ç°ï¼‰
- `sage_core/backtest/walk_forward.py` - å‘¨é¢‘æ»šåŠ¨å›æµ‹

**æ ¸å¿ƒå‚æ•°**ï¼š
- max_depth=4, num_leaves=16
- å­¦ä¹ ç‡ï¼š0.05
- æ­£åˆ™åŒ–ï¼šreg_alpha=1.0, reg_lambda=1.0

**è¯„ä¼°æŒ‡æ ‡**ï¼š
- Phase 1ï¼šICã€Rank IC

### 10.3 Phase 2ï¼šä¼˜åŒ–è¿­ä»£

**ç›®æ ‡**ï¼šå¦‚æœPhase 1æ•ˆæœå¥½ï¼Œè¿›è¡Œä¼˜åŒ–

**ä¼˜åŒ–å†…å®¹**ï¼š
1. è¶‹åŠ¿æ¨¡å‹ï¼šå°è¯•LightGBM
2. ICåŠ¨æ€æƒé‡ï¼šå¯ç”¨ICåŠ¨æ€æƒé‡
3. è¯„ä¼°æŒ‡æ ‡ï¼šICIRã€Top-Kå‘½ä¸­ç‡

### 10.4 Phase 3ï¼šå®Œæ•´ç³»ç»Ÿæ•´åˆ

**ç›®æ ‡**ï¼šä¸‰æ¨¡å‹ååŒï¼Œå®Œæ•´å›æµ‹

**å…³é”®æ–‡ä»¶**ï¼š
- `sage_core/strategy/entry_strategy.py` - å…¥åœºç­–ç•¥ï¼ˆå¾…å®ç°ï¼‰
- `sage_core/portfolio/portfolio_construction.py` - ç»„åˆæ„å»ºï¼ˆå¾…å®ç°ï¼‰
- `sage_core/portfolio/risk_control.py` - é£é™©æ§åˆ¶ï¼ˆå¾…å®ç°ï¼‰

**å›æµ‹å‘¨æœŸ**ï¼š
- 2020-2022è®­ç»ƒ â†’ 2023H1æµ‹è¯•
- 2020H2-2022H2è®­ç»ƒ â†’ 2023H2æµ‹è¯•
- æ¯åŠå¹´æ»šåŠ¨ä¸€æ¬¡

---

## åä¸€ã€æŠ€æœ¯æ ˆæ€»ç»“

### 11.1 æ ¸å¿ƒç³»ç»Ÿï¼ˆæ ‘æ¨¡å‹ï¼‰

- **æ¨¡å‹**ï¼šLightGBM Rankerï¼ˆmax_depthâ‰¤4, num_leavesâ‰¤16ï¼‰
- **è®­ç»ƒ**ï¼šsklearn + lightgbm
- **ç›®æ ‡**ï¼šå‘¨é¢‘ICç¨³å®šã€Top-Kå‘½ä¸­ç‡
- **ç‰¹å¾**ï¼šâ‰¤20ä¸ªAè‚¡ç‰¹å®šç‰¹å¾
- **æ•°æ®**ï¼š2020-2026å¹´Aè‚¡æ•°æ®

### 11.2 åºŸå¼ƒç³»ç»Ÿï¼ˆLSTMï¼‰

- **çŠ¶æ€**ï¼šå·²åºŸå¼ƒï¼Œä»…ä½œä¸ºç ”ç©¶åŸå‹
- **å‡†ç¡®ç‡**ï¼š49.86%ï¼ˆä¸‰åˆ†ç±»ï¼‰
- **ç»“è®º**ï¼šä¸é€‚åˆå®ç›˜

### 11.3 å…±ç”¨ç»„ä»¶

- **æ•°æ®å¤„ç†**ï¼šPandas, NumPy
- **æ—¥å¿—ç®¡ç†**ï¼šPython logging + TensorBoard
- **å›æµ‹å¼•æ“**ï¼šè‡ªå®šä¹‰æ»šåŠ¨å›æµ‹
- **é…ç½®ç®¡ç†**ï¼šYAML

---

## åäºŒã€å…³é”®æˆåŠŸæŒ‡æ ‡

### 12.1 æ¨¡å‹æ€§èƒ½ç›®æ ‡

- **æ’åºæ¨¡å‹**ï¼šIC > 0.08ï¼ŒRank IC > 0.05
- **ä¹°å–ç‚¹æ¨¡å‹**ï¼šé«˜ç½®ä¿¡åº¦åŒºé—´å‡†ç¡®ç‡ > 70%
- **ç»„åˆå±‚é¢**ï¼šå¹´åŒ–æ”¶ç›Š > 20%ï¼Œæœ€å¤§å›æ’¤ < 20%ï¼ŒSharpe > 1.5

### 12.2 ç¨³å®šæ€§æŒ‡æ ‡

- å‚æ•°ç¨³å®šæ€§ï¼šå‚æ•°æ”¹20%ä¸å´©
- ç‰¹å¾ç¨³å®šæ€§ï¼šåˆ é™¤30%ç‰¹å¾æ•ˆæœè¿˜åœ¨
- æ—¶é—´ç¨³å®šæ€§ï¼š3ä¸ªä¸åŒæ—¶é—´æ®µéƒ½èƒ½èµšé’±
- ç©ºä»“æœŸï¼š>20%

### 12.3 é£é™©æ§åˆ¶

- å•è‚¡è½¯æ­¢æŸï¼š-10%
- ç»„åˆæœ€å¤§å›æ’¤é™åˆ¶ï¼š20%
- è¶‹åŠ¿æ¨¡å‹å¤±æ•ˆâ†’ç©ºä»“
- è¡Œä¸šä¸­æ€§ã€æ¢æ‰‹ç‡é™åˆ¶

---

## åä¸‰ã€æ€»ç»“

### 13.1 æ ¸å¿ƒç†å¿µ

> **"åœ¨Aè‚¡é‡Œï¼Œä¸æ˜¯ä½ é¢„æµ‹å¾—æœ‰å¤šå‡†ï¼Œè€Œæ˜¯ä½ å¤šä¹…æ‰å…è®¸æ¨¡å‹ä¸‹æ³¨ä¸€æ¬¡ã€‚"**

### 13.2 å®ç›˜è€å…µç»éªŒ

> **"æ¨¡å‹ä¸æ˜¯ä¸ºäº†é¢„æµ‹æœªæ¥ï¼Œè€Œæ˜¯ä¸ºäº†é˜²æ­¢ä½ åœ¨ä¸è¯¥ä¸‹æ³¨çš„æ—¶å€™ä¸‹æ³¨ã€‚"**

### 13.3 å®ç›˜çº§æ¶æ„è¦ç‚¹

1. ä»»ä½•æ¨¡å‹éƒ½ä¸ç›´æ¥ä¸‹å•
2. æ—¶é—´é¡ºåºæ°¸è¿œå•å‘ï¼ˆç¦æ­¢å…¨æ ·æœ¬fitï¼‰
3. æ¯ä¸€å±‚éƒ½èƒ½å•ç‹¬å…³æ‰ï¼Œä¸å½±å“ç³»ç»Ÿç¨³å®šæ€§
4. æ‰€æœ‰MLéƒ½æ˜¯"å¼±æ¨¡å‹"
5. æ¨¡å‹=è¿‡æ»¤å™¨ï¼Œä¸æ˜¯æŒ‰é’®

### 13.4 æ•°æ®æ¥æº

- **ä¸»æ•°æ®æº**ï¼šBaostockï¼ˆ2020-2026ï¼Œ9868åªè‚¡ç¥¨ï¼‰
- **è¾…åŠ©æ•°æ®æº**ï¼šTushareï¼ˆæŒ‡æ•°æ•°æ®ã€è´¢åŠ¡æ•°æ®ï¼‰
- **å¸‚åœºå®½åº¦æ•°æ®**ï¼šæ–°æµªAPIï¼ˆæ¶¨è·Œå®¶æ•°ï¼‰

### 13.5 å…³é”®é…ç½®

- **è¶‹åŠ¿æ¨¡å‹**ï¼šè§„åˆ™æ–¹æ¡ˆï¼ˆMAåˆ¤æ–­ï¼‰ï¼ŒåŸºäºæ²ªæ·±300æŒ‡æ•°
- **æ’åºæ¨¡å‹**ï¼šLightGBM Rankerï¼Œ20ä¸ªå› å­
- **ä¹°å–ç‚¹æ¨¡å‹**ï¼šLogistic Regressionï¼Œ20ä¸ªç‰¹å¾ï¼Œprob>0.6
- **ç»„åˆæ„å»º**ï¼šç­‰æƒï¼ŒTop 15ï¼Œå•è‚¡10%ï¼Œè¡Œä¸š30%
- **å†å¹³è¡¡é¢‘ç‡**ï¼šå‘¨é¢‘
- **Walk-forward**ï¼š2.5å¹´è®­ç»ƒï¼ŒåŠå¹´æµ‹è¯•ï¼Œæ¯åŠå¹´æ»šåŠ¨

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2026-02-08  
**åŸºäºæ–‡æ¡£**ï¼šdocs/chatgpt_qa.md  
**é¡¹ç›®**ï¼šdeep_final_kp  
**è¯„å®¡æ–‡æ¡£**ï¼šdocs/quant_trading_system_design_review.md
