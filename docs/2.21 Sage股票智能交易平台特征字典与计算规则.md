# Sage股票智能交易平台特征字典与计算规则

> 目标：统一特征定义与计算规则，避免口径不一致与数据泄露。

---

## 1. 通用字段规范
| 统一字段 | 含义 | 备注 |
|---|---|---|
| `ts_code` | 股票代码 | 统一用 `ts_code` |
| `trade_date` | 交易日 | 日频 |
| `date` | 日期 | 宏观月度/季度 |
| `close` | 收盘价 | 复权口径需一致 |
| `amount` | 成交额 | 用于滑点/流动性 |

---

## 2. 选股排序特征（RankModelLGBM）
### 2.1 动量类
- `return_4d = close / close.shift(4) - 1`
- `return_12d = close / close.shift(12) - 1`
- `return_20d = close / close.shift(20) - 1`

### 2.2 均线比
- `ma_ratio_4d = close / MA_4`
- `ma_ratio_12d = close / MA_12`
- `ma_ratio_20d = close / MA_20`

### 2.3 流动性
- `turnover_4d_mean = mean(turnover, 4)`
- `turnover_4d_std = std(turnover, 4)`
- `turnover_ratio_4d = turnover / turnover_4d_mean`
- `turnover_12d_mean = mean(turnover, 12)`
- `turnover_12d_std = std(turnover, 12)`
- `turnover_ratio_12d = turnover / turnover_12d_mean`

### 2.4 稳定性
- `volatility_4d = std(pct_change(close), 4)`
- `volatility_12d = std(pct_change(close), 12)`
- `price_std_4d = std(close, 4)`
- `price_std_12d = std(close, 12)`

### 2.5 技术指标
- `rsi_14`：RSI(14)
- `macd = EMA12(close) - EMA26(close)`
- `macd_signal = EMA9(macd)`
- `bollinger_upper = MA20 + 2*STD20`
- `bollinger_lower = MA20 - 2*STD20`

---

## 3. 趋势模型特征（MarketFeatures / TrendModel）
- `ma_20/ma_60/ma_120 = rolling_mean(close)`
- `ret_4w/ret_12w = close / close.shift(4/12周) - 1`
- `vol_4w/vol_12w = std(pct_change(close), 4/12周)`
- `price_rank_20d/60d = rolling percentile of close`
- `trend_strength = (ma_20 - ma_60) / ma_60`
- `vol_ratio = vol_4w / vol_12w`
- `extreme_vol_count = count(|ret| > 2*vol_12w, window=20)`
- `amt_trend_20d = mean(amount,20)/mean(amount,60)`
- `price_volume_corr = corr(pct_change(close), pct_change(amount), window=4)`
- `max_dd_20d = (rolling_max(close,20) - close) / rolling_max(close,20)`
- `drawdown_count = count(close < rolling_max*0.95, window=20)`
- `atr = mean(TrueRange,14)`

---

## 4. 宏观与行业特征
### 4.1 宏观
- `pmi`：制造业PMI
- `pmi_turning_point`：PMI拐点（上升=1，下降=-1）
- `yield_10y / yield_2y`
- `yield_spread = yield_10y - yield_2y`
- `yield_spread_signal`：利差突破阈值（默认阈值=0.5）
- `credit_growth`：社融同比增速
- `cpi_yoy / ppi_yoy`

### 4.2 行业
- `ppi_industry_yoy`
- `fai_yoy`
- `output_yoy`（行业代理，来源于产品→行业映射）
- `output_product_*`（产品级产量特征，保留原始颗粒度）
- `rev_yoy`
- `pb_percentile`
- `revenue_acceleration = diff(diff(tr_yoy))`
- `gross_margin_change = diff(gross_margin)`
- `prosperity_signal = (revenue_acceleration > ε) & (gross_margin_change > 0)`

---

## 5. 资金与北向特征
**行业配置优先**：
- `northbound_industry_ratio`（行业配置比例）
- `northbound_industry_ratio_signal`（布林带突破）

**缺失退化**：
- `northbound_net_flow`（市场级净流入）

---

## 6. 行业动量特征
- `industry_ret_4w = industry_close / industry_close.shift(4w) - 1`
- `industry_ret_12w = industry_close / industry_close.shift(12w) - 1`

## 6.2 概念/板块热度特征（同花顺）
**数据源**：
- `ths_index` / `ths_daily`

**特征建议**：
- `concept_ret_4w`：板块指数4周收益
- `concept_ret_12w`：板块指数12周收益
- `concept_turnover_4w`：板块换手率均值
- `concept_heat_score`：综合活跃度评分（待实现）

## 6.1 政策行业特征（行业级）
**数据源**：
- 政府网站/公告文本（政策/产业）
- 东方财富行业研报（行业级）
- 申万行业指数日线（行业动量）

**政策文本规则特征**：
- `policy_score`：政策文本情绪/倾向评分（0~1）
- `doc_count`：政策/公告文本数
- `source_weights`：来源权重和

**行业研报特征**（东方财富）：
- `report_count_7d`：近7日研报数
- `report_count_30d`：近30日研报数
- `rating_change_30d`：近30日评级上调-下调
- `rating_change_score`：当日评级变化得分（上调=1、下调=-1）

**行业动量特征**（申万L1指数）：
- `mom_20d`：20日动量
- `mom_60d`：60日动量
- `vol_20d`：20日波动

**增强输出**：
- `policy_signals_enhanced.parquet`：融合政策+研报+动量的行业级增强信号

---

## 7. 标签定义（多周期）
```
future_return_h = close.shift(-h) / close - 1  # h in [20,60,120]
rank_label_h = future_return_h.rank(pct=True, group=industry)
```
**注意**：行业内rank；财报/公告/北向按T+2延迟。

---

## 8. 计算注意事项
- Rolling窗口需设置 `min_periods`
- 避免未来数据泄露
- 统一复权口径
- 工业品产量为产品级，行业级为“代理变量”，需注明映射口径
